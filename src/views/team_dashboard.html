<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard - WhatsApp Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #128c7e;
            --primary-dark: #075e54;
            --success: #25d366;
            --light-bg: #f0f2f5;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        body {
            background-color: var(--light-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .navbar {
            background-color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .navbar-brand {
            color: var(--primary) !important;
            font-weight: 600;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: none;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }

        .metric-label {
            color: #667781;
            font-size: 14px;
        }

        .time-toggle {
            background: white;
            border-radius: 24px;
            padding: 4px;
            display: inline-flex;
            box-shadow: var(--card-shadow);
        }

        .time-toggle .btn {
            border-radius: 20px;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 500;
            background: transparent;
            color: #667781;
        }

        .time-toggle .btn.active {
            background: var(--primary);
            color: white;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            height: 350px;        }

        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #667781;
            padding: 12px 24px;
            font-weight: 500;
            position: relative;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            background: transparent;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary);
        }

        .device-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            border: none;
            position: relative;
            transition: all 0.3s ease;
        }

        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .device-status {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .device-status.online {
            background-color: var(--success);
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }

        .device-status.offline {
            background-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }

        .btn-whatsapp {
            background-color: var(--success);
            color: white;
            border: none;
        }

        .btn-whatsapp:hover {
            background-color: #22c55e;
            color: white;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;        }

        .calendar-day:hover {
            background-color: #f8f9fa;
            border-color: var(--primary);
        }

        .calendar-day.has-campaign {
            background-color: #e3f4f1;
            border-color: var(--primary);
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .campaign-indicator {
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            margin: 2px;
            display: inline-block;
        }

        /* Campaign Calendar Styles - Matching Master Dashboard */
        #campaignCalendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            padding: 1px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #fafafa;
        }
        
        .calendar-day.has-campaign {
            background: #e3f2fd;
            border: 2px solid var(--primary);
        }
        
        .calendar-day.today {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .calendar-day.today.has-campaign {
            background: linear-gradient(135deg, #fff3cd 50%, #e3f2fd 50%);
            border: 2px solid var(--primary);
        }
        
        .calendar-date {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.2;
        }        
        .calendar-date span {
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }
        
        .campaign-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .campaign-list {
            font-size: 11px;
            line-height: 1.3;
            max-height: 80px;
            overflow-y: auto;
            margin-top: 4px;
        }
        
        .campaign-item {
            background: rgba(18, 140, 126, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        
        .campaign-item:hover {
            background: rgba(18, 140, 126, 0.2);
        }
        
        .sequence-card {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .sequence-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .sequence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .sequence-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        
        .sequence-stats {
            display: flex;
            gap: 24px;
            margin-top: 12px;
        }
        
        .sequence-stat {
            display: flex;
            flex-direction: column;
        }
        
        .sequence-stat-label {
            font-size: 12px;
            color: #667781;
            margin-bottom: 4px;
        }
        
        .sequence-stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        
        .sequence-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }
    </style>
</head>
<body>    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/team-dashboard">
                <i class="bi bi-whatsapp"></i> WhatsApp Analytics - Team View
            </a>
            <div class="d-flex align-items-center">
                <span class="me-3 text-muted" id="teamMemberName">Loading...</span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Navigation Bar -->
    <div class="navigation-bar bg-light py-2 px-3 border-bottom">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="window.location.href='/team-dashboard'">>
                    <i class="bi bi-house"></i> Home
                </button>
            </div>
            <div class="breadcrumb mb-0">
                <span class="text-muted">You are here: </span>
                <span id="currentPage">Dashboard</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button">
                    <i class="bi bi-phone"></i> Devices
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaign-tab" data-bs-toggle="tab" data-bs-target="#campaign" type="button">
                    <i class="bi bi-calendar3"></i> Campaign
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaign-summary-tab" data-bs-toggle="tab" data-bs-target="#campaign-summary" type="button">
                    <i class="bi bi-graph-up"></i> Campaign Summary
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sequences-tab" data-bs-toggle="tab" data-bs-target="#sequences" type="button">
                    <i class="bi bi-collection"></i> Sequences
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sequence-summary-tab" data-bs-toggle="tab" data-bs-target="#sequence-summary" type="button">
                    <i class="bi bi-bar-chart"></i> Sequence Summary
                </button>
            </li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">>
                <!-- Filters Section -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="mb-0">Analytics Dashboard</h5>
                        <small class="text-muted" id="currentDateTime">Loading...</small>
                    </div>
                    <div class="d-flex gap-3 align-items-center">
                        <!-- Device Filter -->
                        <div>
                            <label class="form-label mb-1 small">Filter by Device</label>
                            <select class="form-select form-select-sm" id="deviceFilter" onchange="updateDashboard()" style="width: 200px;">
                                <option value="all">All Devices</option>
                            </select>
                        </div>
                        
                        <!-- Date Range -->
                        <div>
                            <label class="form-label mb-1 small">Date Range</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control form-control-sm" id="startDate" onchange="updateDashboard()">
                                <input type="date" class="form-control form-control-sm" id="endDate" onchange="updateDashboard()">
                            </div>
                        </div>
                        
                        <!-- Niche Filter -->
                        <div>
                            <label class="form-label mb-1 small">Filter by Niche</label>
                            <select class="form-select form-select-sm" id="nicheFilter" onchange="updateDashboard()" style="width: 150px;">
                                <option value="all">All Niches</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Section 1: Analytics Device -->
                <div class="mb-5">
                    <h6 class="mb-3 fw-bold text-primary">
                        <i class="bi bi-phone-fill me-2"></i>Device Analytics
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-phone"></i>
                                </div>
                                <div class="metric-value" id="totalDevices">0</div>
                                <div class="metric-label">Total Devices</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-circle-fill"></i>
                                </div>
                                <div class="metric-value" id="totalActiveDevices">0</div>
                                <div class="metric-label">Total Active Devices</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-icon bg-danger bg-opacity-10 text-danger">
                                    <i class="bi bi-circle"></i>
                                </div>
                                <div class="metric-value" id="totalOfflineDevices">0</div>
                                <div class="metric-label">Total Offline Devices</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Section 2: Analytics Campaign -->
                <div class="mb-5">
                    <h6 class="mb-3 fw-bold text-success">
                        <i class="bi bi-megaphone-fill me-2"></i>Campaign Analytics
                    </h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-collection"></i>
                                </div>
                                <div class="metric-value" id="totalCampaigns">0</div>
                                <div class="metric-label">Total Campaigns</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="metric-value" id="campaignShouldSend">0</div>
                                <div class="metric-label">Total Contacts Should Send</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="metric-value" id="campaignDoneSend">0</div>
                                <div class="metric-label">Contacts Done Send Message</div>
                            </div>
                        </div>                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-warning bg-opacity-10 text-warning">
                                    <i class="bi bi-hourglass-split"></i>
                                </div>
                                <div class="metric-value" id="campaignPendingSend">0</div>
                                <div class="metric-label">Contacts Pending Send</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-danger bg-opacity-10 text-danger">
                                    <i class="bi bi-x-circle"></i>
                                </div>
                                <div class="metric-value" id="campaignFailedSend">0</div>
                                <div class="metric-label">Contacts Failed Send</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-secondary bg-opacity-10 text-secondary">
                                    <i class="bi bi-clock-history"></i>
                                </div>
                                <div class="metric-value" id="campaignRemainingSend">0</div>
                                <div class="metric-label">Contacts Remaining Send</div>
                            </div>
                        </div>
                    </div>
                </div>
                    <!-- Campaign Graph -->
                    <div class="chart-container">
                        <h6 class="mb-3">Campaign Performance (broadcast_messages)</h6>
                        <canvas id="campaignChart"></canvas>
                    </div>
                </div>

                <!-- Section 3: Analytics Sequences -->
                <div class="mb-5">
                    <h6 class="mb-3 fw-bold text-info">
                        <i class="bi bi-diagram-3-fill me-2"></i>Sequence Analytics
                    </h6>
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-diagram-3"></i>
                                </div>
                                <div class="metric-value" id="totalSequences">0</div>
                                <div class="metric-label">Total Sequences</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-secondary bg-opacity-10 text-secondary">
                                    <i class="bi bi-layers"></i>
                                </div>
                                <div class="metric-value" id="totalFlows">0</div>
                                <div class="metric-label">Total Flows</div>
                            </div>
                        </div>                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-people-fill"></i>
                                </div>
                                <div class="metric-value" id="sequenceShouldSend">0</div>
                                <div class="metric-label">Total Contacts Should Send</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="metric-value" id="sequenceDoneSend">0</div>
                                <div class="metric-label">Contacts Done Send Message</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-danger bg-opacity-10 text-danger">
                                    <i class="bi bi-x-circle-fill"></i>
                                </div>
                                <div class="metric-value" id="sequenceFailedSend">0</div>
                                <div class="metric-label">Contacts Failed Send</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <div class="metric-icon bg-warning bg-opacity-10 text-warning">
                                    <i class="bi bi-clock-fill"></i>
                                </div>
                                <div class="metric-value" id="sequenceRemainingSend">0</div>
                                <div class="metric-label">Contacts Remaining Send</div>
                            </div>
                        </div>
                    </div>
                    <!-- Sequence Graph -->
                    <div class="chart-container">
                        <h6 class="mb-3">Sequence Performance (sequence_contacts)</h6>
                        <canvas id="sequenceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Devices Tab -->
            <div class="tab-pane fade" id="devices" role="tabpanel">
                <!-- Devices Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Connected Devices</h4>
                        <p class="text-muted mb-0">Manage your WhatsApp devices</p>
                    </div>
                    <div>
                        <!-- Team members cannot add devices -->
                    </div>
                </div>

                <!-- Devices Grid -->
                <div class="row g-4" id="devicesGrid">
                    <!-- Device cards will be dynamically added here -->
                </div>

                <!-- Empty State -->
                <div id="emptyDeviceState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-phone" style="font-size: 64px; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">No devices assigned</h5>
                    <p class="text-muted">Please contact your administrator to assign devices to your account</p>
                </div>
            </div>            
            <!-- Campaign Tab -->
            <div class="tab-pane fade" id="campaign" role="tabpanel">
                <!-- Campaign Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Campaign Calendar</h4>
                        <p class="text-muted mb-0">Plan and schedule your WhatsApp broadcast campaigns</p>
                    </div>
                </div>
                
                <!-- Calendar Container -->
                <div class="card">
                    <div class="card-body">
                        <!-- Debug info -->
                        <div id="campaignDebug" class="alert alert-info mb-3" style="display: none;">
                            <small>Debug: <span id="debugInfo"></span></small>
                        </div>
                        <!-- Calendar controls will be added here by JavaScript -->
                        <div id="campaignCalendar"></div>
                    </div>
                </div>
            </div>
            
            <!-- Sequences Tab -->
            <div class="tab-pane fade" id="sequences" role="tabpanel">
                <!-- Sequences Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Message Sequences</h4>
                        <p class="text-muted mb-0">Create automated drip campaigns for your contacts</p>
                    </div>
                    <div>
                        <!-- Team members cannot create sequences -->
                    </div>
                </div>                
                <!-- Sequences List -->
                <div class="row" id="sequencesList">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-collection display-3 text-muted mb-3"></i>
                                <h5>No Sequences Yet</h5>
                                <p class="text-muted">No sequences available for your devices</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campaign Summary Tab -->
            <div class="tab-pane fade" id="campaign-summary" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Campaign Summary</h4>
                        <p class="text-muted mb-0">Overview of all your campaign activities</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Single Date Filter -->
                        <input type="date" id="campaignFilterDate" class="form-control form-control-sm" style="width: auto;" placeholder="Filter by date">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterCampaigns()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        
                        <!-- Separator -->
                        <div class="vr mx-2"></div>                        
                        <!-- Date Range Filter -->
                        <span class="text-muted small">Range:</span>
                        <input type="date" id="campaignRangeStart" class="form-control form-control-sm" style="width: auto;">
                        <span class="text-muted small">to</span>
                        <input type="date" id="campaignRangeEnd" class="form-control form-control-sm" style="width: auto;">
                        <button class="btn btn-outline-info btn-sm" onclick="filterCampaignsByRange()">
                            <i class="bi bi-calendar-range"></i> Apply Range
                        </button>
                        
                        <!-- Clear and Refresh -->
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCampaignFilter()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="loadCampaignSummary()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Info alert for default filter -->
                <div id="campaignFilterInfo" class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle"></i> Showing campaigns for <strong>today and tomorrow</strong> only. Use filters above to see more dates.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div id="campaignSummaryContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>            
            <!-- Sequence Summary Tab -->
            <div class="tab-pane fade" id="sequence-summary" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Sequence Summary</h4>
                        <p class="text-muted mb-0">Overview of all your sequence activities</p>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Date Filter -->
                        <input type="date" id="sequenceFilterDate" class="form-control form-control-sm" style="width: auto;">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterSequences()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSequenceFilter()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="loadSequenceSummary()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div id="sequenceSummaryContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- QR Code Modal -->
    <div class="modal fade qr-modal" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Connect WhatsApp</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="qr-container">
                        <div id="qrcode" class="mb-3"></div>
                        <h6 class="mb-2">Scan QR Code with WhatsApp</h6>
                        <p class="text-muted small mb-0">
                            1. Open WhatsApp on your phone<br>
                            2. Tap Menu or Settings and select Linked Devices<br>
                            3. Tap on Link a Device<br>
                            4. Point your phone to this screen to capture the code
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Processing...</p>
                </div>
            </div>
        </div>
    </div>
    <!-- Campaign Modal (Read-only for team members) -->
    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="campaignModalTitle">Campaign Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="campaignViewContent">
                        <!-- Campaign details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sequence Detail Modal (Read-only for team members) -->
    <div class="modal fade" id="sequenceDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sequence Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="sequenceDetailContent">
                        <!-- Sequence details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <script>
        // Global variables
        let currentCampaigns = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let devicesData = [];
        let campaignChart = null;
        let sequenceChart = null;
        let autoRefreshInterval = null;
        let isRedirecting = false;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Team Dashboard v1.0 - Initializing');
            
            // Initialize components
            initializeDashboard();
            loadDeviceFilter();
            loadNicheFilter();
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            // Set default dates
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Load team member info
            fetch('/api/team-member/info', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.member) {
                    document.getElementById('teamMemberName').textContent = data.member.username;
                }
            })
            .catch(error => console.error('Error loading team info:', error));
            
            // Setup tab listeners
            setupTabListeners();
            
            // Load initial data after short delay
            setTimeout(() => {
                loadDashboardData();
            }, 100);
        });
        
        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }
        
        // Load team member info
        async function loadTeamMemberInfo() {
            try {
                const response = await fetch('/api/team-member/info', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Prevent infinite redirect loop
                        if (!isRedirecting && !sessionStorage.getItem('redirecting')) {
                            isRedirecting = true;
                            sessionStorage.setItem('redirecting', 'true');
                            console.error('Authentication error - redirecting to login');
                            window.location.href = '/team-login';
                        }
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Clear the redirect flag on successful auth
                sessionStorage.removeItem('redirecting');
                
                const data = await response.json();
                if (data.member) {
                    document.getElementById('teamMemberName').textContent = data.member.username;
                    
                    // Now that we're authenticated, initialize everything
                    initializeDashboard();
                    loadDashboardData();
                    setupTabListeners();
                    updateCurrentTime();
                    setInterval(updateCurrentTime, 60000);
                }
            } catch (error) {
                console.error('Error loading team member info:', error);
            }
        }
        
        // Initialize dashboard
        function initializeDashboard() {
            // Set default date range (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Initialize charts
            initializeCharts();
            
            // Load filters
            loadDeviceFilter();
            loadNicheFilter();
        }
        
        // Initialize charts
        function initializeCharts() {
            // Campaign Chart
            const campaignCtx = document.getElementById('campaignChart');
            if (campaignCtx) {
                campaignChart = new Chart(campaignCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Messages Sent',
                            data: [],
                            borderColor: '#128c7e',
                            backgroundColor: 'rgba(18, 140, 126, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }            
            // Sequence Chart
            const sequenceCtx = document.getElementById('sequenceChart');
            if (sequenceCtx) {
                sequenceChart = new Chart(sequenceCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Sequences Sent',
                            data: [],
                            backgroundColor: '#17a2b8'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }
        // Load device filter
        async function loadDeviceFilter() {
            try {
                const response = await fetch('/api/devices', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication error - redirecting to login');
                        window.location.href = '/team-login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const devices = await response.json();
                
                const deviceFilter = document.getElementById('deviceFilter');
                deviceFilter.innerHTML = '<option value="all">All Devices</option>';
                
                if (Array.isArray(devices)) {
                    devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.id;
                        option.textContent = device.device_name || device.phone || 'Unknown Device';
                        deviceFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }
        
        // Load niche filter
        async function loadNicheFilter() {
            try {
                const response = await fetch('/api/niches', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Silently fail for niche filter - not critical
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const niches = await response.json();
                
                const nicheFilter = document.getElementById('nicheFilter');
                nicheFilter.innerHTML = '<option value="all">All Niches</option>';
                
                if (niches && Array.isArray(niches) && niches.length > 0) {
                    niches.forEach(niche => {
                        if (niche) {
                            const option = document.createElement('option');
                            option.value = niche;
                            option.textContent = niche;
                            nicheFilter.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading niches:', error);
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            const deviceFilter = document.getElementById('deviceFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const nicheFilter = document.getElementById('nicheFilter').value;
            
            const params = new URLSearchParams({
                deviceFilter: deviceFilter,
                startDate: startDate,
                endDate: endDate,
                nicheFilter: nicheFilter
            });
            
            try {
                const response = await fetch(`/api/analytics/dashboard?${params}`, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data) {
                    updateDashboardMetrics(data);
                    updateCharts(data);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        // Update dashboard metrics
        function updateDashboardMetrics(data) {
            // Device Analytics
            document.getElementById('totalDevices').textContent = data.deviceAnalytics?.totalDevices || 0;
            document.getElementById('totalActiveDevices').textContent = data.deviceAnalytics?.totalActiveDevices || 0;
            document.getElementById('totalOfflineDevices').textContent = data.deviceAnalytics?.totalOfflineDevices || 0;
            
            // Campaign Analytics
            document.getElementById('totalCampaigns').textContent = data.campaignAnalytics?.totalCampaigns || 0;
            document.getElementById('campaignShouldSend').textContent = data.campaignAnalytics?.totalContactsShouldSend || 0;
            document.getElementById('campaignDoneSend').textContent = data.campaignAnalytics?.contactsDoneSend || 0;
            document.getElementById('campaignPendingSend').textContent = data.campaignAnalytics?.contactsPendingSend || 0;
            document.getElementById('campaignFailedSend').textContent = data.campaignAnalytics?.contactsFailedSend || 0;
            document.getElementById('campaignRemainingSend').textContent = data.campaignAnalytics?.contactsRemainingSend || 0;
            
            // Sequence Analytics
            document.getElementById('totalSequences').textContent = data.sequenceAnalytics?.totalSequences || 0;
            document.getElementById('totalFlows').textContent = data.sequenceAnalytics?.totalFlows || 0;
            document.getElementById('sequenceShouldSend').textContent = data.sequenceAnalytics?.totalContactsShouldSend || 0;
            document.getElementById('sequenceDoneSend').textContent = data.sequenceAnalytics?.contactsDoneSend || 0;
            document.getElementById('sequenceFailedSend').textContent = data.sequenceAnalytics?.contactsFailedSend || 0;
            document.getElementById('sequenceRemainingSend').textContent = data.sequenceAnalytics?.contactsRemainingSend || 0;
        }
        // Update charts
        function updateCharts(data) {
            // Update campaign chart
            if (campaignChart && data.campaignChartData) {
                campaignChart.data.labels = data.campaignChartData.labels || [];
                campaignChart.data.datasets[0].data = data.campaignChartData.data || [];
                campaignChart.update();
            }
            
            // Update sequence chart
            if (sequenceChart && data.sequenceChartData) {
                sequenceChart.data.labels = data.sequenceChartData.labels || [];
                sequenceChart.data.datasets[0].data = data.sequenceChartData.data || [];
                sequenceChart.update();
            }
        }
        
        // Update dashboard (called by filters)
        function updateDashboard() {
            loadDashboardData();
        }
        
        // Setup tab listeners
        function setupTabListeners() {
            // Listen for tab changes
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    updateBreadcrumb(event.target.textContent.trim());
                    
                    // Load data based on active tab
                    switch(targetId) {
                        case '#dashboard':
                            loadDashboardData();
                            break;
                        case '#devices':
                            loadDevices();
                            break;
                        case '#campaign':
                            initCampaignCalendar();
                            loadCampaigns();
                            break;
                        case '#campaign-summary':
                            loadCampaignSummary();
                            break;
                        case '#sequences':
                            loadSequences();
                            break;
                        case '#sequence-summary':
                            loadSequenceSummary();
                            break;
                    }
                });
            });
        }
        // Update breadcrumb
        function updateBreadcrumb(pageName) {
            document.getElementById('currentPage').textContent = pageName;
        }
        
        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Show alert
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = alertHtml;
            document.querySelector('.container').insertBefore(alertContainer.firstElementChild, document.querySelector('.container').firstChild);
            
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
        // Load devices
        function loadDevices(silent = false) {
            if (!silent) showLoading();
            
            fetch('/api/devices', {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication error - redirecting to login');
                        window.location.href = '/team-login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(devices => {
                if (!devices) return;
                
                devicesData = devices;
                displayDevices(devices);
                if (!silent) hideLoading();
            })
            .catch(error => {
                console.error('Error loading devices:', error);
                if (!silent) {
                    hideLoading();
                    showAlert('danger', 'Failed to load devices');
                }
            });
        }
        
        // Display devices
        function displayDevices(devices) {
            const devicesGrid = document.getElementById('devicesGrid');
            const emptyState = document.getElementById('emptyDeviceState');
            
            if (!devices || !Array.isArray(devices) || devices.length === 0) {
                devicesGrid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            devicesGrid.innerHTML = devices.map(device => createDeviceCard(device)).join('');
        }
        // Create device card
        function createDeviceCard(device) {
            const statusClass = device.status === 'online' ? 'online' : 'offline';
            const statusText = device.status === 'online' ? 'Online' : 'Offline';
            const phoneDisplay = device.phone || 'Not Set';
            const deviceName = device.device_name || 'Unknown Device';
            
            return `
                <div class="col-md-4">
                    <div class="device-card">
                        <div class="device-status ${statusClass}"></div>
                        <h5 class="mb-3">${deviceName}</h5>
                        <div class="mb-3">
                            <small class="text-muted">Phone:</small><br>
                            <strong>${phoneDisplay}</strong>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Status:</small><br>
                            <span class="badge bg-${statusClass === 'online' ? 'success' : 'secondary'}">${statusText}</span>
                        </div>
                        <div class="d-grid gap-2">
                            ${device.status === 'offline' ? 
                                `<button class="btn btn-primary btn-sm" onclick="connectDevice('${device.id}')">
                                    <i class="bi bi-qr-code"></i> Connect
                                </button>` : 
                                `<button class="btn btn-success btn-sm" onclick="openWhatsAppWeb('${device.id}')">
                                    <i class="bi bi-whatsapp"></i> Open WhatsApp
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="disconnectDevice('${device.id}')">
                                    <i class="bi bi-x-circle"></i> Disconnect
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }
        // Connect device
        function connectDevice(deviceId) {
            showLoading();
            
            fetch(`/api/devices/${deviceId}/connect`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.qr) {
                    showQRCode(data.qr, deviceId);
                } else {
                    showAlert('danger', 'Failed to generate QR code');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error connecting device:', error);
                showAlert('danger', 'Failed to connect device');
            });
        }
        
        // Show QR code
        function showQRCode(qrText, deviceId) {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Generate QR code
            const qr = qrcode(0, 'L');
            qr.addData(qrText);
            qr.make();
            
            // Display QR code
            qrContainer.innerHTML = qr.createImgTag(5);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('qrModal'));
            modal.show();
            
            // Start polling for connection status
            pollConnectionStatus(deviceId, modal);
        }
        // Poll connection status
        function pollConnectionStatus(deviceId, modal) {
            const interval = setInterval(() => {
                fetch(`/api/devices/${deviceId}/status`, {
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'online') {
                        clearInterval(interval);
                        modal.hide();
                        showAlert('success', 'Device connected successfully!');
                        loadDevices();
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
            }, 2000);
            
            // Stop polling after 2 minutes
            setTimeout(() => {
                clearInterval(interval);
            }, 120000);
        }
        
        // Disconnect device
        function disconnectDevice(deviceId) {
            if (!confirm('Are you sure you want to disconnect this device?')) return;
            
            showLoading();
            
            fetch(`/api/devices/${deviceId}/disconnect`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                showAlert('success', 'Device disconnected successfully');
                loadDevices();
            })
            .catch(error => {
                hideLoading();
                console.error('Error disconnecting device:', error);
                showAlert('danger', 'Failed to disconnect device');
            });
        }
        // Open WhatsApp Web
        function openWhatsAppWeb(deviceId) {
            window.open(`/device/${deviceId}/whatsapp-web`, '_blank');
        }
        
        // Initialize campaign calendar
        function initCampaignCalendar() {
            const calendarContainer = document.getElementById('campaignCalendar');
            if (!calendarContainer) return;
            
            // Clear existing content
            calendarContainer.innerHTML = '';
            
            // Create controls
            const controlsHtml = `
                <div id="calendarControls" class="calendar-controls">
                    <button class="btn btn-sm btn-outline-primary" onclick="previousMonth()">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <span class="calendar-month-year">${getMonthName(currentMonth)} ${currentYear}</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            `;
            
            const controlsContainer = document.createElement('div');
            controlsContainer.innerHTML = controlsHtml;
            calendarContainer.parentElement.insertBefore(controlsContainer.firstElementChild, calendarContainer);
            
            renderCalendar();
        }
        // Render calendar
        function renderCalendar() {
            const calendar = document.getElementById('campaignCalendar');
            if (!calendar) return;
            
            calendar.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Get first day of month
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const prevLastDay = new Date(currentYear, currentMonth, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDateOfMonth = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            // Add previous month's days
            for (let i = firstDayOfWeek; i > 0; i--) {
                const dayDiv = createCalendarDay(prevLastDate - i + 1, true);
                calendar.appendChild(dayDiv);
            }
            
            // Add current month's days
            for (let i = 1; i <= lastDateOfMonth; i++) {
                const dayDiv = createCalendarDay(i, false);
                calendar.appendChild(dayDiv);
            }
            
            // Add next month's days
            const remainingDays = 42 - (firstDayOfWeek + lastDateOfMonth);
            for (let i = 1; i <= remainingDays; i++) {
                const dayDiv = createCalendarDay(i, true);
                calendar.appendChild(dayDiv);
            }
        }
        // Create calendar day
        function createCalendarDay(day, isOtherMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            if (isOtherMonth) {
                dayDiv.classList.add('other-month');
            }
            
            // Check if today
            const today = new Date();
            if (!isOtherMonth && 
                day === today.getDate() && 
                currentMonth === today.getMonth() && 
                currentYear === today.getFullYear()) {
                dayDiv.classList.add('today');
            }
            
            // Add date number
            const dateDiv = document.createElement('div');
            dateDiv.className = 'calendar-date';
            dateDiv.textContent = day;
            dayDiv.appendChild(dateDiv);
            
            // Check for campaigns on this date
            if (!isOtherMonth) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const campaignsOnDate = currentCampaigns.filter(c => c.campaign_date === dateStr);
                
                if (campaignsOnDate.length > 0) {
                    dayDiv.classList.add('has-campaign');
                    
                    // Add campaign count
                    const countDiv = document.createElement('div');
                    countDiv.className = 'campaign-count';
                    countDiv.textContent = campaignsOnDate.length;
                    dayDiv.appendChild(countDiv);
                    
                    // Add campaign list
                    const listDiv = document.createElement('div');
                    listDiv.className = 'campaign-list';
                    campaignsOnDate.forEach(campaign => {
                        const item = document.createElement('div');
                        item.className = 'campaign-item';
                        item.textContent = campaign.name;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            viewCampaign(campaign.id);
                        };
                        listDiv.appendChild(item);
                    });
                    dayDiv.appendChild(listDiv);
                }
            }
            
            return dayDiv;
        }
        // Get month name
        function getMonthName(month) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[month];
        }
        
        // Previous month
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }
        
        // Next month
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }
        
        // Load campaigns
        function loadCampaigns() {
            fetch('/api/campaigns', {
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication error - redirecting to login');
                        window.location.href = '/team-login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data && Array.isArray(data)) {
                    currentCampaigns = data;
                    renderCalendar();
                }
            })
            .catch(error => {
                console.error('Error loading campaigns:', error);
            });
        }
        // View campaign (read-only for team members)
        function viewCampaign(campaignId) {
            fetch(`/api/campaigns/${campaignId}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(campaign => {
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> ${campaign.name}</p>
                            <p><strong>Date:</strong> ${campaign.campaign_date}</p>
                            <p><strong>Time:</strong> ${campaign.time_schedule || 'Not set'}</p>
                            <p><strong>Status:</strong> ${campaign.status}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Total Recipients:</strong> ${campaign.recipients_count || 0}</p>
                            <p><strong>Device Limit:</strong> ${campaign.device_id_limit || 'No limit'}</p>
                            <p><strong>Created:</strong> ${new Date(campaign.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <hr>
                    <div>
                        <h6>Message Content:</h6>
                        <pre>${campaign.content || 'No content'}</pre>
                    </div>
                `;
                
                document.getElementById('campaignViewContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading campaign:', error);
                showAlert('danger', 'Failed to load campaign details');
            });
        }
        // Load campaign summary
        function loadCampaignSummary() {
            let url = '/api/campaigns/summary';
            
            const filterDate = document.getElementById('campaignFilterDate').value;
            const rangeStart = document.getElementById('campaignRangeStart').value;
            const rangeEnd = document.getElementById('campaignRangeEnd').value;
            
            const params = new URLSearchParams();
            if (filterDate) params.append('date', filterDate);
            if (rangeStart && rangeEnd) {
                params.append('startDate', rangeStart);
                params.append('endDate', rangeEnd);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                displayCampaignSummary(data);
            })
            .catch(error => {
                console.error('Error loading campaign summary:', error);
                document.getElementById('campaignSummaryContent').innerHTML = `
                    <div class="alert alert-danger">Failed to load campaign summary</div>
                `;
            });
        }
        
        // Display campaign summary
        function displayCampaignSummary(data) {
            if (!data || !data.campaigns) {
                document.getElementById('campaignSummaryContent').innerHTML = `
                    <div class="alert alert-info">No campaign data available</div>
                `;
                return;
            }
            
            const html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${data.campaigns.total || 0}</div>
                            <div class="metric-label">Total Campaigns</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_messages_sent || 0}</div>
                            <div class="metric-label">Messages Sent</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_messages_failed || 0}</div>
                            <div class="metric-label">Messages Failed</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_messages_pending || 0}</div>
                            <div class="metric-label">Messages Pending</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Campaign Name</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Recipients</th>
                                <th>Sent</th>
                                <th>Failed</th>
                                <th>Pending</th>
                                <th>Success Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.recent_campaigns.map(campaign => `
                                <tr>
                                    <td>${campaign.name}</td>
                                    <td>${campaign.campaign_date}</td>
                                    <td><span class="badge bg-${campaign.status === 'active' ? 'success' : 'secondary'}">${campaign.status}</span></td>
                                    <td>${campaign.recipients_count || 0}</td>
                                    <td>${campaign.sent_count || 0}</td>
                                    <td>${campaign.failed_count || 0}</td>
                                    <td>${campaign.pending_count || 0}</td>
                                    <td>${campaign.success_rate || '0'}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('campaignSummaryContent').innerHTML = html;
        }
        
        // Filter campaigns
        function filterCampaigns() {
            loadCampaignSummary();
        }
        
        // Filter campaigns by range
        function filterCampaignsByRange() {
            loadCampaignSummary();
        }
        
        // Clear campaign filter
        function clearCampaignFilter() {
            document.getElementById('campaignFilterDate').value = '';
            document.getElementById('campaignRangeStart').value = '';
            document.getElementById('campaignRangeEnd').value = '';
            document.getElementById('campaignFilterInfo').style.display = 'block';
            loadCampaignSummary();
        }
        
        // Load sequences
        async function loadSequences() {
            try {
                const response = await fetch('/api/sequences', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.error('Authentication error - redirecting to login');
                        window.location.href = '/team-login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (Array.isArray(data)) {
                    displaySequences(data);
                } else {
                    displaySequences([]);
                }
            } catch (error) {
                console.error('Error loading sequences:', error);
                showAlert('danger', 'Failed to load sequences');
            }
        }
        
        // Display sequences
        function displaySequences(sequences) {
            const sequencesList = document.getElementById('sequencesList');
            
            if (!sequences || !Array.isArray(sequences) || sequences.length === 0) {
                sequencesList.innerHTML = `
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-collection display-3 text-muted mb-3"></i>
                                <h5>No Sequences Available</h5>
                                <p class="text-muted">No sequences have been created for your devices yet.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            sequencesList.innerHTML = sequences.map(sequence => `
                <div class="col-12 mb-3">
                    <div class="sequence-card">
                        <div class="sequence-header">
                            <h5 class="sequence-name">${sequence.name}</h5>
                            <span class="badge bg-${sequence.status === 'active' ? 'success' : 'secondary'}">
                                ${sequence.status}
                            </span>
                        </div>
                        <p class="text-muted mb-2">${sequence.description || 'No description'}</p>
                        <div class="sequence-stats">
                            <div class="sequence-stat">
                                <div class="sequence-stat-label">Total Steps</div>
                                <div class="sequence-stat-value">${sequence.total_steps || 0}</div>
                            </div>
                            <div class="sequence-stat">
                                <div class="sequence-stat-label">Active Contacts</div>
                                <div class="sequence-stat-value">${sequence.active_contacts || 0}</div>
                            </div>
                            <div class="sequence-stat">
                                <div class="sequence-stat-label">Completed</div>
                                <div class="sequence-stat-value">${sequence.completed_contacts || 0}</div>
                            </div>
                        </div>
                        <div class="sequence-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewSequenceDetails('${sequence.id}')">
                                <i class="bi bi-eye"></i> View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // View sequence details
        function viewSequenceDetails(sequenceId) {
            fetch(`/api/sequences/${sequenceId}/summary`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                // Display sequence details in modal
                const content = `
                    <h5>${data.name}</h5>
                    <p class="text-muted">${data.description || 'No description'}</p>
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value">${data.total_flows || 0}</div>
                                <div class="metric-label">Total Flows</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value">${data.contacts_should_send || 0}</div>
                                <div class="metric-label">Should Send</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-card">
                                <div class="metric-value">${data.contacts_done_send || 0}</div>
                                <div class="metric-label">Done Send</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('sequenceDetailContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('sequenceDetailModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading sequence details:', error);
                showAlert('danger', 'Failed to load sequence details');
            });
        }
        // Load sequence summary
        function loadSequenceSummary() {
            const filterDate = document.getElementById('sequenceFilterDate').value;
            let url = '/api/sequences/summary';
            
            if (filterDate) {
                url += `?date=${filterDate}`;
            }
            
            fetch(url, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                displaySequenceSummary(data);
            })
            .catch(error => {
                console.error('Error loading sequence summary:', error);
                document.getElementById('sequenceSummaryContent').innerHTML = `
                    <div class="alert alert-danger">Failed to load sequence summary</div>
                `;
            });
        }
        
        // Display sequence summary
        function displaySequenceSummary(data) {
            if (!data) {
                document.getElementById('sequenceSummaryContent').innerHTML = `
                    <div class="alert alert-info">No sequence data available</div>
                `;
                return;
            }
            
            const html = `
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.sequences?.total || 0}</div>
                            <div class="metric-label">Total Sequences</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_flows || 0}</div>
                            <div class="metric-label">Total Flows</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_should_send || 0}</div>
                            <div class="metric-label">Should Send</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_done_send || 0}</div>
                            <div class="metric-label">Done Send</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_failed_send || 0}</div>
                            <div class="metric-label">Failed Send</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${data.total_remaining_send || 0}</div>
                            <div class="metric-label">Remaining</div>
                        </div>
                    </div>
                </div>                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Sequence Name</th>
                                <th>Niche</th>
                                <th>Trigger</th>
                                <th>Total Flows</th>
                                <th>Should Send</th>
                                <th>Done Send</th>
                                <th>Failed</th>
                                <th>Remaining</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(data.recent_sequences || []).map(seq => `
                                <tr>
                                    <td>${seq.name}</td>
                                    <td>${seq.niche || '-'}</td>
                                    <td>${seq.trigger || '-'}</td>
                                    <td>${seq.total_flows || 0}</td>
                                    <td>${seq.should_send || 0}</td>
                                    <td>${seq.done_send || 0}</td>
                                    <td>${seq.failed_send || 0}</td>
                                    <td>${seq.remaining_send || 0}</td>
                                    <td><span class="badge bg-${seq.status === 'active' ? 'success' : 'secondary'}">${seq.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('sequenceSummaryContent').innerHTML = html;
        }
        // Filter sequences
        function filterSequences() {
            loadSequenceSummary();
        }
        
        // Clear sequence filter
        function clearSequenceFilter() {
            document.getElementById('sequenceFilterDate').value = '';
            loadSequenceSummary();
        }
        
        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                fetch('/api/team-logout', {
                    method: 'POST',
                    credentials: 'include'
                })
                .then(() => {
                    window.location.href = '/team-login';
                })
                .catch(error => {
                    console.error('Error logging out:', error);
                });
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: type,
                title: message,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        }
    </script>
</body>
</html>