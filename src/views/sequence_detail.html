<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Sequence.Name }} - WhatsApp Multi-Device</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary: #128c7e;
            --primary-dark: #075e54;
            --success: #25d366;
            --danger: #dc3545;
            --warning: #ffc107;
            --light-bg: #f0f2f5;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        body {
            background-color: var(--light-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .navbar {
            background-color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .navbar-brand {
            color: var(--primary) !important;
            font-weight: 600;
        }

        .page-header {
            background: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: none;
            text-align: center;
            height: 100%;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .metric-label {
            color: #667781;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-back {
            background-color: #f0f2f5;
            border: none;
            color: #333;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background-color: #e4e6eb;
            color: #333;
        }

        .flow-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: none;
            margin-bottom: 20px;
            height: 100%;
        }

        .flow-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.1rem;
            text-align: center;
        }

        .flow-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            row-gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-label {
            color: #667781;
            font-size: 11px;
            margin-top: 5px;
        }

        .sequence-timeline {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            border: none;
            margin-top: 30px;
        }

        .timeline-header {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .timeline-flow {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafbfc;
        }

        .timeline-flow-header {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .timeline-content {
            margin-bottom: 15px;
        }

        .timeline-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .timeline-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        @media (min-width: 768px) {
            .timeline-stats {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .timeline-stat {
            text-align: center;
        }

        .timeline-stat-label {
            color: #667781;
            font-size: 12px;
            display: block;
            margin-bottom: 5px;
        }

        .timeline-stat-value {
            font-weight: 700;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-whatsapp"></i> WhatsApp Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">{{ .User.Email }}</span>
                <a href="/logout" class="nav-link text-danger">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h2 class="mb-0">{{ .Sequence.Name }}</h2>
                    <p class="text-muted mb-0">Sequence Progress Overview</p>
                </div>
                <div class="col-auto">
                    <button class="btn btn-back" onclick="window.location.href='/sequences'">
                        <i class="bi bi-arrow-left"></i> Back to Sequences
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Metric Cards Row -->
        <div class="row mb-4">
            <!-- Total Flow Box -->
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-primary" id="totalFlows">0</div>
                    <div class="metric-label">Total Flows</div>
                </div>
            </div>
            
            <!-- Total Contacts (Should Send) Box -->
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-info" id="totalShouldSend">0</div>
                    <div class="metric-label">Total Contacts Should Send</div>
                </div>
            </div>
            
            <!-- Contacts Done Send Message Box -->
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-success" id="totalDoneSend">0</div>
                    <div class="metric-label">Contacts Done Send Message</div>
                </div>
            </div>
            
            <!-- Contacts Failed Send Message Box -->
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-danger" id="totalFailedSend">0</div>
                    <div class="metric-label">Contacts Failed Send Message</div>
                </div>
            </div>
            
            <!-- Contacts Remaining Send Message Box -->
            <div class="col-6 col-md-3 col-lg-2 mb-3">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="totalRemainingSend">0</div>
                    <div class="metric-label">Contacts Remaining Send Message</div>
                </div>
            </div>
        </div>

        <!-- Flow Cards -->
        <div id="flowCards">
            <!-- Flow cards will be dynamically generated -->
        </div>

        <!-- Sequence Timeline -->
        <div class="sequence-timeline">
            <h4 class="timeline-header">Sequence Timeline</h4>
            <div id="sequenceTimeline">
                <!-- Timeline will be dynamically generated -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const sequenceId = '{{ .Sequence.ID }}';
        const sequenceTrigger = '{{ .Sequence.Trigger }}';
        let sequenceData = null;
        let contactsData = null;
        let totalFlows = 0;
        let totalShouldSend = 0;
        let totalDoneSend = 0;
        let totalFailedSend = 0;
        let totalRemainingSend = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSequenceDetails();
            loadSequenceContacts();
        });

        function loadSequenceDetails() {
            fetch(`/api/sequences/${sequenceId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        sequenceData = data.results;
                        calculateTotals();
                        displayFlowCards();
                        displayTimeline();
                    }
                })
                .catch(error => {
                    console.error('Error loading sequence details:', error);
                });
        }

        function loadSequenceContacts() {
            fetch(`/api/sequences/${sequenceId}/contacts`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        contactsData = data.results || [];
                        calculateContactStats();
                    }
                })
                .catch(error => {
                    console.error('Error loading sequence contacts:', error);
                });
        }

        function calculateContactStats() {
            if (!contactsData) return;
            
            // Reset counters
            totalDoneSend = 0;
            totalFailedSend = 0;
            totalRemainingSend = 0;
            
            // Count by status
            contactsData.forEach(contact => {
                if (contact.status === 'sent' || contact.status === 'completed') {
                    totalDoneSend++;
                } else if (contact.status === 'failed') {
                    totalFailedSend++;
                } else if (contact.status === 'active' || contact.status === 'pending') {
                    totalRemainingSend++;
                }
            });
            
            // Update display
            document.getElementById('totalDoneSend').textContent = totalDoneSend;
            document.getElementById('totalFailedSend').textContent = totalFailedSend;
            document.getElementById('totalRemainingSend').textContent = totalRemainingSend;
        }

        function calculateTotals() {
            if (!sequenceData.steps) return;
            
            totalFlows = sequenceData.steps.length;
            // Total should send is the number of contacts enrolled
            totalShouldSend = sequenceData.contacts_count || 0;
            
            document.getElementById('totalFlows').textContent = totalFlows;
            document.getElementById('totalShouldSend').textContent = totalShouldSend;
        }

        function displayFlowCards() {
            const container = document.getElementById('flowCards');
            container.innerHTML = '';

            if (!sequenceData.steps || sequenceData.steps.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No flows defined for this sequence.</div>';
                return;
            }

            // Create a row container
            const row = document.createElement('div');
            row.className = 'row';

            // Create a card for each flow
            sequenceData.steps.forEach((step, index) => {
                const shouldSend = sequenceData.contacts_count || 0;
                const doneSend = 0; // This would come from actual send data per flow
                const failedSend = 0; // This would come from actual send data per flow
                const remainingSend = shouldSend - doneSend - failedSend;
                
                const flowCard = document.createElement('div');
                flowCard.className = 'col-md-6 col-lg-4 mb-3';
                
                flowCard.innerHTML = `
                    <div class="flow-card">
                        <div class="flow-header">Flow ${index + 1}</div>
                        <div class="flow-stats">
                            <div class="stat-item">
                                <div class="stat-value text-info">${shouldSend}</div>
                                <div class="stat-label">Should Send</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-success">${doneSend}</div>
                                <div class="stat-label">Done Send</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-danger">${failedSend}</div>
                                <div class="stat-label">Failed Send</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value text-warning">${remainingSend}</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                    </div>
                `;
                
                row.appendChild(flowCard);
            });

            container.appendChild(row);
        }

        function displayTimeline() {
            const container = document.getElementById('sequenceTimeline');
            container.innerHTML = '';

            if (!sequenceData.steps || sequenceData.steps.length === 0) {
                container.innerHTML = '<p class="text-muted">No timeline data available.</p>';
                return;
            }

            sequenceData.steps.forEach((step, index) => {
                const shouldSend = sequenceData.contacts_count || 0;
                const doneSend = 0; // This would come from actual send data per flow
                const failedSend = 0; // This would come from actual send data per flow
                const remainingSend = shouldSend - doneSend - failedSend;
                
                const timelineFlow = document.createElement('div');
                timelineFlow.className = 'timeline-flow';
                
                timelineFlow.innerHTML = `
                    <div class="timeline-flow-header">
                        Flow ${index + 1} - ${step.trigger || `Day ${step.day_number}`}
                    </div>
                    
                    <div class="timeline-content">
                        ${step.media_url ? `
                            <img src="${step.media_url}" class="timeline-image" alt="Flow ${index + 1} Image">
                        ` : ''}
                        
                        <div class="mt-2">
                            <strong>Description:</strong><br>
                            ${step.content || 'No description available'}
                        </div>
                    </div>
                    
                    <div class="timeline-stats">
                        <div class="timeline-stat">
                            <span class="timeline-stat-label">Total Lead Should Sent</span>
                            <span class="timeline-stat-value text-info">${shouldSend}</span>
                        </div>
                        <div class="timeline-stat">
                            <span class="timeline-stat-label">Total Lead Done Sent</span>
                            <span class="timeline-stat-value text-success">${doneSend}</span>
                        </div>
                        <div class="timeline-stat">
                            <span class="timeline-stat-label">Total Lead Failed Sent</span>
                            <span class="timeline-stat-value text-danger">${failedSend}</span>
                        </div>
                        <div class="timeline-stat">
                            <span class="timeline-stat-label">Total Lead Remaining</span>
                            <span class="timeline-stat-value text-warning">${remainingSend}</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(timelineFlow);
            });
        }
    </script>
</body>
</html>