<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #128c7e;
            --primary-dark: #075e54;
            --success: #25d366;
            --light-bg: #f0f2f5;
            --card-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        body {
            background-color: var(--light-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .navbar {
            background-color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .navbar-brand {
            color: var(--primary) !important;
            font-weight: 600;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            border: none;
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 4px;
        }

        .metric-label {
            color: #667781;
            font-size: 14px;
        }

        .time-toggle {
            background: white;
            border-radius: 24px;
            padding: 4px;
            display: inline-flex;
            box-shadow: var(--card-shadow);
        }

        .time-toggle .btn {
            border-radius: 20px;
            border: none;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 500;
            background: transparent;
            color: #667781;
        }

        .time-toggle .btn.active {
            background: var(--primary);
            color: white;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--card-shadow);
            height: 350px;
        }

        .device-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--card-shadow);
            border: 1px solid #e9ecef;
            transition: all 0.3s;
            height: 100%;
            position: relative;
        }

        .device-card.connected {
            border-color: var(--success);
            border-width: 2px;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .device-icon {
            width: 36px;
            height: 36px;
            background: #f0f9f7;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .device-info {
            background: #f8f9fa !important;
            border: 1px solid #e9ecef;
        }

        .device-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .device-status.online {
            background-color: var(--success);
        }

        .device-status.offline {
            background-color: #e74c3c;
        }

        .btn-whatsapp {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-whatsapp:hover {
            background-color: var(--primary-dark);
            color: white;
            transform: translateY(-1px);
        }

        .add-device-card {
            border: 2px dashed #dee2e6;
            background: #fafbfc;
            cursor: pointer;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .add-device-card:hover {
            border-color: var(--primary);
            background: #f0f9f7;
        }

        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #667781;
            font-weight: 500;
            padding: 12px 24px;
            background: transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .qr-modal .modal-content {
            border-radius: 16px;
            overflow: hidden;
        }

        .qr-container {
            padding: 40px;
            text-align: center;
            background: white;
        }
        
        /* Campaign Calendar Styles */
        #campaignCalendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e9ecef;
            padding: 1px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-month-year {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }
        
        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #fafafa;
        }
        
        .calendar-day.has-campaign {
            background: #e3f2fd;
            border: 2px solid var(--primary);
        }
        
        .calendar-day.today {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .calendar-day.today.has-campaign {
            background: linear-gradient(135deg, #fff3cd 50%, #e3f2fd 50%);
            border: 2px solid var(--primary);
        }
        
        .calendar-date {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .calendar-date span {
            display: block;
        }
        
        .calendar-campaigns {
            margin-top: 4px;
            font-size: 11px;
        }
        
        .campaign-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 4px;
            border-radius: 3px;
            margin: 2px 0;
            display: flex;
            align-items: center;
            gap: 4px;
            overflow: hidden;
        }
        
        .campaign-item .badge {
            font-size: 9px;
            padding: 1px 4px;
            flex-shrink: 0;
        }
        
        .campaign-item small {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calendar-header {
            background: var(--primary);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .calendar-day {
            background: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover {
            background: #f8f9fa;
            transform: scale(1.02);
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #fafafa;
        }
        
        .calendar-day.has-campaign {
            background: #e3f2fd;
            border: 2px solid var(--primary);
        }
        
        .calendar-date {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .calendar-campaign-indicator {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            position: absolute;
            top: 8px;
            right: 8px;
        }
        
        .campaign-item {
            font-size: 11px;
            margin: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .campaign-item .badge {
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .campaign-detail {
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 4px;
            border-radius: 3px;
            margin: 1px 0;
            transition: background 0.2s;
        }
        
        .campaign-detail:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .campaign-container {
            max-height: 80px;
            overflow-y: auto;
            padding: 2px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }
        
        .campaign-container::-webkit-scrollbar {
            width: 4px;
        }
        
        .campaign-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .campaign-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e0;
            border-radius: 2px;
        }
        
        .calendar-day {
            position: relative;
            overflow: visible;
        }
        
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-month-year {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .campaign-item {
            font-size: 10px;
            background: var(--primary);
            color: white;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Sequence Calendar Styles */
        .sequence-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .sequence-day-box {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
            min-height: 80px;
        }
        
        .sequence-day-box:hover {
            border-color: var(--primary) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .sequence-day-box.active {
            border-color: var(--success);
            background: #f0fdf4;
        }
        
        @media (max-width: 768px) {
            .sequence-days-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .sequence-days-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-whatsapp"></i> WhatsApp Analytics
            </a>
            <div class="ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle"></i> admin
                </span>
                <button class="btn btn-sm btn-outline-danger" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Navigation Bar -->
    <div class="navigation-bar bg-light py-2 px-3 border-bottom">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="history.back()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="window.location.href='/dashboard'">
                    <i class="bi bi-house"></i> Home
                </button>
                
                <!-- System Status Icons - HIDDEN -->
                <!-- <div class="btn-group ms-3" role="group">
                    <button class="btn btn-sm btn-outline-success" onclick="checkRedisStatus()" title="Check Redis Status">
                        <i class="bi bi-database-check"></i> Redis
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="checkDeviceWorker()" title="Check Device Worker">
                        <i class="bi bi-cpu"></i> Device Worker
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="checkAllWorkers()" title="Check All Workers">
                        <i class="bi bi-diagram-3"></i> All Workers
                    </button>
                </div> -->
            </div>
            <div class="breadcrumb mb-0">
                <span class="text-muted">You are here: </span>
                <span id="currentPage">Dashboard</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button">
                    <i class="bi bi-phone"></i> Devices
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaign-tab" data-bs-toggle="tab" data-bs-target="#campaign" type="button">
                    <i class="bi bi-calendar3"></i> Campaign
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="campaign-summary-tab" data-bs-toggle="tab" data-bs-target="#campaign-summary" type="button">
                    <i class="bi bi-graph-up"></i> Campaign Summary
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sequences-tab" data-bs-toggle="tab" data-bs-target="#sequences" type="button">
                    <i class="bi bi-collection"></i> Sequences
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sequence-summary-tab" data-bs-toggle="tab" data-bs-target="#sequence-summary" type="button">
                    <i class="bi bi-bar-chart"></i> Sequence Summary
                </button>
            </li>
            <!-- Worker Status Tab - HIDDEN -->
            <!-- <li class="nav-item" role="presentation">
                <button class="nav-link" id="worker-status-tab" data-bs-toggle="tab" data-bs-target="#worker-status" type="button">
                    <i class="bi bi-cpu"></i> Worker Status
                </button>
            </li> -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="manage-ai-tab" data-bs-toggle="tab" data-bs-target="#manage-ai" type="button">
                    <i class="bi bi-robot"></i> Manage AI
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <!-- Time Range Toggle -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="mb-0">Analytics Overview</h5>
                        <small class="text-muted">Today: June 23, 2025 | <span id="lastRefresh">Last refresh: Never</span></small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Auto Refresh Toggle -->
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh()">
                            <label class="form-check-label" for="autoRefreshToggle">
                                <small>Auto-refresh (10s)</small>
                            </label>
                        </div>
                        
                        <!-- Manual Refresh Button -->
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()" title="Refresh Now">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        
                        <!-- Device Filter -->
                        <select class="form-select form-select-sm" id="deviceFilter" onchange="filterByDevice()" style="width: 200px;">
                            <option value="all">All Devices</option>
                        </select>
                        
                        <!-- Time Range -->
                        <div class="time-toggle">
                            <button class="btn" onclick="changeTimeRange('today')">Today</button>
                            <button class="btn active" onclick="changeTimeRange(7)">7 Days</button>
                            <button class="btn" onclick="changeTimeRange(30)">30 Days</button>
                            <button class="btn" onclick="changeTimeRange(90)">90 Days</button>
                            <button class="btn" onclick="showCustomDateRange()">Custom</button>
                        </div>
                    </div>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="customDateRange" class="card mb-3 d-none">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="startDate" max="">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="endDate" max="">
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-whatsapp" onclick="applyCustomDateRange()">
                                    <i class="bi bi-check-lg"></i> Apply
                                </button>
                                <button class="btn btn-outline-secondary ms-2" onclick="hideCustomDateRange()">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="row g-3 mb-4">
                    <!-- First Row - Device Metrics -->
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-phone-fill"></i>
                            </div>
                            <div class="metric-value" id="activeDevices">0</div>
                            <div class="metric-label">Active Devices</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-danger bg-opacity-10 text-danger">
                                <i class="bi bi-phone-x"></i>
                            </div>
                            <div class="metric-value" id="inactiveDevices">0</div>
                            <div class="metric-label">Inactive Devices</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-send"></i>
                            </div>
                            <div class="metric-value" id="leadsSent">0</div>
                            <div class="metric-label">Leads Sent</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-info bg-opacity-10 text-info">
                                <i class="bi bi-inbox"></i>
                            </div>
                            <div class="metric-value" id="leadsReceived">0</div>
                            <div class="metric-label">Leads Received</div>
                            <small class="text-success" id="leadsReceivedPercent">0%</small>
                        </div>
                    </div>
                </div>

                <!-- Second Row - Lead Status Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-warning bg-opacity-10 text-warning">
                                <i class="bi bi-x-circle"></i>
                            </div>
                            <div class="metric-value" id="leadsNotReceived">0</div>
                            <div class="metric-label">Leads Not Received</div>
                            <small class="text-danger" id="leadsNotReceivedPercent">0%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-success bg-opacity-10 text-success">
                                <i class="bi bi-check-double"></i>
                            </div>
                            <div class="metric-value" id="leadsRead">0</div>
                            <div class="metric-label">Leads Read</div>
                            <small class="text-success" id="leadsReadPercent">0%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-secondary bg-opacity-10 text-secondary">
                                <i class="bi bi-check"></i>
                            </div>
                            <div class="metric-value" id="leadsNotRead">0</div>
                            <div class="metric-label">Leads Not Read</div>
                            <small class="text-secondary" id="leadsNotReadPercent">0%</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                                <i class="bi bi-reply"></i>
                            </div>
                            <div class="metric-value" id="leadsReplied">0</div>
                            <div class="metric-label">Leads Replied</div>
                            <small class="text-primary" id="leadsRepliedPercent">0%</small>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-container">
                    <h5 class="mb-3">Daily Message Activity</h5>
                    <canvas id="messageChart"></canvas>
                </div>
            </div>

            <!-- Devices Tab -->
            <div class="tab-pane fade" id="devices" role="tabpanel">
                <!-- Devices Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">WhatsApp Devices</h4>
                        <p class="text-muted mb-0">Manage your connected WhatsApp accounts</p>
                    </div>
                    <div>
                        <!-- Clear All Sessions Button - HIDDEN -->
                        <!-- <button class="btn btn-danger me-2" onclick="clearAllSessions()">
                            <i class="bi bi-x-circle me-2"></i>Clear All Sessions
                        </button> -->
                        <button class="btn btn-primary" onclick="addNewDevice()">
                            <i class="bi bi-plus-circle me-2"></i>Add Device
                        </button>
                    </div>
                </div>

                <!-- Devices Grid -->
                <div class="row g-4" id="devicesGrid">
                    <!-- Device cards will be dynamically added here -->
                </div>

                <!-- Empty State -->
                <div id="emptyDeviceState" class="text-center py-5" style="display: none;">
                    <i class="bi bi-phone" style="font-size: 64px; color: #dee2e6;"></i>
                    <h5 class="mt-3 text-muted">No devices connected</h5>
                    <p class="text-muted">Add a device to start using WhatsApp Analytics</p>
                    <button class="btn btn-primary mt-3" onclick="addNewDevice()">
                        <i class="bi bi-plus-circle me-2"></i>Add Your First Device
                    </button>
                </div>
            </div>
            
            <!-- Campaign Tab -->
            <div class="tab-pane fade" id="campaign" role="tabpanel">
                <!-- Campaign Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Campaign Calendar</h4>
                        <p class="text-muted mb-0">Plan and schedule your WhatsApp broadcast campaigns</p>
                    </div>
                </div>
                
                <!-- Calendar Container -->
                <div class="card">
                    <div class="card-body">
                        <!-- Debug info -->
                        <div id="campaignDebug" class="alert alert-info mb-3" style="display: none;">
                            <small>Debug: <span id="debugInfo"></span></small>
                        </div>
                        <!-- Calendar controls will be added here by JavaScript -->
                        <div id="campaignCalendar"></div>
                    </div>
                </div>
            </div>
            
            <!-- Sequences Tab -->
            <div class="tab-pane fade" id="sequences" role="tabpanel">
                <!-- Sequences Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Message Sequences</h4>
                        <p class="text-muted mb-0">Create automated drip campaigns for your contacts</p>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="openCreateSequenceModal()">
                            <i class="bi bi-plus-circle"></i> Create Sequence
                        </button>
                    </div>
                </div>
                
                <!-- Sequences List -->
                <div class="row" id="sequencesList">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-collection display-3 text-muted mb-3"></i>
                                <h5>No Sequences Yet</h5>
                                <p class="text-muted">Create your first automated message sequence</p>
                                <a href="/sequences" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Create Sequence
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Campaign Summary Tab -->
            <div class="tab-pane fade" id="campaign-summary" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Campaign Summary</h4>
                        <p class="text-muted mb-0">Overview of all your campaign activities</p>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Single Date Filter -->
                        <input type="date" id="campaignFilterDate" class="form-control form-control-sm" style="width: auto;" placeholder="Filter by date">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterCampaigns()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        
                        <!-- Separator -->
                        <div class="vr mx-2"></div>
                        
                        <!-- Date Range Filter -->
                        <span class="text-muted small">Range:</span>
                        <input type="date" id="campaignRangeStart" class="form-control form-control-sm" style="width: auto;">
                        <span class="text-muted small">to</span>
                        <input type="date" id="campaignRangeEnd" class="form-control form-control-sm" style="width: auto;">
                        <button class="btn btn-outline-info btn-sm" onclick="filterCampaignsByRange()">
                            <i class="bi bi-calendar-range"></i> Apply Range
                        </button>
                        
                        <!-- Clear and Refresh -->
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearCampaignFilter()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="loadCampaignSummary()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Info alert for default filter -->
                <div id="campaignFilterInfo" class="alert alert-info alert-dismissible fade show" role="alert">
                    <i class="bi bi-info-circle"></i> Showing campaigns for <strong>today and tomorrow</strong> only. Use filters above to see more dates.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <div id="campaignSummaryContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sequence Summary Tab -->
            <div class="tab-pane fade" id="sequence-summary" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Sequence Summary</h4>
                        <p class="text-muted mb-0">Overview of all your sequence activities</p>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Date Filter -->
                        <input type="date" id="sequenceFilterDate" class="form-control form-control-sm" style="width: auto;">
                        <button class="btn btn-outline-primary btn-sm" onclick="filterSequences()">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearSequenceFilter()">
                            <i class="bi bi-x-circle"></i> Clear
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="loadSequenceSummary()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div id="sequenceSummaryContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Worker Status Tab -->
            <div class="tab-pane fade" id="worker-status" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1">Worker Status</h4>
                        <p class="text-muted mb-0">Monitor your device workers in real-time</p>
                    </div>
                    <div>
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="workerAutoRefresh">
                            <label class="form-check-label" for="workerAutoRefresh">
                                Auto-refresh (5s)
                            </label>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="loadWorkerStatus()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-success btn-sm ms-2" onclick="resumeFailedWorkers()">
                            <i class="bi bi-play-fill"></i> Resume Failed
                        </button>
                        <button class="btn btn-danger btn-sm ms-2" onclick="stopAllWorkers()">
                            <i class="bi bi-stop-fill"></i> Stop All
                        </button>
                    </div>
                </div>
                
                <!-- Filter Options -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="workerFilter" id="filterAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="filterAll">All Workers</label>
                            
                            <input type="radio" class="btn-check" name="workerFilter" id="filterCampaign" value="campaign">
                            <label class="btn btn-outline-primary" for="filterCampaign">By Campaign</label>
                            
                            <input type="radio" class="btn-check" name="workerFilter" id="filterSequence" value="sequence">
                            <label class="btn btn-outline-primary" for="filterSequence">By Sequence</label>
                        </div>
                        
                        <!-- Campaign/Sequence Selector -->
                        <div class="d-inline-block ms-3" id="filterSelector" style="display: none;">
                            <select class="form-select form-select-sm" id="filterItemId" onchange="loadWorkerStatus()">
                                <option value="">Select...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="workerStatusContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manage AI Tab -->
        <div class="tab-pane fade" id="manage-ai" role="tabpanel">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">AI Lead Management</h5>
                        <div>
                            <button class="btn btn-outline-primary" onclick="exportAILeads()">
                                <i class="bi bi-download"></i> Export
                            </button>
                            <button class="btn btn-outline-primary" onclick="importAILeads()">
                                <i class="bi bi-upload"></i> Import
                            </button>
                            <button class="btn btn-primary" onclick="showAddAILeadModal()">
                                <i class="bi bi-plus-lg"></i> Add AI Lead
                            </button>
                            <button class="btn btn-success" onclick="showCreateAICampaignModal()">
                                <i class="bi bi-broadcast"></i> Create AI Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-people"></i>
                        </div>
                        <div class="metric-value" id="aiTotalLeads">0</div>
                        <div class="metric-label">Total AI Leads</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="metric-value" id="aiPendingLeads">0</div>
                        <div class="metric-label">Pending</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-success bg-opacity-10 text-success">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="metric-value" id="aiSentLeads">0</div>
                        <div class="metric-label">Sent</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-danger bg-opacity-10 text-danger">
                            <i class="bi bi-x-circle"></i>
                        </div>
                        <div class="metric-value" id="aiFailedLeads">0</div>
                        <div class="metric-label">Failed</div>
                    </div>
                </div>
            </div>
            
            <!-- AI Leads Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="aiLeadsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Niche</th>
                                    <th>Target</th>
                                    <th>Status</th>
                                    <th>Device</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="aiLeadsTableBody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal fade qr-modal" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Scan QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="qr-container">
                        <div id="qrCode" style="width: 256px; height: 256px; margin: 0 auto; background: #f0f0f0;"></div>
                        <p class="mt-3 text-muted">Scan this QR code with WhatsApp on your phone</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Campaign Modal -->
    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="campaignModalTitle">Create Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="campaignForm">
                        <input type="hidden" id="campaignId">
                        <input type="hidden" id="campaignDate">
                        
                        <div class="mb-3">
                            <label class="form-label">Campaign Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="campaignTitle" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Niche/Category <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="campaignNiche" required 
                                   placeholder="e.g., EXSTART, ITADRESS">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Target Lead Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="campaignTargetStatus" required>
                                <option value="">Select Target Status</option>
                                <option value="prospect">Prospect</option>
                                <option value="customer">Customer</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="campaignMessage" rows="5" required 
                                      placeholder="Enter your broadcast message..."
                                      oninput="updateLivePreview()"></textarea>
                            <small class="text-muted d-block mt-1">
                                <strong>WhatsApp Formatting:</strong> 
                                *bold* | _italic_ | ~strikethrough~ | ```monospace``` | 😊 Emojis supported
                            </small>
                        </div>
                        
                        <!-- Live Preview -->
                        <div class="mb-3">
                            <label class="form-label">Live Preview</label>
                            <div class="border rounded p-3" style="background: #f0f2f5;">
                                <div class="whatsapp-preview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                    <div id="livePreviewMessage" style="white-space: pre-wrap; word-break: break-word; color: #333;">
                                        <span class="text-muted">Your formatted message will appear here...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Image (Optional)</label>
                            <input type="file" class="form-control" id="campaignImageFile" accept="image/*" onchange="compressImage(this)">
                            <small class="text-muted">Max 5MB. Will be compressed automatically.</small>
                            <input type="hidden" id="campaignImageUrl">
                            <div id="imagePreview" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Scheduled Time (Optional)</label>
                            <input type="time" class="form-control" id="campaignTime">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Min Delay (seconds)</label>
                                    <input type="number" class="form-control" id="campaignMinDelay" min="1" value="10" placeholder="10">
                                    <small class="text-muted">Minimum delay between messages</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Delay (seconds)</label>
                                    <input type="number" class="form-control" id="campaignMaxDelay" min="1" value="30" placeholder="30">
                                    <small class="text-muted">Maximum delay between messages</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCampaign()">Save Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Preview Modal -->
    <div class="modal fade" id="campaignPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Campaign Message Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Campaign Details</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Title:</strong></td>
                                    <td id="previewTitle"></td>
                                </tr>
                                <tr>
                                    <td><strong>Niche:</strong></td>
                                    <td id="previewNiche"></td>
                                </tr>
                                <tr>
                                    <td><strong>Target:</strong></td>
                                    <td id="previewTarget"></td>
                                </tr>
                                <tr>
                                    <td><strong>Date:</strong></td>
                                    <td id="previewDate"></td>
                                </tr>
                                <tr>
                                    <td><strong>Time:</strong></td>
                                    <td id="previewTime"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">WhatsApp Preview</h6>
                            <div class="border rounded p-3" style="background: #f0f2f5;">
                                <div class="whatsapp-preview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                    <div id="previewImage" class="mb-2"></div>
                                    <div id="previewMessage" style="white-space: pre-wrap; word-break: break-word;"></div>
                                    <div class="text-end mt-2">
                                        <small class="text-muted" id="previewTimestamp"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sequence Preview Modal -->
    <div class="modal fade" id="sequencePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sequence Messages Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6 class="mb-3">Sequence Details</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td width="150"><strong>Name:</strong></td>
                                    <td id="seqPreviewName"></td>
                                </tr>
                                <tr>
                                    <td><strong>Niche:</strong></td>
                                    <td id="seqPreviewNiche"></td>
                                </tr>
                                <tr>
                                    <td><strong>Target:</strong></td>
                                    <td id="seqPreviewTarget"></td>
                                </tr>
                                <tr>
                                    <td><strong>Total Days:</strong></td>
                                    <td id="seqPreviewDays"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Message Timeline</h6>
                            <div id="sequenceMessagesPreview"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Device Report Modal -->
    <div class="modal fade" id="campaignDeviceReportModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Campaign Device Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Campaign Details -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Campaign Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Title:</strong> <span id="reportTitle"></span></p>
                                    <p class="mb-1"><strong>Niche:</strong> <span id="reportNiche"></span></p>
                                    <p class="mb-1"><strong>Target:</strong> <span id="reportTarget"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Date:</strong> <span id="reportDate"></span></p>
                                    <p class="mb-1"><strong>Time:</strong> <span id="reportTime"></span></p>
                                    <p class="mb-1"><strong>Status:</strong> <span id="reportStatus"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Overall Statistics -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Overall Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h4 id="totalDevices">0</h4>
                                            <p class="mb-0">Total Devices</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-success text-white">
                                        <div class="card-body">
                                            <h4 id="activeDevices">0</h4>
                                            <p class="mb-0">Active Devices</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-danger text-white">
                                        <div class="card-body">
                                            <h4 id="disconnectedDevices">0</h4>
                                            <p class="mb-0">Disconnected</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card bg-primary text-white" style="cursor: pointer;" onclick="showAllCampaignLeads('all'); return false;">
                                        <div class="card-body">
                                            <h4 id="totalLeads">0</h4>
                                            <p class="mb-0">Total Leads</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row text-center mt-3">
                                <div class="col-md-4">
                                    <div class="card bg-warning" style="cursor: pointer;" onclick="showAllCampaignLeads('pending'); return false;">
                                        <div class="card-body">
                                            <h4 id="pendingLeads">0</h4>
                                            <p class="mb-0">Pending</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-success text-white" style="cursor: pointer;" onclick="showAllCampaignLeads('success'); return false;">
                                        <div class="card-body">
                                            <h4 id="successLeads">0</h4>
                                            <p class="mb-0">Success</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-danger text-white" style="cursor: pointer;" onclick="showAllCampaignLeads('failed'); return false;">
                                        <div class="card-body">
                                            <h4 id="failedLeads">0</h4>
                                            <p class="mb-0">Failed</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Device-wise Report -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Device-wise Report</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Device Name</th>
                                            <th>Status</th>
                                            <th>Total Leads</th>
                                            <th>Pending</th>
                                            <th>Success</th>
                                            <th>Failed</th>
                                            <th>Success Rate</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deviceReportTableBody">
                                        <!-- Device rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportDeviceReport()">
                        <i class="bi bi-download"></i> Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Details Modal -->
    <div class="modal fade" id="leadDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="leadDetailsTitle">Lead Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone Number</th>
                                    <th>Status</th>
                                    <th>Sent At</th>
                                </tr>
                            </thead>
                            <tbody id="leadDetailsTableBody">
                                <!-- Lead details will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <!-- AI Lead Modal -->
    <div class="modal fade" id="aiLeadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #20a884; color: white;">
                    <h5 class="modal-title" id="aiLeadModalTitle">Add New Lead</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="aiLeadForm">
                        <input type="hidden" id="aiLeadId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="aiLeadName" placeholder="Enter name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="aiLeadPhone" placeholder="60123456789" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Niche</label>
                                <input type="text" class="form-control" id="aiLeadNiche" placeholder="EXSTART or EXSTART,ITADRESS">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="aiLeadTargetStatus">
                                    <option value="prospect">Prospect</option>
                                    <option value="customer">Customer</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Note</label>
                            <textarea class="form-control" id="aiLeadNotes" rows="4" placeholder="Enter additional notes about this lead..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAILead()">Save Lead</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Campaign Modal -->
    <div class="modal fade" id="aiCampaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create AI Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="aiCampaignForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Campaign Date *</label>
                                    <input type="date" class="form-control" id="aiCampaignDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scheduled Time</label>
                                    <input type="time" class="form-control" id="aiCampaignTime">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Campaign Title *</label>
                            <input type="text" class="form-control" id="aiCampaignTitle" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Niche *</label>
                                    <input type="text" class="form-control" id="aiCampaignNiche" required>
                                    <small class="text-muted">Must match AI lead niches</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Status *</label>
                                    <select class="form-select" id="aiCampaignTargetStatus">
                                        <option value="prospect">Prospect</option>
                                        <option value="customer">Customer</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Device Limit per Device *</label>
                            <input type="number" class="form-control" id="aiDeviceLimit" min="1" required>
                            <small class="text-muted">Maximum leads each device can send</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Message *</label>
                            <textarea class="form-control" id="aiCampaignMessage" rows="4" required 
                                      oninput="updateAILivePreview()"></textarea>
                            <small class="text-muted d-block mt-1">
                                <strong>WhatsApp Formatting:</strong> 
                                *bold* | _italic_ | ~strikethrough~ | ```monospace``` | 😊 Emojis supported
                            </small>
                        </div>
                        
                        <!-- AI Campaign Live Preview -->
                        <div class="mb-3">
                            <label class="form-label">Live Preview</label>
                            <div class="border rounded p-3" style="background: #f0f2f5;">
                                <div class="whatsapp-preview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                    <div id="aiLivePreviewMessage" style="white-space: pre-wrap; word-break: break-word; color: #333;">
                                        <span class="text-muted">Your formatted message will appear here...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Image (Optional)</label>
                            <input type="file" class="form-control" id="aiCampaignImage" accept="image/*">
                            <small class="text-muted">Max 350KB. Will be compressed automatically.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Min Delay (seconds)</label>
                                    <input type="number" class="form-control" id="aiMinDelay" min="5" value="10">
                                    <small class="text-muted">Minimum delay between messages</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Max Delay (seconds)</label>
                                    <input type="number" class="form-control" id="aiMaxDelay" min="5" value="30">
                                    <small class="text-muted">Maximum delay between messages</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAICampaign()">Create Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Sequence Modal -->
    <div class="modal fade" id="createSequenceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Sequence</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createSequenceForm">
                        <!-- Basic Info -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Sequence Name <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="sequenceName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Sequence Tag <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="sequenceNiche" placeholder="e.g., Sales, Onboarding" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sequence Description <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="sequenceDescription" rows="2" required></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Min Delay (seconds)</label>
                                        <input type="number" class="form-control" id="sequenceMinDelay" value="5" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Max Delay (seconds)</label>
                                        <input type="number" class="form-control" id="sequenceMaxDelay" value="15" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Schedule Time</label>
                                        <input type="time" class="form-control" id="sequenceScheduleTime" value="09:00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Days Calendar Grid -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Sequence Days</h6>
                            <div class="sequence-days-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                                <!-- Days 1-31 will be generated here -->
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createSequence()">Create Sequence</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Message Modal -->
    <div class="modal fade" id="dayMessageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayMessageTitle">Day 1 Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="currentDayNumber">
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" id="dayMessageContent" rows="5" placeholder="Enter your message..." oninput="updateSequenceLivePreview()"></textarea>
                        <small class="text-muted d-block mt-1">
                            <strong>WhatsApp Formatting:</strong> 
                            *bold* | _italic_ | ~strikethrough~ | ```monospace``` | 😊 Emojis supported
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Live Preview</label>
                        <div class="border rounded p-3 bg-light" style="min-height: 100px;">
                            <div id="sequenceLivePreview" style="white-space: pre-wrap;">Your formatted message will appear here...</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Image (Optional)</label>
                        <input type="file" class="form-control" id="dayMessageImage" accept="image/*" onchange="compressDayImage(this)">
                        <small class="text-muted">Max 5MB. Will be compressed automatically.</small>
                        <input type="hidden" id="dayMessageImageUrl">
                        <div id="dayImagePreview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDayMessage()">Finish</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let messageChart;
        let currentTimeRange = 7;
        let devices = [];
        let currentDeviceFilter = 'all';
        let refreshInterval;
        let currentScanningDeviceId = null; // Track which device is being scanned
        let qrRefreshInterval = null; // Track QR refresh interval globally
        let isAutoRefreshEnabled = false;  // Default to disabled

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard v1.1.0 FINAL - All fixes applied');
            console.log('Includes: Device filter fix, auth cookies, proper function definitions');
            initializeChart();
            loadDashboardData(7);
            loadDevices();
            
            // Set max date to today for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').max = today;
            document.getElementById('endDate').max = today;
            document.getElementById('endDate').value = today;
            
            // Set start date to 7 days ago
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
            
            // Start auto-refresh only if enabled
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
            }
            
            // Set the toggle to match the current state
            document.getElementById('autoRefreshToggle').checked = isAutoRefreshEnabled;
        });

        // Initialize Chart
        function initializeChart() {
            const ctx = document.getElementById('messageChart').getContext('2d');
            messageChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Leads Sent',
                        data: [],
                        borderColor: '#128c7e',
                        backgroundColor: 'rgba(18, 140, 126, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Leads Received',
                        data: [],
                        borderColor: '#25d366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Leads Read',
                        data: [],
                        borderColor: '#34b7f1',
                        backgroundColor: 'rgba(52, 183, 241, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Leads Replied',
                        data: [],
                        borderColor: '#00a884',
                        backgroundColor: 'rgba(0, 168, 132, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Lead Activity Trends'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Leads'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        // Load Dashboard Data
        function loadDashboardData(days, silent = false) {
            if (!silent) {
                showLoading();
            }
            
            // Get user email
            const userEmail = localStorage.getItem('userEmail') || 'admin@whatsapp.com';
            
            // Build URL with device filter
            let url = `/api/analytics/${days}`;
            if (currentDeviceFilter && currentDeviceFilter !== 'all') {
                url += `?device=${currentDeviceFilter}`;
            }
            
            // Fetch real data from API
            fetch(url, {
                credentials: 'include',
                headers: {
                    'X-User-Email': userEmail
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        updateMetrics(data.results.metrics);
                        updateChart(data.results.daily);
                    }
                    if (!silent) {
                        hideLoading();
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                    // Fallback to mock data
                    const mockData = generateMockData(days);
                    updateMetrics(mockData.metrics);
                    updateChart(mockData.daily);
                    if (!silent) {
                        hideLoading();
                    }
                });
        }

        // Generate Mock Data
        function generateMockData(days) {
            const leadsSent = Math.floor(Math.random() * 1000) + 500;
            const leadsReceived = Math.floor(leadsSent * 0.8); // 80% received
            const leadsNotReceived = leadsSent - leadsReceived;
            const leadsRead = Math.floor(leadsReceived * 0.7); // 70% of received are read
            const leadsNotRead = leadsReceived - leadsRead;
            const leadsReplied = Math.floor(leadsRead * 0.5); // 50% of read are replied
            
            const metrics = {
                activeDevices: devices.filter(d => d.status === 'online').length,
                inactiveDevices: devices.filter(d => d.status === 'offline').length,
                leadsSent: leadsSent,
                leadsReceived: leadsReceived,
                leadsNotReceived: leadsNotReceived,
                leadsRead: leadsRead,
                leadsNotRead: leadsNotRead,
                leadsReplied: leadsReplied
            };

            const daily = [];
            const today = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                daily.push({
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    sent: Math.floor(Math.random() * 100) + 20,
                    received: Math.floor(Math.random() * 80) + 15,
                    read: Math.floor(Math.random() * 60) + 10,
                    replied: Math.floor(Math.random() * 30) + 5
                });
            }

            return { metrics, daily };
        }

        // Update Metrics
        function updateMetrics(metrics) {
            // Device metrics - Calculate from loaded devices
            const activeCount = devices.filter(d => d.status === 'online').length;
            const inactiveCount = devices.filter(d => d.status !== 'online').length;
            
            document.getElementById('activeDevices').textContent = activeCount;
            document.getElementById('inactiveDevices').textContent = inactiveCount;
            
            // Lead metrics
            document.getElementById('leadsSent').textContent = metrics.leadsSent || 0;
            document.getElementById('leadsReceived').textContent = metrics.leadsReceived || 0;
            document.getElementById('leadsNotReceived').textContent = metrics.leadsNotReceived || 0;
            document.getElementById('leadsRead').textContent = metrics.leadsRead || 0;
            document.getElementById('leadsNotRead').textContent = metrics.leadsNotRead || 0;
            document.getElementById('leadsReplied').textContent = metrics.leadsReplied || 0;
            
            // Calculate and update percentages
            const totalLeads = metrics.leadsSent || 1; // Avoid division by zero
            
            const receivedPercent = Math.round((metrics.leadsReceived / totalLeads) * 100);
            const notReceivedPercent = Math.round((metrics.leadsNotReceived / totalLeads) * 100);
            const readPercent = Math.round((metrics.leadsRead / totalLeads) * 100);
            const notReadPercent = Math.round((metrics.leadsNotRead / totalLeads) * 100);
            const repliedPercent = Math.round((metrics.leadsReplied / totalLeads) * 100);
            
            document.getElementById('leadsReceivedPercent').textContent = receivedPercent + '%';
            document.getElementById('leadsNotReceivedPercent').textContent = notReceivedPercent + '%';
            document.getElementById('leadsReadPercent').textContent = readPercent + '%';
            document.getElementById('leadsNotReadPercent').textContent = notReadPercent + '%';
            document.getElementById('leadsRepliedPercent').textContent = repliedPercent + '%';
        }
        // Update Chart
        function updateChart(dailyData) {
            const labels = dailyData.map(d => d.date);
            const sentData = dailyData.map(d => d.sent || 0);
            const receivedData = dailyData.map(d => d.received || 0);
            const readData = dailyData.map(d => d.read || 0);
            const repliedData = dailyData.map(d => d.replied || 0);

            messageChart.data.labels = labels;
            messageChart.data.datasets[0].data = sentData;
            messageChart.data.datasets[1].data = receivedData;
            messageChart.data.datasets[2].data = readData;
            messageChart.data.datasets[3].data = repliedData;
            messageChart.update();
        }

        // Change Time Range
        function changeTimeRange(days) {
            // Hide custom date range if visible
            document.getElementById('customDateRange').classList.add('d-none');
            
            // Update button states
            document.querySelectorAll('.time-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (days === 'today') {
                currentTimeRange = 1;
                loadDashboardData(1);
            } else {
                currentTimeRange = days;
                loadDashboardData(days);
            }
        }

        // Show Custom Date Range
        function showCustomDateRange() {
            document.getElementById('customDateRange').classList.remove('d-none');
            
            // Update button states
            document.querySelectorAll('.time-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Hide Custom Date Range
        function hideCustomDateRange() {
            document.getElementById('customDateRange').classList.add('d-none');
            
            // Reset to 7 days
            document.querySelectorAll('.time-toggle .btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('7 Days')) {
                    btn.classList.add('active');
                }
            });
            changeTimeRange(7);
        }

        // Apply Custom Date Range
        function applyCustomDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                alert('Start date must be before end date');
                return;
            }
            
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            // Load data for custom range
            loadDashboardDataCustomRange(startDate, endDate, days);
            
            // Update display
            document.getElementById('customDateRange').classList.add('d-none');
        }

        // Load Dashboard Data with Custom Range
        function loadDashboardDataCustomRange(startDate, endDate, days, silent = false) {
            if (!silent) {
                showLoading();
            }
            
            // Get user email
            const userEmail = localStorage.getItem('userEmail') || 'admin@whatsapp.com';
            
            // Build URL with device filter
            let url = `/api/analytics/custom?start=${startDate}&end=${endDate}`;
            if (currentDeviceFilter && currentDeviceFilter !== 'all') {
                url += `&device=${currentDeviceFilter}`;
            }
            
            // Fetch real data from API
            fetch(url, {
                credentials: 'include',
                headers: {
                    'X-User-Email': userEmail
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        updateMetrics(data.results.metrics);
                        updateChart(data.results.daily);
                    }
                    if (!silent) {
                        hideLoading();
                    }
                })
                .catch(error => {
                    console.error('Error loading custom analytics:', error);
                    // Fallback to mock data
                    const mockData = generateMockDataForRange(startDate, endDate, days || 30);
                    updateMetrics(mockData.metrics);
                    updateChart(mockData.daily);
                    if (!silent) {
                        hideLoading();
                    }
                });
        }

        // Generate Mock Data for Date Range
        function generateMockDataForRange(startDate, endDate, days) {
            const metrics = {
                totalSent: Math.floor(Math.random() * 1000 * (days / 30)) + 500,
                totalReceived: Math.floor(Math.random() * 800 * (days / 30)) + 400,
                activeChats: Math.floor(Math.random() * 50) + 10,
                replyRate: Math.floor(Math.random() * 30) + 70
            };

            const daily = [];
            const start = new Date(startDate);
            
            for (let i = 0; i < days; i++) {
                const date = new Date(start);
                date.setDate(start.getDate() + i);
                
                daily.push({
                    date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                    sent: Math.floor(Math.random() * 100) + 20,
                    received: Math.floor(Math.random() * 80) + 15
                });
            }

            return { metrics, daily };
        }

        // Load Devices
        function loadDevices(silent = false) {
            // First try to check real-time connection status (optional)
            fetch('/api/devices/check-connection', { credentials: 'include' })
                .then(response => {
                    // If check-connection fails, just continue
                    if (!response.ok) {
                        console.log('Check-connection endpoint not available, continuing...');
                    }
                    return response.ok ? response.json() : null;
                })
                .then(statusData => {
                    // Connection status checked (or skipped), now load devices
                    return fetch('/api/devices', { credentials: 'include' });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch devices');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.code === 'SUCCESS' && Array.isArray(data.results)) {
                        devices = data.results;
                    } else {
                        // Initialize with empty array instead of mock device
                        devices = [];
                    }
                    renderDevices();
                })
                .catch(error => {
                    if (!silent) {
                        console.error('Error loading devices:', error);
                    }
                    // Initialize with empty array on error
                    devices = [];
                    renderDevices();
                });
        }

        // Render Devices
        function renderDevices() {
            const devicesGrid = document.getElementById('devicesGrid');
            const emptyState = document.getElementById('emptyDeviceState');
            
            // Clear grid
            devicesGrid.innerHTML = '';
            
            // Check if we have devices
            if (!devices || devices.length === 0) {
                devicesGrid.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                devicesGrid.style.display = '';
                emptyState.style.display = 'none';
                
                // Add existing devices
                devices.forEach(device => {
                    const deviceCard = createDeviceCard(device);
                    devicesGrid.insertAdjacentHTML('beforeend', deviceCard);
                });
            }
            
            // Update device filter dropdown
            updateDeviceFilter();
        }

        // Create Device Card
        function createDeviceCard(device) {
            const isConnected = device.status === 'online';
            const phoneDisplay = device.phone && device.phone !== 'Not connected' ? device.phone : null;
            
            return `
                <div class="col-lg-2 col-md-4 col-sm-6">
                    <div class="device-card ${isConnected ? 'connected' : ''}">
                        <!-- Card Header -->
                        <div class="d-flex flex-column align-items-center text-center mb-3">
                            <div class="device-icon mb-2">
                                <i class="bi bi-phone-fill" style="font-size: 24px; color: ${isConnected ? 'var(--success)' : '#6c757d'};"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">${device.name}</h6>
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="device-status ${device.status}"></span>
                                    <span class="text-muted small">${isConnected ? 'Connected' : 'Disconnected'}</span>
                                </div>
                            </div>
                            <div class="dropdown position-absolute top-0 end-0 m-2">
                                <button class="btn btn-sm btn-light p-1" type="button" data-bs-toggle="dropdown" style="width: 24px; height: 24px;">
                                    <i class="bi bi-three-dots-vertical" style="font-size: 12px;"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="editDevice('${device.id}')">
                                        <i class="bi bi-pencil me-2"></i>Rename
                                    </a></li>
                                    ${isConnected ? `
                                        <li><a class="dropdown-item" href="#" onclick="viewDeviceStats('${device.id}')">
                                            <i class="bi bi-graph-up me-2"></i>View Analytics
                                        </a></li>
                                        <li><a class="dropdown-item text-success" href="#" onclick="refreshDevice('${device.id}')">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="logoutDevice('${device.id}')">
                                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                                        </a></li>
                                        
                                    ` : ''}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteDevice('${device.id}')">
                                        <i class="bi bi-trash me-2"></i>Delete Device
                                    </a></li>
                                </ul>
                            </div>
                        </div>

                        <!-- Phone Number Section -->
                        ${phoneDisplay ? `
                            <div class="mb-2 text-center">
                                <small class="text-muted d-block" style="font-size: 11px;">${phoneDisplay}</small>
                            </div>
                        ` : ''}

                        <!-- Action Buttons -->
                        <div class="d-grid gap-1">
                            ${!isConnected ? `
                                <button class="btn btn-primary btn-sm" onclick="scanQR('${device.id}')">
                                    <i class="bi bi-qr-code"></i> QR
                                </button>
                                <button class="btn btn-info btn-sm" onclick="deviceLeads('${device.id}')">
                                    <i class="bi bi-people"></i> Leads
                                </button>
                            ` : `
                                <button class="btn btn-success btn-sm mb-1" onclick="openWhatsAppWeb('${device.id}')">
                                    <i class="bi bi-whatsapp"></i> WA
                                </button>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-outline-primary" onclick="deviceActions('${device.id}')" title="Actions">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="deviceLeads('${device.id}')" title="Leads">
                                        <i class="bi bi-people"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="viewDeviceStats('${device.id}')" title="Stats">
                                        <i class="bi bi-graph-up"></i>
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Add New Device
        function addNewDevice() {
            // Use SweetAlert for better input handling
            Swal.fire({
                title: 'Add New WhatsApp Device',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label for="deviceName" class="form-label">Device Name</label>
                            <input type="text" id="deviceName" class="form-control" placeholder="e.g., My Phone, Office WhatsApp">
                        </div>
                        <div class="mb-3">
                            <label for="devicePhone" class="form-label">WhatsApp Phone Number</label>
                            <input type="text" id="devicePhone" class="form-control" placeholder="60123456789" maxlength="15">
                            <small class="text-muted">Enter number with country code (without + sign). Must start with 60 for Malaysia.</small>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Add Device',
                cancelButtonText: 'Cancel',
                focusConfirm: false,
                preConfirm: () => {
                    const deviceName = document.getElementById('deviceName').value;
                    const devicePhone = document.getElementById('devicePhone').value;
                    
                    if (!deviceName) {
                        Swal.showValidationMessage('Please enter a device name');
                        return false;
                    }
                    
                    if (!devicePhone) {
                        Swal.showValidationMessage('Please enter a phone number');
                        return false;
                    }
                    
                    // Validate phone number format (must start with 60 and be 10-12 digits)
                    if (!devicePhone.startsWith('60')) {
                        Swal.showValidationMessage('Phone number must start with 60 (Malaysia country code)');
                        return false;
                    }
                    
                    if (devicePhone.length < 10 || devicePhone.length > 12) {
                        Swal.showValidationMessage('Phone number must be 10-12 digits');
                        return false;
                    }
                    
                    if (!/^\d+$/.test(devicePhone)) {
                        Swal.showValidationMessage('Phone number must contain only digits');
                        return false;
                    }
                    
                    return { deviceName, devicePhone };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { deviceName, devicePhone } = result.value;
                    
                    // Generate a proper UUID for the device
                    function generateUUID() {
                        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                            return v.toString(16);
                        });
                    }
                    
                    // Create device object with proper UUID
                    const newDevice = {
                        id: generateUUID(),
                        name: deviceName,
                        phone: devicePhone,
                        status: 'offline',
                        lastSeen: 'Never connected'
                    };
                    
                    // Add to devices array
                    devices.push(newDevice);
                    
                    // Save to backend with phone number
                    fetch('/api/devices', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name: deviceName,
                            phone: devicePhone 
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'SUCCESS' && data.results && data.results.device) {
                            // Update with real ID from backend
                            const index = devices.findIndex(d => d.id === newDevice.id);
                            if (index !== -1) {
                                devices[index] = {
                                    id: data.results.device.id,
                                    name: data.results.device.name,
                                    phone: data.results.device.phone,
                                    status: data.results.device.status,
                                    lastSeen: data.results.device.lastSeen
                                };
                            }
                            
                            // Store phone number mapping for connection
                            localStorage.setItem(`device_phone_${devicePhone}`, data.results.device.id);
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Device Added!',
                                text: `Device "${deviceName}" has been added. You can now connect it by scanning QR code.`,
                                timer: 3000,
                                showConfirmButton: false
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error saving device:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to save device. Please try again.'
                        });
                    });
                    
                    // Render devices to show the new device card
                    renderDevices();
                }
            });
        }

        // Scan QR Code
        function scanQR(deviceId) {
            currentScanningDeviceId = deviceId; // Track which device is being scanned
            const modal = new bootstrap.Modal(document.getElementById('qrModal'));
            modal.show();
            
            // Show loading spinner
            const qrContainer = document.getElementById('qrCode');
            qrContainer.innerHTML = `
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading QR Code...</span>
                    </div>
                </div>
            `;
            
            // Get QR code from WhatsApp login endpoint
            fetch(`/app/login?deviceId=${deviceId}`, {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.qr_link) {
                        // Display QR code with proper styling
                        qrContainer.innerHTML = `
                            <div class="text-center">
                                <img src="${data.results.qr_link}" 
                                     alt="WhatsApp QR Code" 
                                     class="img-fluid"
                                     style="max-width: 256px; max-height: 256px; width: 100%; height: auto; background: white; padding: 10px; border-radius: 8px;"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjZjBmMGYwIi8+CiAgICA8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZpbGw9IiM5OTkiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCI+UVIgQ29kZSBFcnJvcjwvdGV4dD4KPC9zdmc+'; alert('QR code failed to load. Please try again.');">
                                <p class="mt-3 text-muted small">
                                    Open WhatsApp on your phone<br>
                                    Settings > Linked Devices > Link a Device
                                </p>
                                <div class="alert alert-info mt-3">
                                    <small><strong>Note:</strong> If QR code doesn't work, close this modal and try the <strong>Phone Code</strong> option instead.</small>
                                </div>
                            </div>
                        `;
                        
                        // Set up auto-refresh every 20 seconds
                        qrRefreshInterval = setInterval(() => {
                            fetch(`/app/login?deviceId=${deviceId}`, {
                                credentials: 'include'
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.results && data.results.qr_link) {
                                        qrContainer.querySelector('img').src = data.results.qr_link + '?t=' + Date.now();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error refreshing QR code:', error);
                                });
                        }, 20000); // Refresh every 20 seconds
                        
                        // Clear interval when modal is closed
                        document.getElementById('qrModal').addEventListener('hidden.bs.modal', function () {
                            if (qrRefreshInterval) {
                                clearInterval(qrRefreshInterval);
                                qrRefreshInterval = null;
                            }
                        }, { once: true });
                    } else {
                        qrContainer.innerHTML = `
                            <div class="text-center">
                                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 48px;"></i>
                                <p class="mt-2">Failed to load QR code</p>
                                <button class="btn btn-sm btn-primary" onclick="scanQR(${deviceId})">Retry</button>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading QR code:', error);
                    qrContainer.innerHTML = `
                        <div class="text-center">
                            <i class="bi bi-wifi-off text-danger" style="font-size: 48px;"></i>
                            <p class="mt-2">Connection error</p>
                            <button class="btn btn-sm btn-primary" onclick="scanQR(${deviceId})">Retry</button>
                        </div>
                    `;
                });
        }

        // Logout Device (properly clears session)
        function logoutDevice(deviceId) {
            Swal.fire({
                title: 'Logout Device?',
                html: `
                    <div class="text-start">
                        <p>This will disconnect the device from WhatsApp and clear its session.</p>
                        <p class="text-warning mb-0"><i class="bi bi-exclamation-triangle me-2"></i>You will need to scan the QR code again to reconnect.</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    // Set a timeout to hide loading in case of any issues
                    const loadingTimeout = setTimeout(() => {
                        hideLoading();
                        showToast('Operation is taking longer than expected...', 'warning');
                    }, 15000); // 15 seconds timeout
                    
                    // Use the new clear-session endpoint that properly clears WhatsApp tables
                    fetch(`/api/devices/${deviceId}/clear-session`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        clearTimeout(loadingTimeout);
                        hideLoading();
                        
                        if (data.code === 'SUCCESS') {
                            // Update device status
                            const device = devices.find(d => d.id === deviceId);
                            if (device) {
                                device.status = 'offline';
                                // Keep phone and JID for reconnection
                                device.lastSeen = new Date().toISOString();
                            }
                            renderDevices();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Device Logged Out!',
                                text: 'The device has been disconnected and session cleared. You can now scan QR code to connect again.',
                                timer: 3000,
                                showConfirmButton: false
                            });
                            
                            // Refresh devices
                            setTimeout(loadDevices, 2000);
                        } else {
                            throw new Error(data.message || 'Failed to clear session');
                        }
                    })
                    .catch(error => {
                        clearTimeout(loadingTimeout);
                        console.error('Error clearing session:', error);
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'Operation Failed',
                            text: error.message || 'Failed to logout device. Please try again.'
                        });
                    });
                }
            });
        }

        // Refresh Device (reconnect existing session)
        function refreshDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            Swal.fire({
                title: 'Refresh Device Connection?',
                html: `
                    <div class="text-start">
                        <p>This will attempt to reconnect the device using its existing session.</p>
                        <p class="text-info mb-0"><i class="bi bi-info-circle me-2"></i>The device must still be linked in WhatsApp for this to work.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Refresh',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#198754'
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    // Show progress toast
                    showToast('Attempting to reconnect device...', 'info');
                    
                    // First try to reconnect with existing session
                    fetch(`/api/devices/${deviceId}/reconnect`, {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        hideLoading();
                        
                        if (data.code === 'ALREADY_CONNECTED' || data.code === 'SUCCESS') {
                            // Successfully reconnected
                            Swal.fire({
                                icon: 'success',
                                title: 'Device Reconnected!',
                                text: data.message || 'The device has been successfully reconnected.',
                                timer: 3000,
                                showConfirmButton: false
                            });
                            
                            // Update device status
                            device.status = 'online';
                            device.lastSeen = new Date().toISOString();
                            renderDevices();
                            
                            // Refresh devices list to get updated status
                            setTimeout(loadDevices, 2000);
                        } else if (data.code === 'QR_REQUIRED') {
                            // Session expired or not found, needs QR scan
                            Swal.fire({
                                icon: 'info',
                                title: 'QR Scan Required',
                                text: data.message || 'The WhatsApp session was not found. Please scan the QR code.',
                                confirmButtonText: 'Scan QR Code'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    scanQR(deviceId);
                                }
                            });
                        } else if (data.code === 'NO_SESSION') {
                            // No previous session
                            Swal.fire({
                                icon: 'warning',
                                title: 'No Previous Session',
                                text: 'This device has never been connected. Please scan QR code to connect.',
                                confirmButtonText: 'Scan QR Code'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    scanQR(deviceId);
                                }
                            });
                        } else {
                            throw new Error(data.message || 'Failed to refresh device');
                        }
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error refreshing device:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Refresh Failed',
                            text: error.message || 'Failed to refresh device connection. Please try again.'
                        });
                    });
                }
            });
        }

        // Clear Device Data
        function clearDeviceData(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            if (confirm(`Are you sure you want to clear all WhatsApp data for device "${device.device_name}"? This will disconnect the device and remove all stored data.`)) {
                showLoading();
                
                fetch(`/api/devices/${deviceId}/clear`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        // Update device status
                        device.status = 'disconnected';
                        device.phone = '';
                        device.jid = '';
                        renderDevices();
                        showAlert('success', `Device "${device.device_name}" data cleared successfully. You can now scan a new QR code.`);
                    } else {
                        showAlert('danger', data.message || 'Failed to clear device data');
                    }
                    hideLoading();
                })
                .catch(error => {
                    console.error('Error clearing device data:', error);
                    showAlert('danger', 'Error clearing device data');
                    hideLoading();
                });
            }
        }

        // Delete Device
        function deleteDevice(deviceId) {
            // Count leads for this device first
            fetch(`/api/devices/${deviceId}/leads`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    let leadCount = 0;
                    if (data.results && Array.isArray(data.results)) {
                        leadCount = data.results.length;
                    }
                    
                    // Get device name for better UX
                    const device = devices.find(d => d.id === deviceId);
                    const deviceName = device ? device.name : 'this device';
                    
                    let confirmHtml = `
                        <div class="text-start">
                            <p>Are you sure you want to delete <strong>${deviceName}</strong>?</p>
                            ${leadCount > 0 ? `
                                <div class="alert alert-warning mt-3">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>WARNING:</strong> This device has <strong>${leadCount} leads</strong> that will also be deleted!
                                </div>
                            ` : ''}
                            <p class="text-danger mb-0"><small>This action cannot be undone.</small></p>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: 'Delete Device?',
                        html: confirmHtml,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Delete',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#dc3545',
                        focusCancel: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            showLoading();
                            
                            fetch(`/api/devices/${deviceId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 'SUCCESS') {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Device Deleted!',
                                        text: `${deviceName} has been deleted${leadCount > 0 ? ` along with ${leadCount} leads` : ''}.`,
                                        timer: 3000,
                                        showConfirmButton: false
                                    });
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Deletion Failed',
                                        text: data.message || 'Failed to delete device'
                                    });
                                }
                                hideLoading();
                            })
                            .catch(error => {
                                console.error('Error deleting device:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to delete device. Please try again.'
                                });
                                hideLoading();
                            });
                        }
                    });
                })
                .catch(error => {
                    // If we can't get lead count, still allow deletion with basic warning
                    const device = devices.find(d => d.id === deviceId);
                    const deviceName = device ? device.name : 'this device';
                    
                    Swal.fire({
                        title: 'Delete Device?',
                        html: `
                            <div class="text-start">
                                <p>Are you sure you want to delete <strong>${deviceName}</strong>?</p>
                                <p class="text-warning"><i class="bi bi-exclamation-triangle me-2"></i>All associated leads will also be deleted.</p>
                                <p class="text-danger mb-0"><small>This action cannot be undone.</small></p>
                            </div>
                        `,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, Delete',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: '#dc3545',
                        focusCancel: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            showLoading();
                            
                            fetch(`/api/devices/${deviceId}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 'SUCCESS') {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Device Deleted!',
                                        text: 'Device and all associated data deleted successfully.',
                                        timer: 3000,
                                        showConfirmButton: false
                                    });
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Deletion Failed',
                                        text: data.message || 'Failed to delete device'
                                    });
                                }
                                hideLoading();
                            })
                            .catch(error => {
                                console.error('Error deleting device:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Failed to delete device. Please try again.'
                                });
                                hideLoading();
                            });
                        }
                    });
                });
        }
        
        // Link Phone Number to Device
        function linkPhoneNumber(deviceId) {
            const phone = prompt('Enter WhatsApp phone number (with country code, e.g., +1234567890):');
            if (phone) {
                fetch('/app/link-device', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        phone: phone
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update phone display
                        document.getElementById(`phone-${deviceId}`).textContent = phone;
                        // Update device in array
                        const device = devices.find(d => d.id === deviceId);
                        if (device) {
                            device.phone = phone;
                        }
                        alert('Phone number linked successfully!');
                    } else {
                        alert('Failed to link phone number: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error linking phone:', error);
                    alert('Failed to link phone number');
                });
            }
        }

        // Use Phone Code (for linking without QR)
        function usePhoneCode(deviceId) {
            // Malaysian phone format helper
            const formatPhoneNumber = (phone) => {
                // Remove all non-numeric characters
                phone = phone.replace(/\D/g, '');
                
                // Handle Malaysian numbers
                if (phone.startsWith('60')) {
                    return '+' + phone; // Already has country code
                } else if (phone.startsWith('0')) {
                    return '+60' + phone.substring(1); // Malaysian number without country code
                } else if (phone.startsWith('1')) {
                    return '+60' + phone; // Malaysian mobile number without leading 0
                } else {
                    return '+' + phone; // Assume it's already formatted
                }
            };
            
            const phone = prompt('Enter your WhatsApp phone number:\n\nMalaysia: 0123456789 or 60123456789\nOther countries: Include country code (e.g., +1234567890)');
            if (phone) {
                const formattedPhone = formatPhoneNumber(phone);
                
                // Show loading
                const loadingModal = `
                    <div class="modal fade" id="phoneCodeLoadingModal" tabindex="-1" data-bs-backdrop="static">
                        <div class="modal-dialog modal-dialog-centered modal-sm">
                            <div class="modal-content">
                                <div class="modal-body text-center p-4">
                                    <div class="spinner-border text-primary mb-3" role="status">
                                        <span class="visually-hidden">Getting code...</span>
                                    </div>
                                    <p class="mb-0">Getting pairing code for<br><strong>${formattedPhone}</strong></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to body if not exists
                if (!document.getElementById('phoneCodeLoadingModal')) {
                    document.body.insertAdjacentHTML('beforeend', loadingModal);
                }
                
                const loadingModalEl = new bootstrap.Modal(document.getElementById('phoneCodeLoadingModal'));
                loadingModalEl.show();
                
                fetch(`/app/login-with-code?phone=${encodeURIComponent(formattedPhone)}`, {
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingModalEl.hide();
                    
                    if (data.results && data.results.pair_code) {
                        // Show success modal with code
                        const successModal = `
                            <div class="modal fade" id="pairCodeModal" tabindex="-1">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header bg-success text-white">
                                            <h5 class="modal-title">
                                                <i class="bi bi-check-circle me-2"></i>
                                                Pairing Code Generated
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="text-center mb-4">
                                                <h1 class="display-4 fw-bold text-primary">${data.results.pair_code}</h1>
                                                <p class="text-muted">Your WhatsApp pairing code</p>
                                            </div>
                                            <div class="alert alert-info">
                                                <h6 class="alert-heading">How to use this code:</h6>
                                                <ol class="mb-0">
                                                    <li>Open WhatsApp on your phone</li>
                                                    <li>Go to <strong>Settings > Linked Devices</strong></li>
                                                    <li>Tap <strong>"Link a Device"</strong></li>
                                                    <li>Choose <strong>"Link with phone number instead"</strong></li>
                                                    <li>Enter this code: <strong>${data.results.pair_code}</strong></li>
                                                </ol>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary" onclick="linkPhoneNumber('${deviceId}')">
                                                <i class="bi bi-link-45deg"></i> Link Phone Number
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Add modal to body if not exists
                        if (!document.getElementById('pairCodeModal')) {
                            document.body.insertAdjacentHTML('beforeend', successModal);
                        }
                        
                        const successModalEl = new bootstrap.Modal(document.getElementById('pairCodeModal'));
                        successModalEl.show();
                    } else {
                        alert('Failed to generate pairing code: ' + (data.error || data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    loadingModalEl.hide();
                    console.error('Error getting pair code:', error);
                    alert('Failed to generate pairing code. Please check your phone number format and try again.');
                });
            }
        }

        // View Device Statistics
        function viewDeviceStats(deviceId) {
            // Switch to dashboard tab and filter by this device
            currentDeviceFilter = deviceId;
            document.getElementById('deviceFilter').value = deviceId;
            
            // Switch to dashboard tab
            const dashboardTab = document.getElementById('dashboard-tab');
            dashboardTab.click();
            
            // Reload dashboard data for this device
            loadDashboardData(currentTimeRange);
        }

        // Edit Device
        function editDevice(deviceId) {
            const device = devices.find(d => d.id === deviceId);
            if (!device) return;
            
            Swal.fire({
                title: 'Edit Device',
                html: `
                    <div class="text-start">
                        <div class="mb-3">
                            <label for="editDeviceName" class="form-label">Device Name</label>
                            <input type="text" class="form-control" id="editDeviceName" value="${device.name || ''}" placeholder="Enter device name">
                        </div>
                        <div class="mb-3">
                            <label for="editDevicePhone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="editDevicePhone" value="${device.phone || ''}" placeholder="Enter phone number">
                            <small class="text-muted">Note: Changing phone number won't reconnect WhatsApp. Use logout and scan QR again.</small>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const name = document.getElementById('editDeviceName').value.trim();
                    const phone = document.getElementById('editDevicePhone').value.trim();
                    
                    if (!name) {
                        Swal.showValidationMessage('Device name is required');
                        return false;
                    }
                    
                    return { name, phone };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const { name, phone } = result.value;
                    
                    // Update device info via API
                    fetch(`/api/devices/${deviceId}`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, phone })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'SUCCESS') {
                            // Update local device data
                            device.name = name;
                            device.phone = phone;
                            renderDevices();
                            
                            showAlert('success', 'Device updated successfully');
                        } else {
                            showAlert('danger', data.message || 'Failed to update device');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating device:', error);
                        showAlert('danger', 'Error updating device');
                    });
                }
            });
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/logout';
            }
        }

        // Show/Hide Loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // WebSocket Connection for Real-time Updates
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // Handle different message types
                    switch(data.code) {
                        case 'LOGIN_SUCCESS':
                            // Device paired successfully (but not fully connected yet)
                            console.log('Device paired:', data.message);
                            // Don't close modal yet, wait for full connection
                            break;
                        case 'DEVICE_CONNECTED':
                            // Device fully connected and logged in
                            console.log('Device fully connected:', data.message);
                            console.log('Full data received:', data);
                            
                            // Extract phone, JID, and device ID from the message (note: backend sends 'result' not 'results')
                            const deviceInfo = data.result || {};
                            const phone = deviceInfo.phone || '';
                            const jid = deviceInfo.jid || '';
                            const deviceId = deviceInfo.deviceId || '';
                            
                            console.log('Device info:', { phone, jid, deviceId });
                            
                            // Close QR modal if open
                            const qrModal = bootstrap.Modal.getInstance(document.getElementById('qrModal'));
                            if (qrModal) {
                                qrModal.hide();
                            }
                            
                            // Clear QR refresh interval to stop generating new QR codes
                            if (qrRefreshInterval) {
                                clearInterval(qrRefreshInterval);
                                qrRefreshInterval = null;
                                console.log('Cleared QR refresh interval');
                            }
                            
                            // Update device status immediately in UI by phone number
                            if (phone) {
                                updateDeviceStatusByPhone(phone, 'online');
                            } else if (deviceId) {
                                // Fallback to deviceId if phone not available
                                updateDeviceStatus(deviceId, 'online');
                            }
                            
                            // Show interactive SweetAlert with device info and save option
                            let timerInterval;
                            Swal.fire({
                                icon: 'success',
                                title: 'WhatsApp Connected!',
                                html: `
                                    <div style="text-align: left;">
                                        <p><strong>Connection Details:</strong></p>
                                        <table style="width: 100%; font-size: 14px;">
                                            <tr>
                                                <td style="padding: 5px;"><strong>Device ID:</strong></td>
                                                <td style="padding: 5px; font-family: monospace; font-size: 12px;">${deviceId || 'Not available'}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px;"><strong>Phone:</strong></td>
                                                <td style="padding: 5px;">${phone || 'Not available'}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px;"><strong>JID:</strong></td>
                                                <td style="padding: 5px; font-family: monospace; font-size: 12px;">${jid || 'Not available'}</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 5px;"><strong>Status:</strong></td>
                                                <td style="padding: 5px; color: green;">Online</td>
                                            </tr>
                                        </table>
                                        <hr>
                                        <p style="text-align: center;">Page will reload in <b></b> seconds.</p>
                                    </div>
                                `,
                                timer: 5000,
                                timerProgressBar: true,
                                showConfirmButton: true,
                                confirmButtonText: 'Save & Reload Now',
                                allowOutsideClick: false,
                                didOpen: () => {
                                    const b = Swal.getHtmlContainer().querySelector('b');
                                    timerInterval = setInterval(() => {
                                        b.textContent = Math.ceil(Swal.getTimerLeft() / 1000);
                                    }, 100);
                                    
                                    // Store device info in localStorage for later use if needed
                                    if (deviceId) {
                                        const deviceData = {
                                            deviceId: deviceId,
                                            phone: phone,
                                            jid: jid,
                                            status: 'online',
                                            connectedAt: new Date().toISOString()
                                        };
                                        localStorage.setItem(`device_${deviceId}`, JSON.stringify(deviceData));
                                        console.log('Device info saved:', deviceData);
                                    }
                                },
                                willClose: () => {
                                    clearInterval(timerInterval);
                                }
                            }).then((result) => {
                                // Update device list without reloading
                                const device = devices.find(d => d.id === deviceId || d.id === currentScanningDeviceId);
                                if (device) {
                                    device.status = 'online';
                                    device.phone = phone;
                                    device.jid = jid;
                                    device.lastSeen = new Date().toISOString();
                                    renderDevices();
                                }
                                
                                // Load devices to get fresh data
                                loadDevices();
                                
                                // Show success message
                                showAlert('success', 'Device connected successfully! You can now use WhatsApp.');
                            });
                            
                            break;
                        case 'DEVICE_STATUS':
                            updateDeviceStatus(data.deviceId, data.status);
                            break;
                        case 'NEW_MESSAGE':
                            // Update metrics in real-time
                            if (currentTimeRange === 1 || currentTimeRange === 7) {
                                loadDashboardData(currentTimeRange);
                            }
                            break;
                        case 'DEVICE_LOGGED_OUT':
                            // Update device status to offline when logged out
                            console.log('Device logged out:', data.result);
                            const loggedOutPhone = data.result?.phone;
                            const loggedOutDeviceId = data.result?.deviceId;
                            
                            // Try to update by phone number first (like QR scan does)
                            if (loggedOutPhone) {
                                // Update status but KEEP phone number for reconnection
                                const device = devices.find(d => d.phone === loggedOutPhone);
                                if (device) {
                                    device.status = 'offline';
                                    // Keep phone and JID for easier reconnection
                                    device.lastSeen = new Date().toISOString();
                                    renderDevices();
                                    console.log(`Updated device with phone ${loggedOutPhone} to offline status`);
                                }
                            } else if (loggedOutDeviceId) {
                                // Fallback to device ID if phone not available
                                const device = devices.find(d => d.id === loggedOutDeviceId);
                                if (device) {
                                    device.status = 'offline';
                                    // Keep phone and JID for easier reconnection
                                    device.lastSeen = new Date().toISOString();
                                    renderDevices();
                                    
                                    // Show notification
                                    showAlert('warning', `Device ${device.name} has been logged out`);
                                }
                            }
                            break;
                    }
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
            
            ws.onclose = function() {
                // Reconnect after 5 seconds
                setTimeout(connectWebSocket, 5000);
            };
        }

        // Update Device Status
        function updateDeviceStatus(deviceId, status) {
            const device = devices.find(d => d.id === deviceId);
            if (device) {
                device.status = status;
                device.lastSeen = status === 'online' ? 'Active now' : 'Just now';
                renderDevices();
            }
        }
        
        // Update Device Status by Phone Number
        function updateDeviceStatusByPhone(phone, status) {
            const device = devices.find(d => d.phone === phone);
            if (device) {
                device.status = status;
                device.lastSeen = status === 'online' ? 'Active now' : 'Just now';
                renderDevices();
                console.log(`Updated device with phone ${phone} to status: ${status}`);
            } else {
                console.log(`No device found with phone ${phone}`);
                // Log all devices for debugging
                console.log('Current devices:', devices.map(d => ({ id: d.id, phone: d.phone, name: d.name })));
            }
        }

        // Initialize WebSocket on load
        connectWebSocket();
        // Filter by Device
        function filterByDevice() {
            currentDeviceFilter = document.getElementById('deviceFilter').value;
            
            // Reload data with current time range and device filter
            if (currentTimeRange === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                loadDashboardDataCustomRange(startDate, endDate);
            } else {
                loadDashboardData(currentTimeRange);
            }
        }

        // Update Device Filter Dropdown
        function updateDeviceFilter() {
            const deviceFilter = document.getElementById('deviceFilter');
            
            // Clear existing options (except "All Devices")
            deviceFilter.innerHTML = '<option value="all">All Devices</option>';
            
            // Add device options
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} (${device.phone})`;
                deviceFilter.appendChild(option);
            });
            
            // If no device is selected and we have devices, select the latest one
            if (currentDeviceFilter === 'all' && devices.length > 0) {
                // Find the latest device by created_at or just use the first one
                const latestDevice = devices.reduce((latest, device) => {
                    const latestTime = new Date(latest.created_at || 0).getTime();
                    const deviceTime = new Date(device.created_at || 0).getTime();
                    return deviceTime > latestTime ? device : latest;
                }, devices[0]);
                
                currentDeviceFilter = latestDevice.id;
                deviceFilter.value = currentDeviceFilter;
            } else {
                // Restore selected value
                deviceFilter.value = currentDeviceFilter;
            }
        }
        
        // Auto-refresh functions
        function startAutoRefresh() {
            if (isAutoRefreshEnabled) {
                // Refresh every 10 seconds
                refreshInterval = setInterval(() => {
                    refreshDashboard();
                }, 10000);
            }
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function toggleAutoRefresh() {
            isAutoRefreshEnabled = document.getElementById('autoRefreshToggle').checked;
            
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
                console.log('Auto-refresh enabled');
            } else {
                stopAutoRefresh();
                console.log('Auto-refresh disabled');
            }
        }

        function refreshDashboard() {
            // Don't show loading spinner for auto-refresh to avoid UI flicker
            const isManualRefresh = !refreshInterval;
            
            if (isManualRefresh) {
                showLoading();
            }
            
            // Reload current data
            if (currentTimeRange === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                loadDashboardDataCustomRange(startDate, endDate, null, !isManualRefresh);
            } else {
                loadDashboardData(currentTimeRange, !isManualRefresh);
            }
            
            // Reload devices
            loadDevices(!isManualRefresh);
            
            // Update last refresh time
            const now = new Date();
            document.getElementById('lastRefresh').textContent = 
                `Last refresh: ${now.toLocaleTimeString()}`;
        }

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else if (isAutoRefreshEnabled) {
                startAutoRefresh();
                refreshDashboard(); // Refresh immediately when page becomes visible
            }
        });
        // Filter by Device
        function filterByDevice() {
            currentDeviceFilter = document.getElementById('deviceFilter').value;
            
            // Reload data with current time range and device filter
            if (currentTimeRange === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                loadDashboardDataCustomRange(startDate, endDate);
            } else {
                loadDashboardData(currentTimeRange);
            }
        }

        // Update Device Filter Dropdown
        function updateDeviceFilter() {
            const deviceFilter = document.getElementById('deviceFilter');
            
            // Clear existing options (except "All Devices")
            deviceFilter.innerHTML = '<option value="all">All Devices</option>';
            
            // Add device options
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = `${device.name} (${device.phone})`;
                deviceFilter.appendChild(option);
            });
            
            // If no device is selected and we have devices, select the latest one
            if (currentDeviceFilter === 'all' && devices.length > 0) {
                // Find the latest device by created_at or just use the first one
                const latestDevice = devices.reduce((latest, device) => {
                    const latestTime = new Date(latest.created_at || 0).getTime();
                    const deviceTime = new Date(device.created_at || 0).getTime();
                    return deviceTime > latestTime ? device : latest;
                }, devices[0]);
                
                currentDeviceFilter = latestDevice.id;
                deviceFilter.value = currentDeviceFilter;
            } else {
                // Restore selected value
                deviceFilter.value = currentDeviceFilter;
            }
        }
        
        // Auto-refresh functions
        function startAutoRefresh() {
            if (isAutoRefreshEnabled) {
                // Refresh every 10 seconds
                refreshInterval = setInterval(() => {
                    refreshDashboard();
                }, 10000);
            }
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function toggleAutoRefresh() {
            isAutoRefreshEnabled = document.getElementById('autoRefreshToggle').checked;
            
            if (isAutoRefreshEnabled) {
                startAutoRefresh();
                console.log('Auto-refresh enabled');
            } else {
                stopAutoRefresh();
                console.log('Auto-refresh disabled');
            }
        }

        function refreshDashboard() {
            // Don't show loading spinner for auto-refresh to avoid UI flicker
            const isManualRefresh = !refreshInterval;
            
            if (isManualRefresh) {
                showLoading();
            }
            
            // Reload current data
            if (currentTimeRange === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                loadDashboardDataCustomRange(startDate, endDate, null, !isManualRefresh);
            } else {
                loadDashboardData(currentTimeRange, !isManualRefresh);
            }
            
            // Reload devices
            loadDevices(!isManualRefresh);
            
            // Update last refresh time
            const now = new Date();
            document.getElementById('lastRefresh').textContent = 
                `Last refresh: ${now.toLocaleTimeString()}`;
        }
        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else if (isAutoRefreshEnabled) {
                startAutoRefresh();
                refreshDashboard(); // Refresh immediately when page becomes visible
            }
        });
        
        // Device Actions - Testing Page
        function deviceActions(deviceId) {
            // Don't need to check if device exists in array, just navigate
            window.location.href = `/device/${deviceId}/actions`;
        }
        
        // Device Leads - Lead Management
        function deviceLeads(deviceId) {
            // Don't need to check if device exists in array, just navigate
            window.location.href = `/device/${deviceId}/leads`;
        }
        
        // Campaign Calendar Functions
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let campaigns = {};
        
        function initializeCampaignCalendar() {
            const calendarContainer = document.getElementById('campaignCalendar');
            if (!calendarContainer) return;
            
            // Clear any existing content
            calendarContainer.innerHTML = '';
            
            // Remove any existing controls
            const existingControls = document.getElementById('calendarControls');
            if (existingControls) {
                existingControls.remove();
            }
            
            // Create controls container
            const controlsContainer = document.createElement('div');
            controlsContainer.id = 'calendarControls';
            calendarContainer.parentElement.insertBefore(controlsContainer, calendarContainer);
            
            renderCalendar();
            loadCampaigns();
        }
        
        function renderCalendar() {
            const calendar = document.getElementById('campaignCalendar');
            const controls = document.getElementById('calendarControls');
            if (!calendar || !controls) return;
            
            // Clear calendar
            calendar.innerHTML = '';
            
            // Update controls
            controls.innerHTML = `
                <div class="calendar-controls mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="previousMonth()">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="calendar-month-year">
                        ${new Date(currentYear, currentMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            `;
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            // Add previous month's trailing days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="calendar-date">${daysInPrevMonth - i}</div>`;
                calendar.appendChild(day);
            }
            
            // Get today's date for comparison
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayElement.className = 'calendar-day';
                
                // Debug logging for specific dates
                if (campaigns[dateStr]) {
                    console.log(`Found campaigns for ${dateStr}:`, campaigns[dateStr]);
                }
                
                // Check if this is today
                if (dateStr === todayStr) {
                    dayElement.className += ' today';
                }
                
                // Get campaigns for this date
                const dayCampaigns = campaigns[dateStr] || [];
                if (dayCampaigns.length > 0) {
                    dayElement.className += ' has-campaign';
                }
                
                let campaignHTML = '';
                if (Array.isArray(dayCampaigns)) {
                    dayCampaigns.forEach((campaign, index) => {
                        // Determine status color based on campaign status
                        let statusColor = '';
                        let statusBg = '';
                        
                        switch(campaign.status) {
                            case 'completed':
                            case 'delivered':
                            case 'success':
                                statusColor = '#28a745'; // green
                                statusBg = 'bg-success';
                                break;
                            case 'failed':
                            case 'error':
                                statusColor = '#dc3545'; // red
                                statusBg = 'bg-danger';
                                break;
                            case 'ongoing':
                            case 'processing':
                            case 'progress':
                                statusColor = '#ffc107'; // yellow
                                statusBg = 'bg-warning';
                                break;
                            default: // scheduled, pending
                                statusColor = '#6c757d'; // grey
                                statusBg = 'bg-secondary';
                        }
                        
                        // Get status-based styling
                        let detailBg = '#f8f9fa';
                        let detailBorder = '#dee2e6';
                        
                        switch(campaign.status) {
                            case 'sent':
                            case 'completed':
                            case 'success':
                                detailBg = '#e8f5e9';
                                detailBorder = '#4caf50';
                                break;
                            case 'failed':
                            case 'error':
                                detailBg = '#ffebee';
                                detailBorder = '#f44336';
                                break;
                            case 'processing':
                            case 'ongoing':
                                detailBg = '#fff3e0';
                                detailBorder = '#ff9800';
                                break;
                            default: // pending, scheduled
                                detailBg = '#f5f5f5';
                                detailBorder = '#9e9e9e';
                        }
                        
                        // Show all campaigns, not just first 3
                        campaignHTML += `
                            <div class="campaign-detail" style="font-size: 10px; margin: 2px 0; padding: 3px 5px; background: ${detailBg}; border-radius: 4px; border: 1px solid ${detailBorder}; position: relative;">
                                <div style="position: absolute; right: 3px; top: 3px; display: flex; gap: 4px; z-index: 10;">
                                    <i class="bi bi-files" onclick="cloneCampaign('${campaign.id}', event)" style="color: #0066cc; cursor: pointer; font-size: 12px;" title="Clone campaign"></i>
                                    <i class="bi bi-x-circle-fill" onclick="deleteCampaign('${campaign.id}', event)" style="color: #dc3545; cursor: pointer; font-size: 12px;" title="Delete campaign"></i>
                                </div>
                                <div style="display: flex; align-items: center; gap: 3px; padding-right: 40px;">
                                    <span class="badge ${statusBg}" style="width: 8px; height: 8px; padding: 0; border-radius: 50%;" title="${campaign.status}"></span>
                                    ${campaign.ai === 'ai' ? '<i class="bi bi-robot text-primary" style="font-size: 12px;" title="AI Campaign"></i>' : ''}
                                    <span onclick="editCampaign('${campaign.id}', '${dateStr}', event)" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; color: #0066cc; text-decoration: none;" title="Click to edit: ${campaign.title}" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                                        ${campaign.title}
                                    </span>
                                </div>
                                <div style="color: #666; font-size: 8px; margin-top: 1px;">
                                    <i class="bi bi-tag-fill" style="font-size: 8px;"></i> ${campaign.niche || 'General'} 
                                    ${campaign.target_status ? `<i class="bi bi-people-fill" style="font-size: 8px; margin-left: 4px;" title="Target: ${campaign.target_status}"></i> ${campaign.target_status}` : ''}
                                    ${campaign.time_schedule ? `<i class="bi bi-clock" style="font-size: 8px; margin-left: 4px;"></i> ${campaign.time_schedule.slice(0,5)}` : ''}
                                    ${campaign.image_url ? '<i class="bi bi-image" title="Has image" style="font-size: 8px; margin-left: 4px;"></i>' : ''}
                                    ${campaign.ai === 'ai' ? `<i class="bi bi-cpu" title="Device limit: ${campaign.limit} per device" style="font-size: 8px; margin-left: 4px;"></i> ${campaign.limit}/device` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                // Get day name
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayName = dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                
                dayElement.innerHTML = `
                    <div class="calendar-date" onclick="openCampaignModal('${dateStr}')" style="position: relative;">
                        <span style="font-size: 16px; font-weight: bold;">${day}</span>
                        <span style="font-size: 10px; color: #666; display: block; margin-top: -2px;">${dayName}</span>
                    </div>
                    <div class="campaign-container">${campaignHTML}</div>
                `;
                calendar.appendChild(dayElement);
            }
            
            // Add next month's leading days
            const totalCells = calendar.children.length - 7; // Minus headers
            const remainingCells = 35 - totalCells; // 5 rows x 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="calendar-date">${day}</div>`;
                calendar.appendChild(dayElement);
            }
        }
        
        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }
        
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        }
        
        function loadCampaigns() {
            // Load campaigns from API
            fetch('/api/campaigns', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    console.log('Campaign API response:', data);
                    if (data.code === 'SUCCESS' && data.results !== null) {
                        campaigns = {};
                        const campaignArray = Array.isArray(data.results) ? data.results : [];
                        console.log('Processing campaigns:', campaignArray.length);
                        
                        // Hide debug info - uncomment for debugging
                        // const debugDiv = document.getElementById('campaignDebug');
                        // const debugInfo = document.getElementById('debugInfo');
                        // if (debugDiv && debugInfo) {
                        //     debugDiv.style.display = 'block';
                        //     debugInfo.textContent = `Found ${campaignArray.length} campaigns. `;
                        // }
                        
                        // Group campaigns by date
                        campaignArray.forEach(campaign => {
                            // Ensure date is in YYYY-MM-DD format
                            let date = campaign.campaign_date;
                            if (date.includes('T')) {
                                date = date.split('T')[0];
                            }
                            console.log('Processing campaign:', campaign.title, 'Date:', date, 'Time:', campaign.time_schedule);
                            if (!campaigns[date]) {
                                campaigns[date] = [];
                            }
                            campaigns[date].push(campaign);
                        });
                        
                        console.log('Grouped campaigns:', campaigns);
                        console.log('Campaign dates:', Object.keys(campaigns));
                        console.log('Current calendar showing:', currentYear + '-' + (currentMonth + 1));
                        
                        // Update debug info - uncomment for debugging
                        // if (debugInfo) {
                        //     debugInfo.textContent += `Dates: ${Object.keys(campaigns).join(', ')}`;
                        // }
                        
                        renderCalendar();
                    } else {
                        // Show no campaigns message - uncomment for debugging
                        // const debugDiv = document.getElementById('campaignDebug');
                        // const debugInfo = document.getElementById('debugInfo');
                        // if (debugDiv && debugInfo) {
                        //     debugDiv.style.display = 'block';
                        //     debugDiv.className = 'alert alert-warning mb-3';
                        //     debugInfo.textContent = 'No campaigns found or error loading campaigns.';
                        // }
                    }
                })
                .catch(error => {
                    console.error('Error loading campaigns:', error);
                    // Hide error debug info - uncomment for debugging
                    // const debugDiv = document.getElementById('campaignDebug');
                    // const debugInfo = document.getElementById('debugInfo');
                    // if (debugDiv && debugInfo) {
                    //     debugDiv.style.display = 'block';
                    //     debugDiv.className = 'alert alert-danger mb-3';
                    //     debugInfo.textContent = 'Error loading campaigns: ' + error.message;
                    // }
                });
        }
        
        function openCampaignModal(date) {
            const existingCampaigns = campaigns[date] || [];
            const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
            
            // Format date with day name
            const dateObj = new Date(date);
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            // Set modal data for new campaign
            document.getElementById('campaignDate').value = date;
            document.getElementById('campaignModalTitle').textContent = `Create Campaign - ${dayName}, ${formattedDate}`;
            document.getElementById('campaignForm').reset();
            document.getElementById('campaignId').value = '';
            document.getElementById('campaignDate').value = date;
            
            // TODO: If you want to edit existing campaigns, you could show a list to select from
            // For now, we just create new campaigns
            
            modal.show();
        }
        
        function saveCampaign() {
            const campaignId = document.getElementById('campaignId').value;
            const campaignDate = document.getElementById('campaignDate').value;
            
            // Auto-set current time if not provided
            let scheduledTime = document.getElementById('campaignTime').value;
            if (!scheduledTime) {
                const now = new Date();
                scheduledTime = now.toTimeString().slice(0, 5); // HH:MM format
            }
            
            const campaignData = {
                campaign_date: campaignDate,
                title: document.getElementById('campaignTitle').value || '',
                niche: document.getElementById('campaignNiche').value || '',
                target_status: document.getElementById('campaignTargetStatus').value || 'prospect',
                message: document.getElementById('campaignMessage').value || '',
                image_url: document.getElementById('campaignImageUrl').value || '',
                time_schedule: scheduledTime,
                min_delay_seconds: parseInt(document.getElementById('campaignMinDelay').value) || 10,
                max_delay_seconds: parseInt(document.getElementById('campaignMaxDelay').value) || 30
            };
            
            // Add campaign_date to update requests as well
            if (campaignId) {
                campaignData.campaign_date = campaignDate;
            }
            
            console.log('Saving campaign with data:', campaignData);
            
            const url = campaignId ? `/api/campaigns/${campaignId}` : '/api/campaigns';
            const method = campaignId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(campaignData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
                    loadCampaigns();
                    showAlert('success', campaignId ? 'Campaign updated!' : 'Campaign created!');
                } else {
                    showAlert('danger', data.message || 'Failed to save campaign');
                }
            })
            .catch(error => showAlert('danger', 'Error: ' + error.message));
        }
        
        // Image compression function with 350KB limit
        function compressImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Start with original dimensions
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.9;
                    
                    // First resize if image is too large
                    const maxSize = 1000;
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress until under 350KB
                    function tryCompress() {
                        canvas.toBlob(function(blob) {
                            if (blob.size > 350 * 1024 && quality > 0.1) {
                                quality -= 0.1;
                                tryCompress();
                            } else {
                                // Convert to base64
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('campaignImageUrl').value = e.target.result;
                                    document.getElementById('imagePreview').innerHTML = 
                                        `<img src="${e.target.result}" class="img-thumbnail" style="max-height: 200px;">
                                         <small class="d-block mt-1">Size: ${(blob.size / 1024).toFixed(0)}KB</small>`;
                                };
                                reader.readAsDataURL(blob);
                            }
                        }, 'image/jpeg', quality);
                    }
                    
                    tryCompress();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }
        
        // Edit campaign function
        function editCampaign(campaignId, dateStr, event) {
            if (event) {
                event.stopPropagation(); // Prevent day click
            }
            
            // Find the campaign in our data
            const dayCampaigns = campaigns[dateStr] || [];
            const campaign = dayCampaigns.find(c => c.id == campaignId);
            
            if (!campaign) {
                showAlert('danger', 'Campaign not found');
                return;
            }
            
            // Populate the modal with campaign data
            document.getElementById('campaignId').value = campaign.id;
            document.getElementById('campaignDate').value = dateStr;
            document.getElementById('campaignTitle').value = campaign.title || '';
            document.getElementById('campaignNiche').value = campaign.niche || '';
            document.getElementById('campaignTargetStatus').value = campaign.target_status || 'prospect';
            document.getElementById('campaignMessage').value = campaign.message || '';
            document.getElementById('campaignTime').value = campaign.time_schedule || '';
            document.getElementById('campaignMinDelay').value = campaign.min_delay_seconds || 10;
            document.getElementById('campaignMaxDelay').value = campaign.max_delay_seconds || 30;
            document.getElementById('campaignImageUrl').value = campaign.image_url || '';
            
            // Show image preview if exists
            if (campaign.image_url) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${campaign.image_url}" class="img-thumbnail" style="max-height: 200px;">`;
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            // Update modal title
            const dateObj = new Date(dateStr);
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('campaignModalTitle').textContent = `Edit Campaign - ${dayName}, ${formattedDate}`;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
            modal.show();
        }
        
        // Delete campaign function
        function deleteCampaign(campaignId, event) {
            event.stopPropagation(); // Prevent day click and edit click
            
            if (!confirm('Are you sure you want to delete this campaign?')) {
                return;
            }
            
            showLoading();
            
            fetch(`/api/campaigns/${campaignId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.code === 'SUCCESS') {
                    showAlert('success', 'Campaign deleted successfully');
                    
                    // Remove from local campaigns object immediately
                    for (let date in campaigns) {
                        campaigns[date] = campaigns[date].filter(c => c.id !== campaignId);
                        if (campaigns[date].length === 0) {
                            delete campaigns[date];
                        }
                    }
                    
                    // Render calendar immediately
                    renderCalendar();
                    
                    // Then reload from server
                    loadCampaigns();
                } else {
                    showAlert('danger', data.message || 'Failed to delete campaign');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error deleting campaign:', error);
                showAlert('danger', 'Error deleting campaign');
            });
        }
        
        // Clone campaign function
        function cloneCampaign(campaignId, event) {
            event.stopPropagation();
            
            // Find the campaign to clone
            let campaignToClone = null;
            let campaignDate = null;
            for (let date in campaigns) {
                const found = campaigns[date].find(c => c.id == campaignId);
                if (found) {
                    campaignToClone = found;
                    campaignDate = date;
                    break;
                }
            }
            
            if (!campaignToClone) {
                showAlert('danger', 'Campaign not found');
                return;
            }
            
            // Clear the form and populate with cloned data
            document.getElementById('campaignId').value = ''; // Empty ID for new campaign
            document.getElementById('campaignDate').value = new Date().toISOString().split('T')[0]; // Today's date
            document.getElementById('campaignTitle').value = campaignToClone.title + ' (Copy)';
            document.getElementById('campaignNiche').value = campaignToClone.niche || '';
            document.getElementById('campaignTargetStatus').value = campaignToClone.target_status || 'prospect';
            document.getElementById('campaignMessage').value = campaignToClone.message || '';
            document.getElementById('campaignTime').value = campaignToClone.time_schedule || '';
            document.getElementById('campaignMinDelay').value = campaignToClone.min_delay_seconds || 10;
            document.getElementById('campaignMaxDelay').value = campaignToClone.max_delay_seconds || 30;
            document.getElementById('campaignImageUrl').value = campaignToClone.image_url || '';
            
            // Show image preview if exists
            if (campaignToClone.image_url) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${campaignToClone.image_url}" class="img-thumbnail" style="max-height: 200px;">`;
            } else {
                document.getElementById('imagePreview').innerHTML = '';
            }
            
            // Update modal title
            const dateObj = new Date();
            const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
            const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('campaignModalTitle').textContent = `Clone Campaign - ${dayName}, ${formattedDate}`;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
            modal.show();
        }
        
        // Open WhatsApp Web for device
        function openWhatsAppWeb(deviceId) {
            // Open WhatsApp Web in a new tab
            // This would open a dedicated WhatsApp Web instance for this device
            window.open(`/device/${deviceId}/whatsapp-web`, '_blank');
        }
        
        // Sequences Functions
        async function toggleSequence(id, isActive) {
            const action = isActive ? 'start' : 'pause';
            const endpoint = `/api/sequences/${id}/${action}`;
            
            try {
                const response = await fetch(endpoint, { method: 'POST' });
                const data = await response.json();
                
                if (data.code === 'SUCCESS') {
                    showToast(`Sequence ${action}ed successfully!`, 'success');
                    loadSequences();
                } else {
                    showToast(data.message || `Failed to ${action} sequence`, 'error');
                    // Revert checkbox state
                    const checkbox = document.getElementById(`toggle-${id}`);
                    if (checkbox) checkbox.checked = !isActive;
                    const checkbox2 = document.getElementById(`toggle2-${id}`);
                    if (checkbox2) checkbox2.checked = !isActive;
                }
            } catch (error) {
                console.error(`Error ${action}ing sequence:`, error);
                showToast(`Failed to ${action} sequence`, 'error');
                // Revert checkbox state
                const checkbox = document.getElementById(`toggle-${id}`);
                if (checkbox) checkbox.checked = !isActive;
                const checkbox2 = document.getElementById(`toggle2-${id}`);
                if (checkbox2) checkbox2.checked = !isActive;
            }
        }
        
        async function deleteSequence(id) {
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "This will delete the sequence and all its data!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch(`/api/sequences/${id}`, { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (data.code === 'SUCCESS') {
                        Swal.fire('Deleted!', 'Sequence has been deleted.', 'success');
                        loadSequences();
                    } else {
                        Swal.fire('Error', data.message || 'Failed to delete sequence', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting sequence:', error);
                    Swal.fire('Error', 'Failed to delete sequence', 'error');
                }
            }
        }
        
        async function loadSequences() {
            try {
                const response = await fetch('/api/sequences');
                const data = await response.json();
                
                if (data.code === 'SUCCESS' && data.results && data.results.length > 0) {
                    displaySequences(data.results);
                } else {
                    // Show empty state (already in HTML)
                }
            } catch (error) {
                console.error('Error loading sequences:', error);
                showToast('Error loading sequences', 'error');
            }
        }
        
        function displaySequences(sequences) {
            const container = document.getElementById('sequencesList');
            if (!container) {
                // Try alternative container
                const altContainer = document.getElementById('sequencesContainer');
                if (altContainer) {
                    displaySequencesInContainer(sequences, altContainer);
                }
                return;
            }
            
            container.innerHTML = '';
            
            if (!sequences || sequences.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-collection text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">No Sequences Yet</h5>
                        <p class="text-muted">Create your first sequence to start automated messaging</p>
                        <button class="btn btn-primary" onclick="window.location.href='/sequences'">
                            <i class="bi bi-plus-circle"></i> Create Sequence
                        </button>
                    </div>
                `;
                return;
            }
            
            sequences.forEach(seq => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 mb-3';
                
                const statusColor = seq.status === 'active' ? 'success' : 
                                  seq.status === 'paused' ? 'warning' : 'secondary';
                
                col.innerHTML = `
                    <div class="card h-100 sequence-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${seq.name}</h5>
                                <span class="badge bg-${statusColor}">
                                    ${seq.status}
                                </span>
                            </div>
                            <p class="text-muted small mb-2">Tag: ${seq.niche || 'Not set'}</p>
                            <p class="card-text">${seq.description || 'No description'}</p>
                            <div class="progress mb-3" style="height: 5px;">
                                <div class="progress-bar bg-${statusColor}" style="width: ${(seq.completed_count / seq.contacts_count * 100) || 0}%"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-people"></i> ${seq.contacts_count || 0} contacts
                                </small>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewEditSequence('${seq.id}')" title="View/Edit Sequence">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSequence('${seq.id}')" title="Delete Sequence">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                    <div class="form-check form-switch d-inline-block ms-2">
                                        <input class="form-check-input" type="checkbox" id="toggle-${seq.id}" 
                                            ${seq.status === 'active' ? 'checked' : ''} 
                                            onchange="toggleSequence('${seq.id}', this.checked)">
                                        <label class="form-check-label" for="toggle-${seq.id}">
                                            ${seq.status === 'active' ? 'Active' : 'Inactive'}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }
        
        function displaySequencesInContainer(sequences, container) {
            if (!sequences || sequences.length === 0) {
                return; // Keep existing empty state
            }
            
            let html = '<div class="row g-3">';
            sequences.forEach(seq => {
                const statusColor = seq.status === 'active' ? 'success' : 
                                   seq.status === 'paused' ? 'warning' : 'secondary';
                
                html += `
                    <div class="col-md-4">
                        <div class="card sequence-card h-100">
                            <div class="card-body">
                                <h5 class="card-title">${seq.name}</h5>
                                <p class="text-muted mb-2">${seq.description || 'No description'}</p>
                                <div class="mb-3">
                                    <small class="text-muted">Tag: ${seq.niche || 'Not set'}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-${statusColor}">${seq.status}</span>
                                    <small>${seq.contacts_count || 0} contacts</small>
                                </div>
                                <div class="progress mb-3" style="height: 5px;">
                                    <div class="progress-bar bg-${statusColor}" style="width: ${(seq.completed_count / seq.contacts_count * 100) || 0}%"></div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewEditSequence('${seq.id}')" title="View/Edit Sequence">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSequence('${seq.id}')" title="Delete Sequence">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                    <div class="form-check form-switch d-inline-block ms-2">
                                        <input class="form-check-input" type="checkbox" id="toggle2-${seq.id}" 
                                            ${seq.status === 'active' ? 'checked' : ''} 
                                            onchange="toggleSequence('${seq.id}', this.checked)">
                                        <label class="form-check-label" for="toggle2-${seq.id}">
                                            ${seq.status === 'active' ? 'Active' : 'Inactive'}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Open Create Sequence Modal function
        function openCreateSequenceModal() {
            // Initialize the days grid
            initializeSequenceDaysGrid();
            const modal = new bootstrap.Modal(document.getElementById('createSequenceModal'));
            modal.show();
        }
        
        // Initialize sequence days grid
        let sequenceDays = {};
        function initializeSequenceDaysGrid() {
            const grid = document.querySelector('.sequence-days-grid');
            grid.innerHTML = '';
            sequenceDays = {}; // Reset days data
            
            // Create 31 day buttons
            for (let i = 1; i <= 31; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'sequence-day-box';
                dayDiv.style.cssText = `
                    border: 2px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 15px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s;
                    background: white;
                    position: relative;
                `;
                dayDiv.innerHTML = `
                    <div style="font-size: 18px; font-weight: bold; color: #666;">Day ${i}</div>
                    <div class="day-status" style="font-size: 12px; color: #999; margin-top: 5px;">
                        <i class="bi bi-plus-circle"></i> Add
                    </div>
                `;
                dayDiv.onclick = () => openDayMessageModal(i);
                
                // Hover effect
                dayDiv.onmouseover = () => {
                    dayDiv.style.borderColor = '#128c7e';
                    dayDiv.style.transform = 'translateY(-2px)';
                    dayDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                };
                dayDiv.onmouseout = () => {
                    dayDiv.style.borderColor = sequenceDays[i] ? '#25d366' : '#e0e0e0';
                    dayDiv.style.transform = 'none';
                    dayDiv.style.boxShadow = 'none';
                };
                
                grid.appendChild(dayDiv);
            }
        }
        
        // Open day message modal
        function openDayMessageModal(dayNumber) {
            document.getElementById('currentDayNumber').value = dayNumber;
            document.getElementById('dayMessageTitle').textContent = `Day ${dayNumber} Message`;
            
            // Reset the file input
            const fileInput = document.getElementById('dayMessageImage');
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Load existing data if any
            if (sequenceDays[dayNumber]) {
                document.getElementById('dayMessageContent').value = sequenceDays[dayNumber].content || '';
                document.getElementById('dayMessageImageUrl').value = sequenceDays[dayNumber].image_url || '';
                if (sequenceDays[dayNumber].image_url) {
                    document.getElementById('dayImagePreview').innerHTML = 
                        `<img src="${sequenceDays[dayNumber].image_url}" class="img-thumbnail" style="max-height: 150px;">`;
                } else {
                    document.getElementById('dayImagePreview').innerHTML = '';
                }
            } else {
                // Clear all fields for new day
                document.getElementById('dayMessageContent').value = '';
                document.getElementById('dayMessageImageUrl').value = '';
                document.getElementById('dayImagePreview').innerHTML = '';
            }
            
            updateSequenceLivePreview();
            
            // Show day modal
            const dayModal = new bootstrap.Modal(document.getElementById('dayMessageModal'));
            dayModal.show();
        }
        
        // Save day message
        function saveDayMessage() {
            const dayNumber = parseInt(document.getElementById('currentDayNumber').value);
            const content = document.getElementById('dayMessageContent').value;
            const imageUrl = document.getElementById('dayMessageImageUrl').value;
            
            if (!content && !imageUrl) {
                Swal.fire('Error', 'Please add a message or image', 'error');
                return;
            }
            
            // Save day data
            sequenceDays[dayNumber] = {
                day: dayNumber,
                day_number: dayNumber,
                content: content,
                image_url: imageUrl,
                media_url: imageUrl,
                message_type: imageUrl ? 'image' : 'text',
                send_time: document.getElementById('sequenceScheduleTime')?.value || '09:00',
                min_delay_seconds: parseInt(document.getElementById('sequenceMinDelay').value) || 5,
                max_delay_seconds: parseInt(document.getElementById('sequenceMaxDelay').value) || 15
            };
            
            // Update day box appearance
            updateDayBoxStatus(dayNumber, true);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('dayMessageModal')).hide();
            
            // Clear form
            document.getElementById('dayMessageContent').value = '';
            document.getElementById('dayMessageImageUrl').value = '';
            document.getElementById('dayImagePreview').innerHTML = '';
        }
        
        // Update day box status
        function updateDayBoxStatus(dayNumber, hasContent) {
            const dayBoxes = document.querySelectorAll('.sequence-day-box');
            const dayBox = dayBoxes[dayNumber - 1];
            
            if (hasContent) {
                dayBox.style.borderColor = '#25d366';
                dayBox.style.background = '#f0fdf4';
                dayBox.querySelector('.day-status').innerHTML = '<i class="bi bi-check-circle-fill" style="color: #25d366;"></i> Set';
            } else {
                dayBox.style.borderColor = '#e0e0e0';
                dayBox.style.background = 'white';
                dayBox.querySelector('.day-status').innerHTML = '<i class="bi bi-plus-circle"></i> Add';
            }
        }
        
        // Update live preview for sequence
        function updateSequenceLivePreview() {
            const content = document.getElementById('dayMessageContent').value;
            const preview = document.getElementById('sequenceLivePreview');
            
            if (!content) {
                preview.textContent = 'Your formatted message will appear here...';
                preview.style.color = '#666';
                return;
            }
            
            // Format the message
            let formatted = content
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/~(.*?)~/g, '<del>$1</del>')
                .replace(/```(.*?)```/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            preview.innerHTML = formatted;
            preview.style.color = '#000';
        }
        
        // Compress day image
        function compressDayImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.9;
                    
                    const maxSize = 1000;
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    function tryCompress() {
                        canvas.toBlob(function(blob) {
                            if (blob.size > 350 * 1024 && quality > 0.1) {
                                quality -= 0.1;
                                tryCompress();
                            } else {
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    document.getElementById('dayMessageImageUrl').value = e.target.result;
                                    document.getElementById('dayImagePreview').innerHTML = 
                                        `<img src="${e.target.result}" class="img-thumbnail" style="max-height: 150px;">
                                         <small class="d-block mt-1">Size: ${(blob.size / 1024).toFixed(0)}KB</small>`;
                                };
                                reader.readAsDataURL(blob);
                            }
                        }, 'image/jpeg', quality);
                    }
                    
                    tryCompress();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // View/Edit Sequence function
        let currentEditingSequenceId = null;
        async function viewEditSequence(sequenceId) {
            try {
                const response = await fetch(`/api/sequences/${sequenceId}`);
                const data = await response.json();
                
                if (data.code === 'SUCCESS' && data.results) {
                    const sequence = data.results;
                    currentEditingSequenceId = sequenceId;
                    
                    // Populate form fields
                    document.getElementById('sequenceName').value = sequence.name || '';
                    document.getElementById('sequenceDescription').value = sequence.description || '';
                    document.getElementById('sequenceNiche').value = sequence.niche || '';
                    
                    // Reset and populate days
                    sequenceDays = {};
                    if (sequence.steps && Array.isArray(sequence.steps)) {
                        sequence.steps.forEach(step => {
                            const dayNum = step.day_number || step.day;
                            sequenceDays[dayNum] = {
                                day: dayNum,
                                day_number: dayNum,
                                content: step.content || '',
                                image_url: step.image_url || step.media_url || '',
                                media_url: step.media_url || step.image_url || '',
                                message_type: step.message_type || 'text',
                                send_time: step.send_time || '09:00',
                                min_delay_seconds: step.min_delay_seconds || 5,
                                max_delay_seconds: step.max_delay_seconds || 15
                            };
                        });
                        
                        // Set global delays from first step
                        if (sequence.steps.length > 0) {
                            document.getElementById('sequenceMinDelay').value = sequence.steps[0].min_delay_seconds || 5;
                            document.getElementById('sequenceMaxDelay').value = sequence.steps[0].max_delay_seconds || 15;
                        }
                        
                        // Set schedule time if available
                        if (sequence.time_schedule) {
                            document.getElementById('sequenceScheduleTime').value = sequence.time_schedule;
                        }
                    }
                    
                    // Change modal title and button text
                    document.querySelector('#createSequenceModal .modal-title').textContent = 'Edit Sequence';
                    document.querySelector('#createSequenceModal .modal-footer .btn-primary').textContent = 'Update Sequence';
                    document.querySelector('#createSequenceModal .modal-footer .btn-primary').onclick = () => updateSequence(sequenceId);
                    
                    // Initialize grid and show modal
                    initializeSequenceDaysGrid();
                    
                    // Update day boxes to show which days have content
                    Object.keys(sequenceDays).forEach(dayNumber => {
                        updateDayBoxStatus(parseInt(dayNumber), true);
                    });
                    
                    const modal = new bootstrap.Modal(document.getElementById('createSequenceModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading sequence:', error);
                Swal.fire('Error', 'Failed to load sequence', 'error');
            }
        }
        
        // Update Sequence function
        async function updateSequence(sequenceId) {
            const form = document.getElementById('createSequenceForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Convert sequenceDays object to array
            const steps = Object.values(sequenceDays);
            
            if (steps.length === 0) {
                Swal.fire('Error', 'Please add at least one day message', 'error');
                return;
            }
            
            // Get global delay settings
            const minDelay = parseInt(document.getElementById('sequenceMinDelay').value) || 5;
            const maxDelay = parseInt(document.getElementById('sequenceMaxDelay').value) || 15;
            
            // Apply global delays to all steps
            steps.forEach(step => {
                step.min_delay_seconds = minDelay;
                step.max_delay_seconds = maxDelay;
            });
            
            const sequenceData = {
                name: document.getElementById('sequenceName').value,
                description: document.getElementById('sequenceDescription').value,
                niche: document.getElementById('sequenceNiche').value,
                time_schedule: document.getElementById('sequenceScheduleTime').value || '09:00',
                min_delay_seconds: minDelay,
                max_delay_seconds: maxDelay,
                steps: steps,
                status: 'draft'
            };
            
            try {
                const response = await fetch(`/api/sequences/${sequenceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sequenceData)
                });
                
                const data = await response.json();
                
                if (response.ok && data.code === 'SUCCESS') {
                    Swal.fire('Success', 'Sequence updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createSequenceModal')).hide();
                    // Reset form
                    form.reset();
                    sequenceDays = {};
                    currentEditingSequenceId = null;
                    // Reset modal for create mode
                    document.querySelector('#createSequenceModal .modal-title').textContent = 'Create New Sequence';
                    document.querySelector('#createSequenceModal .modal-footer .btn-primary').textContent = 'Create Sequence';
                    document.querySelector('#createSequenceModal .modal-footer .btn-primary').onclick = createSequence;
                    loadSequences();
                } else {
                    Swal.fire('Error', data.message || 'Failed to update sequence', 'error');
                }
            } catch (error) {
                console.error('Error updating sequence:', error);
                Swal.fire('Error', 'Failed to update sequence', 'error');
            }
        }
        
        // Create Sequence function
        async function createSequence() {
            const form = document.getElementById('createSequenceForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Convert sequenceDays object to array
            const steps = Object.values(sequenceDays);
            
            if (steps.length === 0) {
                Swal.fire('Error', 'Please add at least one day message', 'error');
                return;
            }
            
            // Get global delay settings
            const minDelay = parseInt(document.getElementById('sequenceMinDelay').value) || 5;
            const maxDelay = parseInt(document.getElementById('sequenceMaxDelay').value) || 15;
            
            // Apply global delays to all steps
            steps.forEach(step => {
                step.min_delay_seconds = minDelay;
                step.max_delay_seconds = maxDelay;
            });
            
            const sequenceData = {
                name: document.getElementById('sequenceName').value,
                description: document.getElementById('sequenceDescription').value,
                niche: document.getElementById('sequenceNiche').value,
                time_schedule: document.getElementById('sequenceScheduleTime').value || '09:00',
                min_delay_seconds: minDelay,
                max_delay_seconds: maxDelay,
                steps: steps,
                status: 'draft'
            };
            
            console.log('Creating sequence with data:', sequenceData);
            console.log('Steps to create:', steps);
            
            try {
                const response = await fetch('/api/sequences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sequenceData)
                });
                
                const data = await response.json();
                
                if (response.ok && (data.code === 'CREATED' || data.code === 'SUCCESS')) {
                    Swal.fire('Success', 'Sequence created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('createSequenceModal')).hide();
                    // Reset form
                    form.reset();
                    sequenceDays = {};
                    loadSequences();
                } else {
                    Swal.fire('Error', data.message || 'Failed to create sequence', 'error');
                }
            } catch (error) {
                console.error('Error creating sequence:', error);
                Swal.fire('Error', 'Failed to create sequence', 'error');
            }
        }
        
        // Initialize tabs when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const campaignTab = document.getElementById('campaign-tab');
            if (campaignTab) {
                campaignTab.addEventListener('shown.bs.tab', function() {
                    initializeCampaignCalendar();
                });
            }
            
            const sequencesTab = document.getElementById('sequences-tab');
            if (sequencesTab) {
                sequencesTab.addEventListener('shown.bs.tab', function() {
                    loadSequences();
                });
            }
            
            // Reset modal when closed
            const createSequenceModal = document.getElementById('createSequenceModal');
            if (createSequenceModal) {
                createSequenceModal.addEventListener('hidden.bs.modal', function () {
                    // Reset to create mode if not saving
                    if (currentEditingSequenceId) {
                        document.querySelector('#createSequenceModal .modal-title').textContent = 'Create New Sequence';
                        document.querySelector('#createSequenceModal .modal-footer .btn-primary').textContent = 'Create Sequence';
                        document.querySelector('#createSequenceModal .modal-footer .btn-primary').onclick = createSequence;
                        currentEditingSequenceId = null;
                    }
                });
            }
            
            // Worker filter handlers
            document.querySelectorAll('input[name="workerFilter"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const filterSelector = document.getElementById('filterSelector');
                    const filterItemId = document.getElementById('filterItemId');
                    
                    if (this.value === 'all') {
                        filterSelector.style.display = 'none';
                        loadWorkerStatus();
                    } else {
                        filterSelector.style.display = 'inline-block';
                        filterItemId.innerHTML = '<option value="">Loading...</option>';
                        
                        if (this.value === 'campaign') {
                            // Load campaigns
                            fetch('/api/campaigns')
                                .then(response => response.json())
                                .then(data => {
                                    if (data.code === 'SUCCESS') {
                                        filterItemId.innerHTML = '<option value="">Select Campaign</option>';
                                        data.results.forEach(campaign => {
                                            filterItemId.innerHTML += `<option value="${campaign.id}">${campaign.title}</option>`;
                                        });
                                    }
                                });
                        } else if (this.value === 'sequence') {
                            // Load sequences
                            fetch('/api/sequences')
                                .then(response => response.json())
                                .then(data => {
                                    if (data.code === 'SUCCESS') {
                                        filterItemId.innerHTML = '<option value="">Select Sequence</option>';
                                        data.results.forEach(sequence => {
                                            filterItemId.innerHTML += `<option value="${sequence.id}">${sequence.name}</option>`;
                                        });
                                    }
                                });
                        }
                    }
                });
            });
        });
        
        // Campaign Summary Functions
        // Helper function to format campaign date with day name
        function formatCampaignDate(dateStr) {
            if (!dateStr) return '-';
            
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    // If invalid date, just return the string as is
                    return dateStr;
                }
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                return `${dayName}, ${formatted}`;
            } catch (e) {
                return dateStr || '-';
            }
        }
        
        function loadCampaignSummary(showAll = false) {
            fetch('/api/campaigns/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        let filteredResults = data.results;
                        
                        // Filter to show only today and tomorrow by default
                        if (!showAll) {
                            const today = new Date();
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            
                            const todayStr = today.toISOString().split('T')[0];
                            const tomorrowStr = tomorrow.toISOString().split('T')[0];
                            
                            filteredResults = {
                                ...data.results,
                                recent_campaigns: (data.results.recent_campaigns || []).filter(campaign => {
                                    if (!campaign.campaign_date) return false;
                                    const campaignDate = campaign.campaign_date.split('T')[0];
                                    return campaignDate === todayStr || campaignDate === tomorrowStr;
                                })
                            };
                            
                            // Update counts for filtered data
                            const filteredCampaigns = filteredResults.recent_campaigns;
                            filteredResults.campaigns = {
                                total: filteredCampaigns.length,
                                pending: filteredCampaigns.filter(c => c.status === 'scheduled' || c.status === 'pending').length,
                                triggered: filteredCampaigns.filter(c => c.status === 'triggered').length,
                                processing: filteredCampaigns.filter(c => c.status === 'processing').length,
                                finished: filteredCampaigns.filter(c => c.status === 'finished' || c.status === 'sent').length,
                                failed: filteredCampaigns.filter(c => c.status === 'failed').length
                            };
                        }
                        
                        displayCampaignSummary(filteredResults);
                    } else {
                        document.getElementById('campaignSummaryContent').innerHTML = 
                            '<div class="alert alert-danger">Failed to load campaign summary</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading campaign summary:', error);
                    document.getElementById('campaignSummaryContent').innerHTML = 
                        '<div class="alert alert-danger">Error loading data</div>';
                });
        }
        
        function displayCampaignSummary(summary) {
            const html = `
                <div class="row mb-4">
                    <!-- Total Campaigns -->
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">${summary.campaigns.total || 0}</h3>
                                <p class="text-muted mb-0">Total</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Flow Cards -->
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning">${summary.campaigns.pending || 0}</h3>
                                <p class="text-muted mb-0">Pending</p>
                                <small class="text-muted">Waiting</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info">${summary.campaigns.triggered || 0}</h3>
                                <p class="text-muted mb-0">Triggered</p>
                                <small class="text-muted">Creating</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">${summary.campaigns.processing || 0}</h3>
                                <p class="text-muted mb-0">Processing</p>
                                <small class="text-muted">Sending</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">${summary.campaigns.finished || summary.campaigns.sent || 0}</h3>
                                <p class="text-muted mb-0">Finished</p>
                                <small class="text-muted">Done</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger">${summary.campaigns.failed || 0}</h3>
                                <p class="text-muted mb-0">Failed</p>
                                <small class="text-muted">Error</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Message Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <p class="mb-1">Total Messages: <strong>${summary.messages.total_messages}</strong></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-1">Sent: <strong class="text-success">${summary.messages.sent_messages}</strong></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-1">Failed: <strong class="text-danger">${summary.messages.failed_messages}</strong></p>
                                    </div>
                                    <div class="col-md-3">
                                        <p class="mb-1">Success Rate: <strong>${summary.messages.success_rate?.toFixed(1) || 0}%</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Recent Campaigns</h5>
                            </div>
                            <div class="card-body">
                                ${summary.recent_campaigns.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Date</th>
                                                    <th>Time</th>
                                                    <th>Niche</th>
                                                    <th>Target Status</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                    <th>Device Report</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${summary.recent_campaigns.map(campaign => `
                                                    <tr>
                                                        <td>${campaign.title}</td>
                                                        <td>${campaign.campaign_date ? formatCampaignDate(campaign.campaign_date) : '-'}</td>
                                                        <td>${campaign.time_schedule || '-'}</td>
                                                        <td>${campaign.niche || '-'}</td>
                                                        <td>
                                                            <span class="badge bg-${campaign.target_status === 'all' ? 'info' : campaign.target_status === 'prospect' ? 'primary' : 'success'}">
                                                                ${campaign.target_status || 'all'}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-${getStatusColor(campaign.status)}">
                                                                ${campaign.status}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="previewCampaignMessage(${JSON.stringify(campaign).replace(/"/g, '&quot;')})" title="Preview Message">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-success" onclick="showCampaignDeviceReport(${JSON.stringify(campaign).replace(/"/g, '&quot;')})" title="Device Report">
                                                                <i class="bi bi-phone"></i> Report
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted text-center">No campaigns yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('campaignSummaryContent').innerHTML = html;
        }
        
        // Sequence Summary Functions
        function loadSequenceSummary() {
            fetch('/api/sequences/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        displaySequenceSummary(data.results);
                    } else {
                        document.getElementById('sequenceSummaryContent').innerHTML = 
                            '<div class="alert alert-danger">Failed to load sequence summary</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sequence summary:', error);
                    document.getElementById('sequenceSummaryContent').innerHTML = 
                        '<div class="alert alert-danger">Error loading data</div>';
                });
        }
        
        function displaySequenceSummary(summary) {
            const html = `
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">${summary.sequences.total}</h3>
                                <p class="text-muted mb-0">Total Sequences</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">${summary.sequences.active}</h3>
                                <p class="text-muted mb-0">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning">${summary.sequences.paused}</h3>
                                <p class="text-muted mb-0">Paused</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-secondary">${summary.sequences.draft}</h3>
                                <p class="text-muted mb-0">Draft</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Contact Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-1">Total Contacts: <strong>${summary.contacts.total}</strong></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-1">Average per Sequence: <strong>${summary.contacts.average_per_sequence.toFixed(1)}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Recent Sequences</h5>
                            </div>
                            <div class="card-body">
                                ${summary.recent_sequences.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Niche</th>
                                                    <th>Contacts</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${summary.recent_sequences.map(sequence => `
                                                    <tr>
                                                        <td>${sequence.name}</td>
                                                        <td>${sequence.niche || '-'}</td>
                                                        <td>${sequence.contacts_count}</td>
                                                        <td>
                                                            <span class="badge bg-${getStatusColor(sequence.status)}">
                                                                ${sequence.status}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/sequences/${sequence.id}'" title="View Details">
                                                                <i class="bi bi-eye"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted text-center">No sequences yet</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('sequenceSummaryContent').innerHTML = html;
        }
        
        // Format WhatsApp message helper
        function formatWhatsAppMessage(text) {
            if (!text) return '';
            return text
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/~(.*?)~/g, '<del>$1</del>')
                .replace(/```(.*?)```/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        // Worker Status Functions
        let workerRefreshInterval;
        
        function loadWorkerStatus() {
            // Get filter parameters
            const filterType = document.querySelector('input[name="workerFilter"]:checked').value;
            const filterItemId = document.getElementById('filterItemId').value;
            
            let url = '/api/workers/status';
            if (filterType !== 'all' && filterItemId) {
                url += `?filter=${filterType}&id=${filterItemId}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        displayWorkerStatus(data.results);
                    } else {
                        document.getElementById('workerStatusContent').innerHTML = 
                            '<div class="alert alert-danger">Failed to load worker status</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading worker status:', error);
                    document.getElementById('workerStatusContent').innerHTML = 
                        '<div class="alert alert-danger">Error loading data</div>';
                });
        }
        
        // Worker Control Functions
        async function resumeFailedWorkers() {
            try {
                const response = await fetch('/api/workers/resume-failed', { method: 'POST' });
                const data = await response.json();
                if (data.code === 'SUCCESS') {
                    showToast('Failed workers resumed successfully', 'success');
                    loadWorkerStatus();
                } else {
                    showToast(data.message || 'Failed to resume workers', 'error');
                }
            } catch (error) {
                console.error('Error resuming workers:', error);
                showToast('Failed to resume workers', 'error');
            }
        }

        async function stopAllWorkers() {
            const result = await Swal.fire({
                title: 'Stop All Workers?',
                text: 'This will stop all running workers',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Yes, stop all!'
            });
            
            if (result.isConfirmed) {
                try {
                    const response = await fetch('/api/workers/stop-all', { method: 'POST' });
                    const data = await response.json();
                    if (data.code === 'SUCCESS') {
                        showToast('All workers stopped', 'success');
                        loadWorkerStatus();
                    } else {
                        showToast(data.message || 'Failed to stop workers', 'error');
                    }
                } catch (error) {
                    console.error('Error stopping workers:', error);
                    showToast('Failed to stop workers', 'error');
                }
            }
        }
        
        function displayWorkerStatus(status) {
            const html = `
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary">${status.total_workers}</h3>
                                <p class="text-muted mb-0">Total Workers Running</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info">${status.user_devices}</h3>
                                <p class="text-muted mb-0">Your Devices</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success">${status.connected_devices}</h3>
                                <p class="text-muted mb-0">Connected Devices</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Device Workers Detail</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Device Name</th>
                                                <th>Device Status</th>
                                                <th>Worker Status</th>
                                                <th>Queue Size</th>
                                                <th>Processed</th>
                                                <th>Failed</th>
                                                <th>Last Activity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${status.device_workers.map(worker => `
                                                <tr>
                                                    <td>${worker.device_name}</td>
                                                    <td>
                                                        <span class="badge bg-${worker.device_status === 'connected' || worker.device_status === 'online' ? 'success' : 'secondary'}">
                                                            ${worker.device_status}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-${getWorkerStatusColor(worker.worker_status)}">
                                                            ${worker.worker_status}
                                                        </span>
                                                        ${worker.current_campaign_id ? `<br><small class="text-muted">Campaign: ${worker.current_campaign_id}</small>` : ''}
                                                        ${worker.current_sequence_id ? `<br><small class="text-muted">Sequence: ${worker.current_sequence_id}</small>` : ''}
                                                    </td>
                                                    <td>${worker.queue_size}</td>
                                                    <td class="text-success">${worker.processed}</td>
                                                    <td class="text-danger">${worker.failed}</td>
                                                    <td>${worker.last_activity ? new Date(worker.last_activity).toLocaleString() : '-'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('workerStatusContent').innerHTML = html;
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'finished':
                case 'active':
                case 'sent':
                    return 'success';
                case 'pending':
                case 'scheduled':
                    return 'secondary';
                case 'triggered':
                    return 'info';
                case 'processing':
                    return 'primary';
                case 'failed':
                    return 'danger';
                case 'paused':
                    return 'warning';
                case 'draft':
                    return 'secondary';
                default:
                    return 'primary';
            }
        }
        
        function getWorkerStatusColor(status) {
            switch(status) {
                case 'processing':
                    return 'success';
                case 'idle':
                    return 'primary';
                case 'stopped':
                case 'not_running':
                    return 'secondary';
                default:
                    return 'warning';
            }
        }
        
        // Campaign Preview Function
        function previewCampaignMessage(campaign) {
            // Populate modal with campaign data
            document.getElementById('previewTitle').textContent = campaign.title || '-';
            document.getElementById('previewNiche').textContent = campaign.niche || '-';
            document.getElementById('previewTarget').innerHTML = `<span class="badge bg-${campaign.target_status === 'all' ? 'info' : campaign.target_status === 'prospect' ? 'primary' : 'success'}">${campaign.target_status || 'all'}</span>`;
            document.getElementById('previewDate').textContent = campaign.campaign_date ? formatCampaignDate(campaign.campaign_date) : '-';
            document.getElementById('previewTime').textContent = campaign.time_schedule || '-';
            
            // Show image if exists
            const imageDiv = document.getElementById('previewImage');
            if (campaign.image_url) {
                imageDiv.innerHTML = `<img src="${campaign.image_url}" class="img-fluid rounded mb-2" style="max-height: 300px;">`;
            } else {
                imageDiv.innerHTML = '';
            }
            
            // Show message with WhatsApp formatting
            document.getElementById('previewMessage').innerHTML = formatWhatsAppText(campaign.message || 'No message content');
            
            // Set timestamp
            const now = new Date();
            document.getElementById('previewTimestamp').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('campaignPreviewModal'));
            modal.show();
        }
        
        // Campaign Filter Function
        function filterCampaigns() {
            const filterDate = document.getElementById('campaignFilterDate').value;
            
            if (!filterDate) {
                loadCampaignSummary();
                return;
            }
            
            // Hide the info alert
            document.getElementById('campaignFilterInfo').style.display = 'none';
            
            // Clear range filters
            document.getElementById('campaignRangeStart').value = '';
            document.getElementById('campaignRangeEnd').value = '';
            
            // Filter the existing campaigns data client-side
            fetch('/api/campaigns/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        // Filter campaigns by date
                        const filteredResults = {
                            ...data.results,
                            recent_campaigns: data.results.recent_campaigns.filter(campaign => {
                                if (!campaign.campaign_date) return false;
                                const campaignDate = campaign.campaign_date.split('T')[0];
                                return campaignDate === filterDate;
                            })
                        };
                        
                        // Update counts
                        const filteredCampaigns = filteredResults.recent_campaigns;
                        filteredResults.campaigns = {
                            total: filteredCampaigns.length,
                            pending: filteredCampaigns.filter(c => c.status === 'scheduled' || c.status === 'pending').length,
                            sent: filteredCampaigns.filter(c => c.status === 'sent').length,
                            failed: filteredCampaigns.filter(c => c.status === 'failed').length
                        };
                        
                        displayCampaignSummary(filteredResults);
                    }
                })
                .catch(error => {
                    console.error('Error filtering campaigns:', error);
                    showAlert('danger', 'Error filtering campaigns');
                });
        }
        
        // Clear Campaign Filter
        function clearCampaignFilter() {
            document.getElementById('campaignFilterDate').value = '';
            document.getElementById('campaignRangeStart').value = '';
            document.getElementById('campaignRangeEnd').value = '';
            document.getElementById('campaignFilterInfo').style.display = 'block';
            loadCampaignSummary(); // This will show today and tomorrow only
        }
        
        // Filter Campaigns by Date Range
        function filterCampaignsByRange() {
            const startDate = document.getElementById('campaignRangeStart').value;
            const endDate = document.getElementById('campaignRangeEnd').value;
            
            if (!startDate || !endDate) {
                showAlert('warning', 'Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                showAlert('warning', 'Start date must be before end date');
                return;
            }
            
            // Hide the info alert
            document.getElementById('campaignFilterInfo').style.display = 'none';
            
            // Clear single date filter
            document.getElementById('campaignFilterDate').value = '';
            
            fetch('/api/campaigns/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        // Filter campaigns by date range
                        const filteredResults = {
                            ...data.results,
                            recent_campaigns: data.results.recent_campaigns.filter(campaign => {
                                if (!campaign.campaign_date) return false;
                                const campaignDate = campaign.campaign_date.split('T')[0];
                                return campaignDate >= startDate && campaignDate <= endDate;
                            })
                        };
                        
                        // Update counts
                        const filteredCampaigns = filteredResults.recent_campaigns;
                        filteredResults.campaigns = {
                            total: filteredCampaigns.length,
                            pending: filteredCampaigns.filter(c => c.status === 'scheduled' || c.status === 'pending').length,
                            sent: filteredCampaigns.filter(c => c.status === 'sent').length,
                            failed: filteredCampaigns.filter(c => c.status === 'failed').length
                        };
                        
                        displayCampaignSummary(filteredResults);
                    }
                })
                .catch(error => {
                    console.error('Error filtering campaigns:', error);
                    showAlert('danger', 'Error filtering campaigns');
                });
        }
        
        // Sequence Preview Function
        function previewSequenceMessages(sequence) {
            // Populate modal with sequence data
            document.getElementById('seqPreviewName').textContent = sequence.name || '-';
            document.getElementById('seqPreviewNiche').textContent = sequence.niche || '-';
            document.getElementById('seqPreviewTarget').innerHTML = `<span class="badge bg-${sequence.target_status === 'all' ? 'info' : sequence.target_status === 'prospect' ? 'primary' : 'success'}">${sequence.target_status || 'all'}</span>`;
            document.getElementById('seqPreviewDays').textContent = sequence.total_days || '-';
            
            // We need to fetch the sequence steps
            fetch(`/api/sequences/${sequence.id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results.steps) {
                        let stepsHtml = '<div class="timeline">';
                        
                        data.results.steps.forEach((step, index) => {
                            stepsHtml += `
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Day ${step.day} - ${step.send_time || 'Not set'}</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <strong>Message Type:</strong> ${step.message_type || 'text'}<br>
                                                <strong>Min Delay:</strong> ${step.min_delay_seconds}s<br>
                                                <strong>Max Delay:</strong> ${step.max_delay_seconds}s
                                            </div>
                                            <div class="col-md-6">
                                                <div class="border rounded p-3" style="background: #f0f2f5;">
                                                    <div class="whatsapp-preview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                                        ${step.media_url ? `<img src="${step.media_url}" class="img-fluid rounded mb-2" style="max-height: 200px;">` : ''}
                                                        <div style="white-space: pre-wrap; word-break: break-word;">${step.message || 'No message content'}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        stepsHtml += '</div>';
                        document.getElementById('sequenceMessagesPreview').innerHTML = stepsHtml;
                    } else {
                        document.getElementById('sequenceMessagesPreview').innerHTML = '<p class="text-muted">No steps found</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sequence steps:', error);
                    document.getElementById('sequenceMessagesPreview').innerHTML = '<p class="text-danger">Error loading steps</p>';
                });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('sequencePreviewModal'));
            modal.show();
        }
        
        // Sequence Filter Function
        function filterSequences() {
            const filterDate = document.getElementById('sequenceFilterDate').value;
            
            if (!filterDate) {
                loadSequenceSummary();
                return;
            }
            
            // Filter the existing sequences data client-side
            fetch('/api/sequences/summary')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        // Filter sequences by created date
                        const filteredResults = {
                            ...data.results,
                            recent_sequences: data.results.recent_sequences.filter(sequence => {
                                if (!sequence.created_at) return false;
                                const sequenceDate = sequence.created_at.split('T')[0];
                                return sequenceDate === filterDate;
                            })
                        };
                        
                        // Update counts
                        const filteredSequences = filteredResults.recent_sequences;
                        filteredResults.sequences = {
                            total: filteredSequences.length,
                            active: filteredSequences.filter(s => s.status === 'active').length,
                            paused: filteredSequences.filter(s => s.status === 'paused').length,
                            draft: filteredSequences.filter(s => s.status === 'draft').length
                        };
                        
                        displaySequenceSummary(filteredResults);
                    }
                })
                .catch(error => {
                    console.error('Error filtering sequences:', error);
                    showAlert('danger', 'Error filtering sequences');
                });
        }
        
        // Clear Sequence Filter
        function clearSequenceFilter() {
            document.getElementById('sequenceFilterDate').value = '';
            loadSequenceSummary();
        }
        
        // Campaign Device Report Functions
        let currentCampaignForReport = null;
        let currentDeviceReport = null; // Store the device report globally
        
        function showCampaignDeviceReport(campaign) {
            // Store campaign for use in other functions
            currentCampaignForReport = campaign;
            
            // Populate campaign details
            document.getElementById('reportTitle').textContent = campaign.title || '-';
            document.getElementById('reportNiche').textContent = campaign.niche || '-';
            document.getElementById('reportTarget').innerHTML = `<span class="badge bg-${campaign.target_status === 'all' ? 'info' : campaign.target_status === 'prospect' ? 'primary' : 'success'}">${campaign.target_status || 'all'}</span>`;
            document.getElementById('reportDate').textContent = campaign.campaign_date ? formatCampaignDate(campaign.campaign_date) : '-';
            document.getElementById('reportTime').textContent = campaign.time_schedule || '-';
            document.getElementById('reportStatus').innerHTML = `<span class="badge bg-${getStatusColor(campaign.status)}">${campaign.status}</span>`;
            
            // Show loading state
            document.getElementById('deviceReportTableBody').innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading device report...</td></tr>';
            
            // Fetch device report data
            fetch(`/api/campaigns/${campaign.id}/device-report`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        currentDeviceReport = data.results; // Store the report globally
                        displayDeviceReport(data.results);
                    } else {
                        document.getElementById('deviceReportTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load device report</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading device report:', error);
                    document.getElementById('deviceReportTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading device report</td></tr>';
                });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('campaignDeviceReportModal'));
            modal.show();
        }
        
        function displayDeviceReport(report) {
            // Update overall statistics
            document.getElementById('totalDevices').textContent = report.totalDevices || 0;
            document.getElementById('activeDevices').textContent = report.activeDevices || 0;
            document.getElementById('disconnectedDevices').textContent = report.disconnectedDevices || 0;
            document.getElementById('totalLeads').textContent = report.totalLeads || 0;
            document.getElementById('pendingLeads').textContent = report.pendingLeads || 0;
            document.getElementById('successLeads').textContent = report.successLeads || 0;
            document.getElementById('failedLeads').textContent = report.failedLeads || 0;
            
            // Update device table
            const tbody = document.getElementById('deviceReportTableBody');
            tbody.innerHTML = '';
            
            // Get campaign ID from the current campaign
            const campaignId = currentCampaignForReport ? currentCampaignForReport.id : '';
            
            if (report.devices && report.devices.length > 0) {
                report.devices.forEach(device => {
                    // Debug log
                    console.log('Device Report - Device:', device);
                    
                    const successRate = device.totalLeads > 0 
                        ? ((device.successLeads / device.totalLeads) * 100).toFixed(1) 
                        : 0;
                    
                    const row = `
                        <tr>
                            <td>${device.name || 'Unknown Device'}</td>
                            <td>
                                <span class="badge bg-${device.status === 'online' || device.status === 'connected' ? 'success' : 'danger'}">
                                    ${device.status === 'online' || device.status === 'connected' ? 'Active' : 'Disconnected'}
                                </span>
                            </td>
                            <td>
                                <a href="#" onclick="showLeadDetails('${device.id}', 'all', '${campaignId}'); return false;">
                                    ${device.totalLeads || 0}
                                </a>
                            </td>
                            <td>
                                <a href="#" onclick="showLeadDetails('${device.id}', 'pending', '${campaignId}'); return false;" class="text-warning">
                                    ${device.pendingLeads || 0}
                                </a>
                            </td>
                            <td>
                                <a href="#" onclick="showLeadDetails('${device.id}', 'success', '${campaignId}'); return false;" class="text-success">
                                    ${device.successLeads || 0}
                                </a>
                            </td>
                            <td>
                                <a href="#" onclick="showLeadDetails('${device.id}', 'failed', '${campaignId}'); return false;" class="text-danger">
                                    ${device.failedLeads || 0}
                                </a>
                            </td>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${successRate}%">
                                        ${successRate}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                ${device.failedLeads > 0 ? `
                                    <button class="btn btn-sm btn-outline-danger" onclick="retryFailedMessages('${device.id}', '${campaignId}'); return false;" title="Retry Failed Messages">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                ` : ''}
                                ${(currentCampaignForReport && currentCampaignForReport.ai === 'ai' && device.successLeads > 0 && (device.status === 'online' || device.status === 'connected' || device.status === 'active')) ? `
                                    <button class="btn btn-sm btn-outline-success ms-1" onclick="transferAILeadsToDevice('${device.id}', '${campaignId}'); return false;" title="Transfer successful AI leads to device">
                                        <i class="bi bi-arrow-right-square"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No device data available</td></tr>';
            }
        }
        
        function showLeadDetails(deviceId, status, campaignId) {
            // Debug log
            console.log('showLeadDetails called with:', { deviceId, status, campaignId });
            
            // Update modal title
            let statusText = status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('leadDetailsTitle').textContent = `${statusText} Leads`;
            
            // Show loading state
            document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading leads...</td></tr>';
            
            // Fetch lead details
            fetch(`/api/campaigns/${campaignId}/device/${deviceId}/leads?status=${status}`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        displayLeadDetails(data.results);
                    } else {
                        document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No leads found</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error loading lead details:', error);
                    document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading leads</td></tr>';
                });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('leadDetailsModal'));
            modal.show();
        }
        
        function showAllCampaignLeads(status) {
            if (!currentCampaignForReport) {
                showAlert('error', 'No campaign selected');
                return;
            }
            
            // Update modal title
            let statusText = status === 'all' ? 'All' : status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('leadDetailsTitle').textContent = `${statusText} Campaign Leads`;
            
            // Show loading state
            document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading all leads...</td></tr>';
            
            // We need to fetch leads from all devices for this campaign
            // Since we don't have a combined endpoint, we'll use the device report data
            const report = currentDeviceReport; // Store the report globally when loaded
            if (!report || !report.devices) {
                document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No device data available</td></tr>';
                const modal = new bootstrap.Modal(document.getElementById('leadDetailsModal'));
                modal.show();
                return;
            }
            
            // Collect all leads from all devices
            let allLeads = [];
            let fetchPromises = [];
            
            report.devices.forEach(device => {
                // Only fetch from devices that have leads
                if ((status === 'all' && device.totalLeads > 0) ||
                    (status === 'pending' && device.pendingLeads > 0) ||
                    (status === 'success' && device.successLeads > 0) ||
                    (status === 'failed' && device.failedLeads > 0)) {
                    
                    fetchPromises.push(
                        fetch(`/api/campaigns/${currentCampaignForReport.id}/device/${device.id}/leads?status=${status}`, { credentials: 'include' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.code === 'SUCCESS' && data.results) {
                                    // Add device name to each lead
                                    data.results.forEach(lead => {
                                        lead.deviceName = device.name;
                                    });
                                    allLeads = allLeads.concat(data.results);
                                }
                            })
                            .catch(error => {
                                console.error(`Error loading leads for device ${device.id}:`, error);
                            })
                    );
                }
            });
            
            // Wait for all fetches to complete
            Promise.all(fetchPromises).then(() => {
                if (allLeads.length > 0) {
                    displayLeadDetails(allLeads);
                } else {
                    document.getElementById('leadDetailsTableBody').innerHTML = '<tr><td colspan="4" class="text-center text-muted">No leads found</td></tr>';
                }
            });
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('leadDetailsModal'));
            modal.show();
        }
        
        function displayLeadDetails(leads) {
            const tbody = document.getElementById('leadDetailsTableBody');
            tbody.innerHTML = '';
            
            if (leads && leads.length > 0) {
                leads.forEach(lead => {
                    const row = `
                        <tr>
                            <td>${lead.name || 'Unknown'}</td>
                            <td>${lead.phone || '-'}</td>
                            <td>
                                <span class="badge bg-${lead.status === 'sent' || lead.status === 'delivered' || lead.status === 'success' ? 'success' : lead.status === 'failed' || lead.status === 'error' ? 'danger' : 'warning'}">
                                    ${lead.status || 'pending'}
                                </span>
                            </td>
                            <td>${lead.sentAt || '-'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No leads found</td></tr>';
            }
        }
        
        function exportDeviceReport() {
            // TODO: Implement export functionality
            showAlert('info', 'Export feature coming soon!');
        }
        
        // Note: Mock data generators removed - using real API data now
        
        function retryFailedMessages(deviceId, campaignId) {
            if (!confirm('Are you sure you want to retry all failed messages for this device?')) {
                return;
            }
            
            showToast('Retrying failed messages...', 'info');
            
            // Call API to retry failed messages
            fetch(`/api/campaigns/${campaignId}/device/${deviceId}/retry-failed`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    showToast('Failed messages queued for retry!', 'success');
                    // Refresh the device report
                    setTimeout(() => {
                        const campaign = { id: campaignId };
                        showCampaignDeviceReport(campaign);
                    }, 2000);
                } else {
                    showToast(data.message || 'Failed to retry messages', 'error');
                }
            })
            .catch(error => {
                console.error('Error retrying messages:', error);
                showToast('Error retrying messages', 'error');
            });
        }
        
        function generateMockLeadDetails(status) {
            const mockLeads = [
                { name: 'John Doe', phone: '+60123456789', status: status, sentAt: '2025-06-27 10:30 AM' },
                { name: 'Jane Smith', phone: '+60987654321', status: status, sentAt: '2025-06-27 10:35 AM' },
                { name: 'Ali Rahman', phone: '+60111222333', status: status, sentAt: '2025-06-27 10:40 AM' }
            ];
            
            return status === 'all' ? mockLeads : mockLeads.filter(l => l.status === status);
        }
        
        // Transfer AI Leads to Device
        function transferAILeadsToDevice(deviceId, campaignId) {
            if (!currentCampaignForReport || currentCampaignForReport.ai !== 'ai') {
                showToast('This is not an AI campaign', 'error');
                return;
            }
            
            // Find device info
            const device = currentDeviceReport.devices.find(d => d.id === deviceId);
            if (!device) {
                showToast('Device not found', 'error');
                return;
            }
            
            Swal.fire({
                title: 'Transfer AI Leads?',
                html: `
                    <p>This will copy <strong>${device.successLeads}</strong> successful AI leads to device <strong>${device.name}</strong>.</p>
                    <p class="text-info mt-2">The leads will:</p>
                    <ul class="text-start">
                        <li>Be added to the device's regular leads table</li>
                        <li>Remain in the AI leads table as well</li>
                        <li>Be available for personal campaigns on this device</li>
                    </ul>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Transfer',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    showToast('Transferring AI leads...', 'info');
                    
                    // First, get the successful AI leads
                    fetch(`/api/campaigns/${campaignId}/device/${deviceId}/leads?status=success`, {
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'SUCCESS' && data.results && data.results.length > 0) {
                            // Create promises to add each lead to the device
                            const addPromises = data.results.map(lead => {
                                return fetch('/api/leads', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        device_id: deviceId,
                                        name: lead.name || 'AI Lead',
                                        phone: lead.phone
                                    }),
                                    credentials: 'include'
                                });
                            });
                            
                            // Execute all lead creations
                            return Promise.all(addPromises).then(() => data.results.length);
                        } else {
                            throw new Error('No successful leads found');
                        }
                    })
                    .then(transferredCount => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Transfer Complete!',
                            html: `Successfully transferred ${transferredCount} leads to device ${device.name}`,
                            timer: 3000,
                            showConfirmButton: false
                        });
                    })
                    .catch(error => {
                        console.error('Error transferring leads:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Transfer Failed',
                            text: error.message || 'Failed to transfer leads',
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        }
        
        // Auto-refresh for worker status
        document.getElementById('workerAutoRefresh')?.addEventListener('change', function() {
            if (this.checked) {
                workerRefreshInterval = setInterval(loadWorkerStatus, 5000);
            } else {
                clearInterval(workerRefreshInterval);
            }
        });
        
        // Load summaries when tabs are clicked
        document.getElementById('campaign-summary-tab')?.addEventListener('shown.bs.tab', function() {
            loadCampaignSummary();
        });
        
        document.getElementById('sequence-summary-tab')?.addEventListener('shown.bs.tab', function() {
            loadSequenceSummary();
        });
        
        document.getElementById('worker-status-tab')?.addEventListener('shown.bs.tab', function() {
            loadWorkerStatus();
            if (document.getElementById('workerAutoRefresh').checked) {
                workerRefreshInterval = setInterval(loadWorkerStatus, 5000);
            }
        });
        
        // Clear worker refresh when leaving tab
        document.getElementById('worker-status-tab')?.addEventListener('hidden.bs.tab', function() {
            clearInterval(workerRefreshInterval);
        });
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer') || (() => {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(container);
                return container;
            })();
            
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            const toast = new bootstrap.Toast(toastElement.firstElementChild);
            toastContainer.appendChild(toastElement.firstElementChild);
            toast.show();
        }
        
        // System Status Check Functions
        function checkRedisStatus() {
            window.open('/status/redis', 'RedisStatus', 'width=900,height=700');
        }
        
        function checkDeviceWorker() {
            window.open('/status/device-worker', 'DeviceWorkerStatus', 'width=900,height=700');
        }
        
        function checkAllWorkers() {
            window.open('/status/all-workers', 'AllWorkersStatus', 'width=1200,height=800');
        }
        
        // Format date helper function
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        // Format WhatsApp text to HTML
        function formatWhatsAppText(text) {
            if (!text) return '';
            
            // Escape HTML first
            text = text.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
            
            // Apply WhatsApp formatting
            // Monospace (triple backticks) - process first to avoid conflicts
            text = text.replace(/```(.*?)```/g, '<code style="background: #f0f2f5; padding: 2px 4px; border-radius: 4px; font-family: monospace;">$1</code>');
            
            // Bold (*text*)
            text = text.replace(/\*([^*]+)\*/g, '<strong>$1</strong>');
            
            // Italic (_text_)
            text = text.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Strikethrough (~text~)
            text = text.replace(/~([^~]+)~/g, '<del>$1</del>');
            
            // Convert newlines to <br>
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        // Update live preview for campaign message
        function updateLivePreview() {
            const message = document.getElementById('campaignMessage').value;
            const previewDiv = document.getElementById('livePreviewMessage');
            
            if (message.trim()) {
                previewDiv.innerHTML = formatWhatsAppText(message);
            } else {
                previewDiv.innerHTML = '<span class="text-muted">Your formatted message will appear here...</span>';
            }
        }
        
        // Update live preview for AI campaign message
        function updateAILivePreview() {
            const message = document.getElementById('aiCampaignMessage').value;
            const previewDiv = document.getElementById('aiLivePreviewMessage');
            
            if (message.trim()) {
                previewDiv.innerHTML = formatWhatsAppText(message);
            } else {
                previewDiv.innerHTML = '<span class="text-muted">Your formatted message will appear here...</span>';
            }
        }
        
        // Compress image file to 350KB max
        function compressImageFile(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Start with reasonable dimensions
                    let width = img.width;
                    let height = img.height;
                    let quality = 0.9;
                    
                    // First resize if too large
                    const maxSize = 1000;
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress until under 350KB
                    function tryCompress() {
                        canvas.toBlob(function(blob) {
                            if (blob.size > 350 * 1024 && quality > 0.1) {
                                quality -= 0.1;
                                tryCompress();
                            } else {
                                callback(blob);
                            }
                        }, 'image/jpeg', quality);
                    }
                    
                    tryCompress();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // AI Lead Management Functions
        function loadAILeads() {
            console.log('Loading AI leads...');
            fetch('/api/leads-ai', { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    console.log('AI leads response:', data);
                    if (data.code === 'SUCCESS' && data.results) {
                        displayAILeads(data.results);
                        updateAILeadStats(data.results);
                    }
                })
                .catch(error => {
                    console.error('Error loading AI leads:', error);
                    showToast('Failed to load AI leads', 'error');
                });
        }

        function displayAILeads(leads) {
            const tbody = document.getElementById('aiLeadsTableBody');
            tbody.innerHTML = '';
            
            if (!leads || leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No AI leads found</td></tr>';
                return;
            }
            
            leads.forEach(lead => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${lead.name}</td>
                    <td>${lead.phone}</td>
                    <td>${lead.niche || '-'}</td>
                    <td><span class="badge bg-${lead.target_status === 'customer' ? 'success' : 'primary'}">${lead.target_status}</span></td>
                    <td>${getAIStatusBadge(lead.status)}</td>
                    <td>${lead.device_id || '-'}</td>
                    <td>${formatDate(lead.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editAILead(${lead.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAILead(${lead.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateAILeadStats(leads) {
            const stats = {
                total: leads.length,
                pending: 0,
                sent: 0,
                failed: 0
            };
            
            leads.forEach(lead => {
                switch(lead.status) {
                    case 'pending':
                        stats.pending++;
                        break;
                    case 'sent':
                        stats.sent++;
                        break;
                    case 'failed':
                        stats.failed++;
                        break;
                }
            });
            
            document.getElementById('aiTotalLeads').textContent = stats.total;
            document.getElementById('aiPendingLeads').textContent = stats.pending;
            document.getElementById('aiSentLeads').textContent = stats.sent;
            document.getElementById('aiFailedLeads').textContent = stats.failed;
        }

        function getAIStatusBadge(status) {
            const badges = {
                'pending': '<span class="badge bg-warning">Pending</span>',
                'assigned': '<span class="badge bg-info">Assigned</span>',
                'sent': '<span class="badge bg-success">Sent</span>',
                'failed': '<span class="badge bg-danger">Failed</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }
        
        function showAddAILeadModal() {
            document.getElementById('aiLeadModalTitle').textContent = 'Add New Lead';
            document.getElementById('aiLeadForm').reset();
            document.getElementById('aiLeadId').value = '';
            const modal = new bootstrap.Modal(document.getElementById('aiLeadModal'));
            modal.show();
        }
        
        // Export AI Leads
        function exportAILeads() {
            fetch('/api/leads-ai')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        // Convert to CSV
                        const headers = ['Name', 'Phone', 'Niche', 'Status', 'Notes', 'Created At'];
                        const csvContent = [
                            headers.join(','),
                            ...data.results.map(lead => [
                                `"${lead.name || ''}"`,
                                `"${lead.phone || ''}"`,
                                `"${lead.niche || ''}"`,
                                `"${lead.target_status || ''}"`,
                                `"${(lead.notes || '').replace(/"/g, '""')}"`,
                                `"${lead.created_at || ''}"`
                            ].join(','))
                        ].join('\n');
                        
                        // Download file
                        const blob = new Blob([csvContent], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `ai_leads_${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        showToast('AI leads exported successfully', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error exporting AI leads:', error);
                    showToast('Failed to export AI leads', 'error');
                });
        }
        
        // Import AI Leads
        function importAILeads() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const csv = event.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',');
                    
                    // Skip header row
                    const leads = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].match(/(".*?"|[^,]+)/g);
                            if (values) {
                                leads.push({
                                    name: values[0]?.replace(/"/g, '') || '',
                                    phone: values[1]?.replace(/"/g, '') || '',
                                    niche: values[2]?.replace(/"/g, '') || '',
                                    target_status: values[3]?.replace(/"/g, '') || 'prospect',
                                    notes: values[4]?.replace(/"/g, '') || ''
                                });
                            }
                        }
                    }
                    
                    // Import leads
                    if (leads.length > 0) {
                        importAILeadsBatch(leads);
                    } else {
                        showToast('No valid leads found in file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // Import batch of AI leads
        function importAILeadsBatch(leads) {
            let imported = 0;
            let failed = 0;
            
            Promise.all(leads.map(lead => 
                fetch('/api/leads-ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(lead)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        imported++;
                    } else {
                        failed++;
                    }
                })
                .catch(() => failed++)
            ))
            .then(() => {
                if (imported > 0) {
                    showToast(`Successfully imported ${imported} AI leads${failed > 0 ? `, ${failed} failed` : ''}`, 'success');
                    loadAILeads(); // Refresh the list
                } else {
                    showToast('Failed to import AI leads', 'error');
                }
            });
        }
        
        function saveAILead() {
            const leadId = document.getElementById('aiLeadId').value;
            const isEdit = !!leadId;
            
            const leadData = {
                name: document.getElementById('aiLeadName').value,
                phone: document.getElementById('aiLeadPhone').value,
                niche: document.getElementById('aiLeadNiche').value,
                target_status: document.getElementById('aiLeadTargetStatus').value,
                notes: document.getElementById('aiLeadNotes').value
            };
            
            if (!leadData.name || !leadData.phone) {
                showToast('Name and phone are required', 'error');
                return;
            }
            
            const url = isEdit ? `/api/leads-ai/${leadId}` : '/api/leads-ai';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(leadData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('aiLeadModal'));
                    modal.hide();
                    loadAILeads();
                    showToast(isEdit ? 'AI Lead updated successfully' : 'AI Lead added successfully', 'success');
                } else {
                    showToast(data.message || 'Failed to save AI lead', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving AI lead:', error);
                showToast('Failed to save AI lead', 'error');
            });
        }
        
        function editAILead(leadId) {
            fetch(`/api/leads-ai`, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS' && data.results) {
                        const lead = data.results.find(l => l.id === leadId);
                        if (lead) {
                            document.getElementById('aiLeadModalTitle').textContent = 'Edit AI Lead';
                            document.getElementById('aiLeadId').value = lead.id;
                            document.getElementById('aiLeadName').value = lead.name;
                            document.getElementById('aiLeadPhone').value = lead.phone;
                            document.getElementById('aiLeadEmail').value = lead.email || '';
                            document.getElementById('aiLeadNiche').value = lead.niche || '';
                            document.getElementById('aiLeadTargetStatus').value = lead.target_status;
                            document.getElementById('aiLeadNotes').value = lead.notes || '';
                            const modal = new bootstrap.Modal(document.getElementById('aiLeadModal'));
                            modal.show();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading lead details:', error);
                    showToast('Failed to load lead details', 'error');
                });
        }
        
        function deleteAILead(leadId) {
            Swal.fire({
                title: 'Delete AI Lead?',
                text: "This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/leads-ai/${leadId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'SUCCESS') {
                            loadAILeads();
                            showToast('AI Lead deleted successfully', 'success');
                        } else {
                            showToast(data.message || 'Failed to delete AI lead', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting AI lead:', error);
                        showToast('Failed to delete AI lead', 'error');
                    });
                }
            });
        }
        
        function showCreateAICampaignModal() {
            document.getElementById('aiCampaignForm').reset();
            document.getElementById('aiCampaignDate').value = new Date().toISOString().split('T')[0];
            const modal = new bootstrap.Modal(document.getElementById('aiCampaignModal'));
            modal.show();
        }
        
        function saveAICampaign() {
            const imageFile = document.getElementById('aiCampaignImage').files[0];
            
            // First, handle image upload if provided
            const processImage = new Promise((resolve) => {
                if (imageFile) {
                    compressImageFile(imageFile, function(compressedBlob) {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            resolve(reader.result); // base64 string
                        };
                        reader.readAsDataURL(compressedBlob);
                    });
                } else {
                    resolve(''); // No image
                }
            });
            
            processImage.then(imageBase64 => {
                const campaignData = {
                    title: document.getElementById('aiCampaignTitle').value,
                    niche: document.getElementById('aiCampaignNiche').value,
                    target_status: document.getElementById('aiCampaignTargetStatus').value,
                    message: document.getElementById('aiCampaignMessage').value,
                    image_url: imageBase64, // Using base64 image
                    campaign_date: document.getElementById('aiCampaignDate').value,
                    time_schedule: document.getElementById('aiCampaignTime').value,
                    limit: parseInt(document.getElementById('aiDeviceLimit').value),
                    min_delay_seconds: parseInt(document.getElementById('aiMinDelay').value),
                    max_delay_seconds: parseInt(document.getElementById('aiMaxDelay').value),
                    ai: 'ai'
                };
                
                if (!campaignData.title || !campaignData.niche || !campaignData.message || 
                    !campaignData.campaign_date || !campaignData.limit) {
                    showToast('Please fill all required fields', 'error');
                    return;
                }
                
                if (campaignData.limit <= 0) {
                    showToast('Device limit must be greater than 0', 'error');
                    return;
                }
                
                fetch('/api/campaigns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(campaignData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 'SUCCESS') {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('aiCampaignModal'));
                        modal.hide();
                        loadCampaigns();
                        showToast('AI Campaign created successfully', 'success');
                        
                        Swal.fire({
                            title: 'Campaign Created!',
                            text: 'Do you want to trigger the campaign now?',
                            icon: 'success',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, trigger now',
                            cancelButtonText: 'No, trigger later'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                triggerAICampaign(data.results.id);
                            }
                        });
                    } else {
                        showToast(data.message || 'Failed to create AI campaign', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error creating AI campaign:', error);
                    showToast('Failed to create AI campaign', 'error');
                });
            });
        }
        
        function triggerAICampaign(campaignId) {
            showToast('Triggering AI campaign...', 'info');
            
            fetch(`/api/campaigns-ai/${campaignId}/trigger`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    showToast('AI Campaign triggered successfully! Processing leads...', 'success');
                    loadCampaigns();
                } else {
                    showToast(data.message || 'Failed to trigger AI campaign', 'error');
                }
            })
            .catch(error => {
                console.error('Error triggering AI campaign:', error);
                showToast('Failed to trigger AI campaign', 'error');
            });
        }
        
        // Initialize AI Management when tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            const aiTab = document.getElementById('manage-ai-tab');
            if (aiTab) {
                aiTab.addEventListener('shown.bs.tab', function() {
                    loadAILeads();
                });
            }
        });
        
        // Clear ALL WhatsApp Sessions
        function clearAllSessions() {
            Swal.fire({
                title: 'Clear ALL WhatsApp Sessions?',
                html: `
                    <div class="text-start">
                        <p class="text-danger"><strong>⚠️ WARNING: This will clear ALL WhatsApp session data!</strong></p>
                        <p>This action will:</p>
                        <ul class="text-start">
                            <li>Remove ALL stored WhatsApp sessions from the database</li>
                            <li>Log out ALL connected devices</li>
                            <li>Clear any cached session data</li>
                        </ul>
                        <p class="text-warning mt-3">Use this only if you're experiencing issues with wrong phone numbers or corrupted sessions.</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, Clear ALL Sessions',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#dc3545',
                focusCancel: true
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoading();
                    
                    fetch('/api/devices/clear-all-sessions', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 'SUCCESS') {
                            // Update all devices to offline
                            devices.forEach(device => {
                                device.status = 'offline';
                                device.jid = '';
                            });
                            renderDevices();
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Sessions Cleared!',
                                html: `
                                    <p>All WhatsApp sessions have been cleared.</p>
                                    <p class="text-info">You can now connect with your correct WhatsApp number.</p>
                                `,
                                confirmButtonText: 'OK'
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Failed to Clear Sessions',
                                text: data.message || 'An error occurred while clearing sessions.'
                            });
                        }
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error clearing sessions:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to clear sessions. Please try again.'
                        });
                        hideLoading();
                    });
                }
            });
        }
    </script>
</body>
</html>