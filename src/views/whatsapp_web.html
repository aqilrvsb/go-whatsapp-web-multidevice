            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                checkSendButton();
            });
            
            // Handle enter key
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // Check if send button should be enabled
        function checkSendButton() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = !currentChat || messageInput.value.trim() === '';
        }
        
        // Send message
        function sendMessage() {
            if (!currentChat) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // Disable input while sending
            messageInput.disabled = true;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            
            // Prepare request
            const requestData = {
                chatId: currentChat.id,
                message: message
            };
            
            fetch(`/api/devices/${deviceId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    // Clear input
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    
                    // Show success toast
                    showToast('Message sent', 'success');
                    
                    // Reload messages after a short delay
                    setTimeout(() => {
                        loadMessages(currentChat.id);
                    }, 500);
                } else {
                    showToast(data.message || 'Failed to send message', 'error');
                }
            })
            .catch(err => {
                console.error('Error sending message:', err);
                showToast('Failed to send message', 'error');
            })
            .finally(() => {
                // Re-enable input
                messageInput.disabled = false;
                checkSendButton();
                messageInput.focus();
            });
        }
        
        // Select image
        function selectImage() {
            document.getElementById('imageInput').click();
        }
        
        // Handle image selection
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('Image size must be less than 10MB', 'error');
                return;
            }
            
            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageData = e.target.result;
                document.getElementById('previewImg').src = selectedImageData;
                document.getElementById('imagePreview').style.display = 'flex';
            };
            reader.readAsDataURL(file);
        }
        
        // Cancel image
        function cancelImage() {
            selectedImageData = null;
            document.getElementById('imageInput').value = '';
            document.getElementById('imageCaption').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }
        
        // Send image
        function sendImage() {
            if (!currentChat || !selectedImageData) return;
            
            const caption = document.getElementById('imageCaption').value.trim();
            
            // Prepare request
            const requestData = {
                chatId: currentChat.id,
                message: caption,
                imageB64: selectedImageData
            };
            
            // Show loading
            showToast('Sending image...', 'info');
            
            fetch(`/api/devices/${deviceId}/send`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(requestData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 'SUCCESS') {
                    showToast('Image sent', 'success');
                    cancelImage();
                    
                    // Reload messages
                    setTimeout(() => {
                        loadMessages(currentChat.id);
                    }, 500);
                } else {
                    showToast(data.message || 'Failed to send image', 'error');
                }
            })
            .catch(err => {
                console.error('Error sending image:', err);
                showToast('Failed to send image', 'error');
            });
        }
        
        // View image in full size
        function viewImage(imageUrl) {
            window.open(imageUrl, '_blank');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'check-circle-fill' : 
                         type === 'error' ? 'x-circle-fill' : 
                         'info-circle-fill';
            
            toast.innerHTML = `
                <i class="bi bi-${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Sync chats function
        function syncChats(silent = false) {
            if (!silent) {
                // Show loading indicator
                const syncBtn = document.querySelector('button[onclick="syncChats()"]');
                if (syncBtn) {
                    const originalContent = syncBtn.innerHTML;
                    syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Syncing...';
                    syncBtn.disabled = true;
                    
                    // Reset button after operation
                    setTimeout(() => {
                        syncBtn.innerHTML = originalContent;
                        syncBtn.disabled = false;
                    }, 3000);
                }
            }
            
            // Call sync endpoint
            fetch(`/api/devices/${deviceId}/sync`, {
                method: 'POST',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (!silent) {
                    // Show success message
                    showToast('Sync initiated! Refreshing chats...', 'success');
                    
                    // Reload chats after a short delay
                    setTimeout(() => {
                        loadChats();
                    }, 2000);
                }
            })
            .catch(err => {
                console.error('Error syncing:', err);
                if (!silent) {
                    showToast('Failed to sync chats', 'error');
                }
            });
        }
        
        // Auto-refresh messages every 5 seconds when a chat is selected
        setInterval(() => {
            if (currentChat) {
                loadMessages(currentChat.id);
            }
        }, 5000);
    </script>
</body>
</html>