<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Web</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    body {
      background-color: #f0f2f5;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    /* Container - responsive for desktop */
    .chat-container {
      width: 100%;
      height: 100vh;
      background-color: #fff;
      display: flex;
      position: relative;
      margin: 0;
    }

    /* Device info bar */
    .device-info-bar {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #00a884;
      color: white;
      padding: 8px 16px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
    }

    .device-info-bar.offline {
      background: #dc3545;
    }

    .device-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: #70e064;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: #ff5555;
      animation: none;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .btn-dashboard {
      background: white;
      color: #00a884;
      border: none;
      padding: 6px 16px;
      border-radius: 4px;
      font-size: 14px;
      text-decoration: none;
      cursor: pointer;
    }

    .btn-dashboard:hover {
      opacity: 0.9;
    }

    /* Sidebar for desktop, full width for mobile */
    .sidebar {
      width: 100%;
      max-width: 380px;
      height: calc(100vh - 40px);
      margin-top: 40px;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .header {
      background-color: #f0f2f5;
      color: #54656f;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 60px;
    }

    .header h1 {
      font-size: 19px;
      font-weight: 600;
      color: #111b21;
    }

    .header .icons {
      display: flex;
      gap: 8px;
    }

    .header .icons button {
      background: none;
      border: none;
      color: #54656f;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .header .icons button:hover {
      background: rgba(0,0,0,0.05);
    }

    /* Search bar */
    .search-bar {
      padding: 8px 12px;
      background: #fff;
      border-bottom: 1px solid #e9edef;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 40px;
      border: none;
      border-radius: 8px;
      background: #f0f2f5;
      outline: none;
      font-size: 14px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #54656f;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      background: #fff;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .chat-item:hover {
      background-color: #f5f6f6;
    }

    .chat-item.active {
      background-color: #f0f2f5;
    }

    .chat-item .avatar {
      width: 49px;
      height: 49px;
      border-radius: 50%;
      margin-right: 13px;
      overflow: hidden;
      background-color: #dfe5e7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .chat-item .avatar svg {
      width: 28px;
      height: 28px;
      fill: #aebac1;
    }

    .chat-item .info {
      flex: 1;
      min-width: 0;
      border-bottom: 1px solid #e9edef;
      padding-bottom: 12px;
    }

    .chat-item:last-child .info {
      border-bottom: none;
    }

    .chat-item .info h3 {
      font-size: 17px;
      font-weight: 400;
      color: #111b21;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-bottom: 3px;
    }

    .chat-item .info p {
      font-size: 14px;
      color: #667781;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-item .meta {
      position: absolute;
      right: 16px;
      top: 12px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    .chat-item .time {
      font-size: 12px;
      color: #667781;
    }

    .unread-count {
      background: #25d366;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 1px 6px;
      border-radius: 11px;
      min-width: 20px;
      text-align: center;
    }

    /* Chat window */
    .chat-window {
      display: none;
      flex: 1;
      flex-direction: column;
      background-color: #efeae2;
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      background-size: 412.5px 749.25px;
      background-repeat: repeat;
      margin-top: 40px;
      height: calc(100vh - 40px);
    }

    .chat-header {
      background-color: #f0f2f5;
      color: #111b21;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      height: 60px;
    }

    .chat-header .back {
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
      display: none;
      color: #54656f;
    }

    .chat-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 15px;
      overflow: hidden;
      background-color: #dfe5e7;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
    }

    .chat-header .avatar svg {
      width: 24px;
      height: 24px;
      fill: #aebac1;
    }

    .chat-header .info {
      flex: 1;
      cursor: pointer;
    }

    .chat-header h2 {
      font-size: 16px;
      font-weight: 500;
      color: #111b21;
    }

    .chat-header .status {
      font-size: 13px;
      color: #667781;
    }

    .chat-header .actions {
      display: flex;
      gap: 8px;
    }

    .chat-header .actions button {
      background: none;
      border: none;
      color: #54656f;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .chat-header .actions button:hover {
      background: rgba(0,0,0,0.05);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px 9%;
      display: flex;
      flex-direction: column;
      -webkit-overflow-scrolling: touch;
    }

    .date-divider {
      text-align: center;
      margin: 20px 0;
      position: relative;
    }

    .date-divider span {
      background: rgba(255,255,255,0.95);
      color: #54656f;
      font-size: 12.5px;
      padding: 5px 12px;
      border-radius: 7.5px;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message {
      max-width: 65%;
      margin-bottom: 2px;
      display: flex;
      flex-direction: column;
    }

    .message.sent {
      margin-left: auto;
    }

    .message.received {
      margin-right: auto;
    }

    .message-bubble {
      padding: 6px 7px 8px 9px;
      border-radius: 7.5px;
      font-size: 14.2px;
      line-height: 19px;
      position: relative;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }

    .message.sent .message-bubble {
      background-color: #d9fdd3;
      border-top-right-radius: 0;
    }

    .message.received .message-bubble {
      background-color: #fff;
      border-top-left-radius: 0;
    }

    .message .content {
      word-wrap: break-word;
      color: #111b21;
      padding-right: 34px;
    }

    .message .time {
      font-size: 11px;
      color: #667781;
      float: right;
      margin: -2px -5px -5px 5px;
      display: flex;
      align-items: center;
      gap: 2px;
    }
    
    .message .ticks {
      font-size: 14px;
      color: #8696a0;
      margin-left: 3px;
    }
    
    .message.sent .ticks {
      color: #8696a0;
    }

    .message.image .message-bubble {
      padding: 0;
      background: transparent;
      box-shadow: none;
    }

    .message.image img {
      max-width: 330px;
      max-height: 330px;
      border-radius: 7.5px;
      display: block;
      cursor: pointer;
      width: 100%;
      height: auto;
    }

    .message.image .caption {
      padding: 5px 7px 6px 7px;
      background-color: #d9fdd3;
      border-radius: 0 0 7.5px 7.5px;
      margin-top: -5px;
    }

    .message.received.image .caption {
      background-color: #fff;
    }

    .message.image .time {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.35);
      color: #fff;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 11px;
      margin: 0;
    }

    .message.image.has-caption .time {
      position: static;
      background: none;
      color: #667781;
      float: right;
      margin: -2px -5px -5px 5px;
    }

    .input-area {
      display: flex;
      align-items: flex-end;
      padding: 5px 10px;
      background-color: #f0f2f5;
      border-top: 1px solid #e9edef;
      gap: 5px;
      min-height: 62px;
    }

    .attachment-btn {
      background: none;
      border: none;
      color: #54656f;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      margin: 5px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .attachment-btn:hover {
      background: rgba(0,0,0,0.05);
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 9px 12px;
      border: none;
      border-radius: 21px;
      background-color: #fff;
      font-size: 15px;
      outline: none;
      resize: none;
      max-height: 100px;
      overflow-y: auto;
      line-height: 20px;
    }

    .send-btn {
      background: none;
      border: none;
      color: #54656f;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      margin: 5px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .send-btn:hover {
      background: rgba(0,0,0,0.05);
    }

    input[type="file"] {
      display: none;
    }

    /* Empty state */
    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: #f8f9fa;
      margin-top: 40px;
      height: calc(100vh - 40px);
    }

    .empty-state h3 {
      color: #41525d;
      font-size: 28px;
      font-weight: 300;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #667781;
      font-size: 14px;
      line-height: 20px;
      text-align: center;
      max-width: 500px;
    }

    /* Loading */
    .loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      padding: 40px;
      color: #667781;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e9edef;
      border-top-color: #00a884;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Image preview modal */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .image-preview-content {
      background: #2a2f36;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      padding: 16px;
    }

    .preview-header {
      color: #e9edef;
      font-size: 19px;
      font-weight: 500;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .close-preview {
      background: none;
      border: none;
      color: #aebac1;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }

    .preview-image {
      max-width: 100%;
      max-height: 400px;
      display: block;
      margin: 0 auto 16px;
      border-radius: 4px;
    }

    .caption-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #30383d;
      border-radius: 24px;
      margin-bottom: 16px;
      outline: none;
      font-size: 15px;
      background: #1e252b;
      color: #e9edef;
    }

    .caption-input:focus {
      border-color: #00a884;
    }

    .preview-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .preview-actions button {
      padding: 10px 24px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14.5px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-cancel {
      background: #30383d;
      color: #e9edef;
    }

    .btn-send {
      background: #00a884;
      color: #111b21;
    }

    .btn-cancel:hover {
      background: #3c464f;
    }

    .btn-send:hover {
      background: #06cf9c;
    }

    .hidden {
      display: none !important;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      max-width: 300px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      border-left: 4px solid #00a884;
    }

    .notification.error {
      border-left: 4px solid #dc3545;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .chat-container {
        max-width: 100%;
      }

      .sidebar {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 100%;
        z-index: 10;
        display: block;
      }

      .chat-window {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        z-index: 20;
      }

      .chat-window.active {
        display: flex;
      }

      .chat-header .back {
        display: block;
      }

      .empty-state {
        display: none;
      }

      .messages {
        padding: 20px 3%;
      }
    }

    @media (min-width: 769px) {
      .sidebar.hidden {
        display: none;
      }

      .chat-window {
        display: flex;
      }

      .empty-state {
        display: flex;
      }

      .chat-window.hidden {
        display: none;
      }
    }

    /* 1280x720 optimizations */
    @media (min-width: 1280px) and (max-height: 720px) {
      .header {
        height: 50px;
        padding: 8px 16px;
      }
      
      .chat-header {
        height: 50px;
        padding: 8px 16px;
      }
      
      .messages {
        padding: 15px 7%;
      }
      
      .empty-state h3 {
        font-size: 24px;
      }
      
      .input-area {
        min-height: 56px;
        padding: 4px 10px;
      }
      
      .message {
        max-width: 60%;
      }
    }
  </style>
</head>
<body>
  <div class="device-info-bar" id="deviceInfoBar">
    <div class="device-info">
      <div class="status-dot" id="statusDot"></div>
      <span>Device: <strong id="deviceName">Loading...</strong></span>
      <span>|</span>
      <span>Phone: <strong id="devicePhone">Loading...</strong></span>
    </div>
    <a href="/dashboard" class="btn-dashboard">← Back to Dashboard</a>
  </div>

  <div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="header">
        <h1>WhatsApp</h1>
        <div class="icons">
          <button onclick="loadChats()" title="Refresh">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
          <button title="Menu">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
        </div>
      </div>
      <div class="search-bar">
        <div class="search-wrapper">
          <i class="bi bi-search search-icon"></i>
          <input type="text" class="search-input" id="searchInput" placeholder="Search or start new chat">
        </div>
      </div>
      <div class="chat-list" id="chatList">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading chats...</p>
        </div>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
      <div class="chat-header">
        <span class="back" onclick="showChatList()">
          <i class="bi bi-arrow-left"></i>
        </span>
        <div class="avatar" id="chatAvatar">
          <svg viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
        </div>
        <div class="info">
          <h2 id="chatName">Select a chat</h2>
          <div class="status" id="chatStatus">tap for more info</div>
        </div>
        <div class="actions">
          <button title="Search">
            <i class="bi bi-search"></i>
          </button>
          <button title="Menu">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
        </div>
      </div>
      <div class="messages" id="messages">
        <!-- Messages will be loaded here -->
      </div>
      <div class="input-area">
        <button class="attachment-btn" onclick="selectImage()" title="Attach">
          <i class="bi bi-paperclip"></i>
        </button>
        <input type="file" id="imageUpload" accept="image/*">
        <div class="input-wrapper">
          <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1"></textarea>
        </div>
        <button class="send-btn" onclick="sendMessage()" title="Send">
          <i class="bi bi-send-fill"></i>
        </button>
      </div>
    </div>

    <!-- Empty State for Desktop -->
    <div class="empty-state" id="emptyState">
      <div style="font-size: 96px; color: #00a884; margin-bottom: 28px;">
        <i class="bi bi-whatsapp"></i>
      </div>
      <h3>WhatsApp Web</h3>
      <p>Send and receive messages without keeping your phone online.</p>
      <p>Use WhatsApp on up to 4 linked devices and 1 phone at the same time.</p>
    </div>
  </div>

  <!-- Image Preview Modal -->
  <div id="imagePreviewModal" class="image-preview-modal hidden">
    <div class="image-preview-content">
      <div class="preview-header">
        <span>Send Image</span>
        <button class="close-preview" onclick="cancelImage()">×</button>
      </div>
      <img id="previewImage" class="preview-image" alt="Preview">
      <input type="text" class="caption-input" id="captionInput" placeholder="Add a caption...">
      <div class="preview-actions">
        <button class="btn-cancel" onclick="cancelImage()">Cancel</button>
        <button class="btn-send" onclick="sendImage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Get device ID from URL
    const pathParts = window.location.pathname.split('/');
    const deviceId = pathParts[2];
    let currentChat = null;
    let allChats = [];
    let selectedImageFile = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadDeviceInfo();
      setupSearch();
      setupImageInput();
      setupMessageInput();
      
      // Check if mobile
      if (window.innerWidth <= 768) {
        document.getElementById('emptyState').style.display = 'none';
      }
    });

    // Load device info
    function loadDeviceInfo() {
      fetch(`/api/devices/${deviceId}`, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.code === 'SUCCESS' && data.results) {
            const device = data.results;
            document.getElementById('deviceName').textContent = device.name || deviceId;
            document.getElementById('devicePhone').textContent = device.phone || 'Not connected';
            
            if (device.status === 'online') {
              document.getElementById('deviceInfoBar').classList.remove('offline');
              document.getElementById('statusDot').classList.remove('offline');
              loadChats();
            } else {
              document.getElementById('deviceInfoBar').classList.add('offline');
              document.getElementById('statusDot').classList.add('offline');
              showOfflineMessage();
            }
          }
        })
        .catch(err => {
          console.error('Error loading device:', err);
          showOfflineMessage();
        });
    }

    // Show offline message
    function showOfflineMessage() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #667781;">
          <div style="font-size: 48px; margin-bottom: 16px;">📵</div>
          <h5 style="color: #111b21; margin-bottom: 8px;">Device Offline</h5>
          <p style="font-size: 14px;">This device is not connected to WhatsApp</p>
        </div>
      `;
    }

    // Load chats
    function loadChats() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading chats...</p>
        </div>
      `;

      fetch(`/api/devices/${deviceId}/chats`, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.code === 'NOT_CONNECTED') {
            showOfflineMessage();
            return;
          }
          
          if (data.code === 'SUCCESS' && data.results && data.results.length > 0) {
            allChats = data.results;
            displayChats(allChats);
          } else {
            chatList.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #667781;">
                <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
                <p>No chats yet</p>
                <p style="font-size: 12px; margin-top: 8px;">Start messaging</p>
              </div>
            `;
          }
        })
        .catch(err => {
          console.error('Error loading chats:', err);
          chatList.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
              <p>Error loading chats</p>
            </div>
          `;
        });
    }

    // Display chats
    function displayChats(chats) {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      
      chats.forEach(chat => {
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        if (currentChat && currentChat.id === chat.id) {
          chatItem.classList.add('active');
        }
        chatItem.onclick = () => selectChat(chat);
        
        const avatar = chat.isGroup ? '👥' : 
          `<svg viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>`;
        
        chatItem.innerHTML = `
          <div class="avatar">${avatar}</div>
          <div class="info">
            <h3>${escapeHtml(chat.name)}</h3>
            <p>${escapeHtml(chat.lastMessage || 'No messages')}</p>
          </div>
          <div class="meta">
            <div class="time">${chat.time || ''}</div>
            ${chat.unread > 0 ? `<div class="unread-count">${chat.unread > 99 ? '99+' : chat.unread}</div>` : ''}
          </div>
        `;
        
        chatList.appendChild(chatItem);
      });
    }

    // Select chat
    function selectChat(chat) {
      currentChat = chat;
      
      // Update active state
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      
      // Update UI based on screen size
      if (window.innerWidth <= 768) {
        document.getElementById('sidebar').style.display = 'none';
        document.getElementById('chatWindow').classList.add('active');
      } else {
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('chatWindow').classList.remove('hidden');
      }
      
      // Update header
      document.getElementById('chatName').textContent = chat.name;
      document.getElementById('chatStatus').textContent = chat.isGroup ? 'tap for group info' : 'tap for contact info';
      
      const avatarContent = chat.isGroup ? '👥' : 
        `<svg viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>`;
      document.getElementById('chatAvatar').innerHTML = avatarContent;
      
      loadMessages(chat.id);
      document.getElementById('messageInput').focus();
    }

    // Show chat list (mobile)
    function showChatList() {
      document.getElementById('sidebar').style.display = 'block';
      document.getElementById('chatWindow').classList.remove('active');
      currentChat = null;
      
      // Update active states
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
    }

    // Load messages
    function loadMessages(chatId) {
      const container = document.getElementById('messages');
      container.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading messages...</p>
        </div>
      `;
      
      fetch(`/api/devices/${deviceId}/messages/${chatId}`, { credentials: 'include' })
        .then(res => res.json())
        .then(data => {
          if (data.code === 'SUCCESS' && data.results && data.results.length > 0) {
            container.innerHTML = '';
            
            data.results.forEach(msg => {
              addMessageToUI(msg);
            });
            
            container.scrollTop = container.scrollHeight;
          } else {
            container.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #667781;">
                <p>No messages yet</p>
                <p style="font-size: 12px; margin-top: 8px;">Send a message to start the conversation</p>
              </div>
            `;
          }
        })
        .catch(err => {
          console.error('Error loading messages:', err);
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
              <p>Error loading messages</p>
            </div>
          `;
        });
    }

    // Add message to UI
    function addMessageToUI(msg) {
      const container = document.getElementById('messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.sent ? 'sent' : 'received'}`;
      
      if (msg.type === 'image' && msg.image) {
        messageDiv.classList.add('image');
        if (msg.text) {
          messageDiv.classList.add('has-caption');
        }
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        let content = `<img src="${msg.image}" onclick="viewImage('${msg.image}')" alt="Image">`;
        if (msg.text) {
          content += `<div class="caption">${escapeHtml(msg.text)}</div>`;
        }
        const ticks = msg.sent ? '<span class="ticks">✓✓</span>' : '';
        content += `<span class="time">${msg.time || formatTime(new Date())}${ticks}</span>`;
        
        bubble.innerHTML = content;
        messageDiv.appendChild(bubble);
      } else {
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        const ticks = msg.sent ? '<span class="ticks">✓✓</span>' : '';
        bubble.innerHTML = `
          <div class="content">${escapeHtml(msg.text)}</div>
          <div class="time">${msg.time || formatTime(new Date())}${ticks}</div>
        `;
        messageDiv.appendChild(bubble);
      }
      
      container.appendChild(messageDiv);
    }

    // Setup message input
    function setupMessageInput() {
      const input = document.getElementById('messageInput');
      
      // Auto-resize textarea
      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
      });
      
      // Send on Enter
      input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Compress image file to 350KB max
    function compressImageFile(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Start with reasonable dimensions
          let width = img.width;
          let height = img.height;
          let quality = 0.9;
          
          // First resize if too large
          const maxSize = 1000;
          if (width > height) {
            if (width > maxSize) {
              height = (height * maxSize) / width;
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = (width * maxSize) / height;
              height = maxSize;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          
          // Compress until under 350KB
          function tryCompress() {
            canvas.toBlob(function(blob) {
              if (blob.size > 350 * 1024 && quality > 0.1) {
                quality -= 0.1;
                tryCompress();
              } else {
                callback(blob);
              }
            }, 'image/jpeg', quality);
          }
          tryCompress();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Send message
    let isSending = false; // Prevent double sending
    function sendMessage() {
      if (isSending) return; // Prevent duplicate sends
      
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      
      if (!message || !currentChat) return;
      
      isSending = true; // Set flag
      input.disabled = true;
      
      // Add message to UI immediately
      const tempMsg = {
        sent: true,
        text: message,
        time: formatTime(new Date())
      };
      addMessageToUI(tempMsg);
      
      const container = document.getElementById('messages');
      container.scrollTop = container.scrollHeight;
      
      input.value = '';
      input.style.height = 'auto';
      
      // Format phone number
      let phone = currentChat.id.split('@')[0];
      if (!phone.startsWith('+')) {
        phone = '+' + phone;
      }
      
      fetch(`/api/devices/${deviceId}/send`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
          chatId: currentChat.id,
          message: message
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.code === 'SUCCESS') {
          showNotification('✓ Message sent', 'success');
          updateChatLastMessage(currentChat.id, message);
        } else {
          showNotification('Failed to send message', 'error');
          // Remove the temporary message
          container.lastElementChild.remove();
          input.value = message;
        }
      })
      .catch(err => {
        console.error('Error sending message:', err);
        showNotification('Failed to send message', 'error');
        container.lastElementChild.remove();
        input.value = message;
      })
      .finally(() => {
        input.disabled = false;
        input.focus();
        isSending = false; // Reset flag
      });
    }

    // Setup search
    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        if (query === '') {
          displayChats(allChats);
        } else {
          const filtered = allChats.filter(chat => 
            chat.name.toLowerCase().includes(query) ||
            (chat.lastMessage && chat.lastMessage.toLowerCase().includes(query))
          );
          displayChats(filtered);
        }
      });
    }

    // Setup image input
    function setupImageInput() {
      const imageInput = document.getElementById('imageUpload');
      imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
          selectedImageFile = file;
          showImagePreview(file);
        } else {
          showNotification('Please select a valid image file', 'error');
        }
      });
    }

    // Select image
    function selectImage() {
      if (!currentChat) {
        showNotification('Please select a chat first', 'error');
        return;
      }
      document.getElementById('imageUpload').click();
    }

    // Show image preview
    function showImagePreview(file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('previewImage').src = e.target.result;
        document.getElementById('imagePreviewModal').classList.remove('hidden');
        document.getElementById('captionInput').focus();
      };
      reader.readAsDataURL(file);
    }

    // Cancel image
    function cancelImage() {
      selectedImageFile = null;
      const imageInput = document.getElementById('imageUpload');
      if (imageInput) imageInput.value = '';
      const captionInput = document.getElementById('captionInput');
      if (captionInput) captionInput.value = '';
      const modal = document.getElementById('imagePreviewModal');
      if (modal) modal.classList.add('hidden');
    }

    // Send image
    let isSendingImage = false; // Prevent double sending
    function sendImage() {
      if (isSendingImage || !selectedImageFile || !currentChat) return;
      
      isSendingImage = true; // Set flag
      
      const caption = document.getElementById('captionInput').value.trim();
      
      const modal = document.getElementById('imagePreviewModal');
      const originalContent = modal.querySelector('.image-preview-content').innerHTML;
      modal.querySelector('.image-preview-content').innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 16px;">Sending image...</p>
        </div>
      `;
      
      // Format phone number
      let phone = currentChat.id.split('@')[0];
      if (!phone.startsWith('+')) {
        phone = '+' + phone;
      }
      
      // Compress image before sending
      compressImageFile(selectedImageFile, function(compressedBlob) {
        // Convert blob to base64
        const reader = new FileReader();
        reader.onloadend = function() {
          const base64data = reader.result;
          
          // Add image to UI immediately for better UX
          const tempMsg = {
            sent: true,
            type: 'image',
            image: base64data,
            text: caption,
            time: formatTime(new Date())
          };
          addMessageToUI(tempMsg);
          
          const container = document.getElementById('messages');
          container.scrollTop = container.scrollHeight;
          
          // Send via API
          fetch(`/api/devices/${deviceId}/send`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
              chatId: currentChat.id,
              message: caption || '',
              imageB64: base64data
            })
          })
          .then(res => res.json())
          .then(data => {
            isSendingImage = false; // Reset flag
            if (data.code === 'SUCCESS') {
              cancelImage();
              showNotification('✓ Image sent', 'success');
              updateChatLastMessage(currentChat.id, '📷 Photo');
            } else {
              modal.querySelector('.image-preview-content').innerHTML = originalContent;
              showNotification(data.message || 'Failed to send image', 'error');
              const container = document.getElementById('messages');
              container.lastElementChild.remove();
            }
          })
          .catch(err => {
            isSendingImage = false; // Reset flag
            console.error('Error sending image:', err);
            modal.querySelector('.image-preview-content').innerHTML = originalContent;
            showNotification('Failed to send image', 'error');
            const container = document.getElementById('messages');
            container.lastElementChild.remove();
          });
        };
        reader.readAsDataURL(compressedBlob);
      });
    }

    // View image
    function viewImage(src) {
      window.open(src, '_blank');
    }

    // Update chat last message
    function updateChatLastMessage(chatId, message) {
      const chat = allChats.find(c => c.id === chatId);
      if (chat) {
        chat.lastMessage = message;
        chat.time = formatTime(new Date());
        displayChats(allChats);
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Format time
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Escape HTML
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // WebSocket for real-time updates
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
      
      ws.onopen = () => {
        console.log('WebSocket connected');
      };
      
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          if (data.code === 'NEW_MESSAGE' && data.result && data.result.deviceId === deviceId) {
            // Reload chats to update last message
            loadChats();
            
            // If current chat is open, reload messages to show the new one
            if (currentChat && currentChat.id === data.result.chatJid) {
              // Just reload messages, don't add manually to avoid duplicates
              loadMessages(currentChat.id);
            }
          }
        } catch (err) {
          console.error('WebSocket error:', err);
        }
      };
      
      ws.onclose = () => {
        console.log('WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 5000);
      };
    }
    
    // Connect WebSocket
    connectWebSocket();
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.innerWidth > 768) {
        document.getElementById('sidebar').style.display = 'block';
        if (!currentChat) {
          document.getElementById('emptyState').style.display = 'flex';
          document.getElementById('chatWindow').style.display = 'none';
        }
      } else {
        if (!currentChat) {
          document.getElementById('sidebar').style.display = 'block';
          document.getElementById('chatWindow').classList.remove('active');
        }
      }
    });

    // Auto-sync
    setInterval(() => {
      if (document.hidden) return;
      
      fetch(`/api/devices/${deviceId}/sync`, {
        method: 'POST',
        credentials: 'include'
      }).catch(() => {});
    }, 30000);

    // Add slideOut animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideOut {
        to {
          transform: translateX(120%);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>